<dom-module id="pratilipi-user-password-update">

	<style>

		paper-input.pratilipi-blue {
			--paper-input-container-focus-color: #107FE5;
		}
		
	</style>

	<template>
		
		<div class="modal fade" id="pratilipiUserPasswordUpdate" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<span>Change Password</span>
						<span style="float: right;"><paper-icon-button style="margin-top: -10px; margin-right: -10px;" noink icon="close" on-click="close"></paper-icon-button></span>
					</div>
					<div class="modal-body" on-keyup="onSubmit">
						<template is="dom-if" if="{{ showCurrentPassword }}">
							<paper-input class="pratilipi-blue" label="Current Password" type="password" value="{{ password::input }}"></paper-input>
						</template>
						<paper-input class="pratilipi-blue" label="New Password" type="password" value="{{ newPassword::input }}"></paper-input>
						<paper-input class="pratilipi-blue" label="Confirm Password" type="password" value="{{ newPassword2::input }}"></paper-input>
						<div class="text-center">
							<span class="text-center">{{ message }}</span>
						</div>
					</div>
					<div class="modal-footer">
						<button id="passwordUpdateButton" class="pratilipi-new-blue-button" on-click="onSubmit">
							Change Password
						</button>
					</div>
				</div>
			</div>
		</div>
		
		<iron-ajax
				id="AjaxPost"
				url="/api/user/passwordupdate"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
				
	</template>

   
	<script>
	
		Polymer({
			
			is: 'pratilipi-user-password-update',
			
			properties: {
				email: { type: String, value: null },
				verificationToken: { type: String, value: null },
				password: { type: String, value: null },
				newPassword: { type: String, value: null },
				newPassword2: { type: String, value: null },
				showCurrentPassword: { type: Boolean, value: true },
				message: { type: String, value: null },
			},
			
			openPasswordUpdate: function( email, token ) {
				this.email = email;
				this.verificationToken = token;
				this.showCurrentPassword = false;
				this.open();
			},
			
			clearMessages: function() {
				this.message = null;
				this.password = null;
				this.newPassword = null;
				this.newPassword2 = null;
				this.email = null;
				this.verificationToken = null;
				this.showCurrentPassword = true;
			},
			
			open: function() {
				this.async( function() {
					jQuery( "#pratilipiUserPasswordUpdate" ).modal();
				});
			},
			
			close: function() {
				this.clearMessages();
				jQuery( "#pratilipiUserPasswordUpdate" ).modal( 'hide' );
			},
			
			onSubmit: function( event ) {
				
				this.message = null;
				
				if( event.keyCode != null && event.keyCode != 0 && event.keyCode != 13 )
					return;
				
				if( this.showCurrentPassword && this.password == null ) {
					this.message = "Please enter your current password!";
					return;
				}
				
				if( this.newPassword == null ) {
					this.message = "Please enter the password!";
					return;
				}
				
				if( this.newPassword2 == null ) {
					this.message = "Please re-enter the password!";
					return;
				}
				
				if( this.newPassword != this.newPassword2 ) {
					this.message = "Passwords doesn't match!";
					return;
				}
				
				this.message = "Working ...";
				jQuery( '#passwordUpdateButton' ).prop( 'disabled', true );
				
				var ajaxBody = "";
				
				if( this.email != null && this.token != null )
					ajaxBody = "email=" + this.email + "&" + "verificationToken=" + this.verificationToken;
				else if( this.password != null )
					ajaxBody = "password=" + this.password;
				
				ajaxBody = ajaxBody + "&" + "newPassword=" + this.newPassword;
				
				this.$.AjaxPost.body = ( ajaxBody );
				this.$.AjaxPost.generateRequest();

			},
			
			_handleAjaxPostResponse: function( event ) {
				if( event.detail.xhr.status == 0 ) {
					this.message = "Could not connect to server !";
				} else {
					this.message= "Password has been changed Successfully!";
					this.async( function() {
						this.clearMessages();
 						this.message = null;
 						jQuery( '#passwordUpdateButton' ).prop( 'disabled', false );
						this.close();
					}, 2000 );
				}
				document.querySelector( 'pratilipi-user' ).updateUser( event.detail.response );
 				window.location = "http://" + window.location.host; 
			},
			
			_handleAjaxPostError: function( event ) {
				if( event.detail.request.xhr.status == 400 ) {
					if( event.detail.request.xhr.response.password != null )
						this.message = event.detail.request.xhr.response.password;
					else if( event.detail.request.xhr.response.token != null )
						this.message = event.detail.request.xhr.response.token;
					else if( event.detail.request.xhr.response.errMessage != null )
						this.message = event.detail.request.xhr.response.errMessage;
					else
						this.message = "Invalid Input";
				} else {
					this.message = event.detail.request.xhr.response.message;
				}
			},
		});
		
	</script>

</dom-module>

<dom-module id="pratilipi-author-details">
	<style>
		:host {
			display: block;
			margin-bottom: 8px;
		}
		.cover-image {
			display: flex;
			justify-content: center;
			width: 100%;
			height: 350px;
			border-radius: 0;
			background-color: #FFF;
			background-repeat: no-repeat;
			background-position: top;
			background-size: cover;
			text-align: center;
		}
		.author-detail-container {
			align-self: center;
			padding: 12px 16px;
		}
		.profile-picture, .pratilipi-file-upload {
			width: 150px;
			height: 150px;
			border: 2px solid #fbfbfb;
			border-radius: 50%;
			overflow: hidden;
			box-shadow: 0 0 8px rgba(0, 0, 0, .8);
			-webkit-box-shadow: 0 0 8px rgba(0, 0, 0, .8);
			-moz-box-shadow: 0 0 8px rgba(0, 0, 0, .8);
		}
		.pratilipi-file-upload .pratilipi-file-upload-caption {
			transition: none;
		}
		.pratilipi-file-upload iron-icon, .pratilipi-file-upload .pratilipi-file-upload-caption iron-icon {
			left: 32px;
			margin: 0;
		}
		.profile-picture, .pratilipi-file-upload paper-spinner {
			width: 146px;
			height: 147px;
			margin: 0;
			--paper-spinner-layer-1-color: #D0021B;
			--paper-spinner-layer-2-color: #107FE5;
			--paper-spinner-layer-3-color: #D0021B;
			--paper-spinner-layer-4-color: #107FE5;
		}
		.author-name {
			margin: 12px auto;
			color: #fbfbfb;
			font-size: 21px;
			font-weight: 700;
			text-shadow: 4px 1px 4px rgba(0,0,0,0.50);
			letter-spacing: 1.13px;
		}
		.follow-author button.pratilipi-light-blue-button {
			display: block;
			margin: 0 auto;
			border-radius: 5px;
			font-weight: 400;
			font-size: 15px;
		}
		.follow-author button.pratilipi-grey-button {
			display: block;
			margin: 0 auto;
			border-radius: 5px;
			font-weight: 400;
			font-size: 15px;
			-webkit-box-shadow: none;
			-moz-box-shadow: none;
			box-shadow: none;
		}
		.follow-author iron-icon {
			width: 20px;
			height: 20px;
			margin-top: -4px;
			margin-right: 3px;
		}
		.edit-profile {
			position: absolute;
			top: 16px;
			right: 64px;
		}
		.edit-profile paper-fab {
			width: 24px;
			height: 24px;
			--paper-fab-background: #F5F5F5;
			--paper-fab-iron-icon: {
				color: #333;
			}
		}
		.share-author {
			position: absolute;
			top: 8px;
			right: 8px;
		}
		.share-author paper-menu-button paper-fab {
			width: 12px;
			height: 12px;
			--paper-fab-background: #F5F5F5;
			--paper-fab-iron-icon: {
				color: #333;
			}
		}
		.share-author paper-menu-button paper-menu {
			padding: 0;
			cursor: pointer;
			--paper-menu-color: #333;
			--paper-menu-focused-item: {
				color: #333;
			};
		}
		.meta-data {
			padding: 12px 16px;
			margin: 4px auto 0 auto;
			text-align: center;
		}
		.meta-data span {
			display: block;
			font-size: 13px;
		}
		.meta-data div.numbers {
			font-size: 20px;
			font-weight: 500;
		}
	</style>
	<template>
		<paper-card class="cover-image pratilipi-shadow" style="background-image: url('http://trendymods.com/wp-content/uploads/2015/10/facebook-cover-photos-ideas-5.jpg')">
		
			<template is="dom-if" if="{{ hasAccessToUpdate }}">
				<div class="edit-profile">
					<paper-fab icon="icons:settings" on-click="editAuthorProfile"></paper-fab>
				</div>
			</template>
			
			<div class="share-author">
				<paper-menu-button horizontal-align="right" vertical-align="top">
					<paper-fab icon="social:share" class="dropdown-trigger"></paper-fab>
					<paper-menu class="dropdown-content">
						<paper-item on-click="shareAuthorOnFacebook"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></paper-item>
						<paper-item on-click="shareAuthorOnTwitter"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></paper-item>
						<paper-item on-click="shareAuthorOnGplus"><i class="fa fa-google-plus fa-lg" aria-hidden="true"></i></paper-item>
					</paper-menu>
				</paper-menu-button>
			</div>
			<div class="author-detail-container">
				<template is="dom-if" if="{{ hasAccessToUpdate }}">
					<div style="position: absolute; top: -1000px;">
						<form id="uploadAuthorImage" method="post" enctype="multipart/form-data" action="/api/author/image?authorId={{ author.authorId }}" target="upload_target">
							<input id="uploadAuthorImageInput" type="file" on-change="uploadImage" name="{{ author.authorId }}" accept="image/*">
						</form>
						<iframe id="upload_target" name="upload_target" style="display: none;" on-load="_onchangeiframe"></iframe>
					</div>
					<div class="pratilipi-file-upload">
						<template is="dom-if" if="{{ !imageUploaded }}">
							<img src="{{ imageUrl }}" alt="{{ author.fullName }}" title="{{ author.fullNameEn }}"/>
						</template>
						<template is="dom-if" if="{{ imageUploaded }}">
							<paper-spinner active></paper-spinner>
						</template>
						<iron-icon icon="icons:cloud-upload"></iron-icon>
						<div class="pratilipi-file-upload-caption" on-click="_chooseFile">
							<iron-icon icon="icons:cloud-upload"></iron-icon>
						</div>
					</div>
				</template>
				<template is="dom-if" if="{{ !hasAccessToUpdate }}">
					<img class="profile-picture" src="{{ imageUrl }}">
				</template>
				<div class="author-name">{{ name }}</div>
				<template is="dom-if" if="{{ hasAccessToFollow }}">
					<div class="follow-author">
						<template is="dom-if" if="{{ !following }}">
							<button class="pratilipi-light-blue-button" on-click="followAuthor">
								<iron-icon icon="social:person-add"></iron-icon>
								${ _strings.author_follow }{{ followCountAbbr }}
							</button>
						</template>
						<template is="dom-if" if="{{ following }}">
							<button class="pratilipi-grey-button" on-click="unFollowAuthor">
								<iron-icon icon="icons:remove-circle"></iron-icon>
								${ _strings.author_unfollow }{{ followCountAbbr }}
							</button>
						</template>
					</div>
				</template>
			</div>
			
		</paper-card>
		<div class="secondary-500 meta-data pratilipi-shadow">
			<div class="row">
				<div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
					<span>${ _strings.author_count_works }</span>
					<div class="numbers">{{ contentPublished }}</div>
				</div>
				<div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
					<span>${ _strings.author_count_reads }</span>
					<div class="numbers">{{ totalReadCount }}</div>
				</div>
				<div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
					<span>${ _strings.author_count_likes }</span>
					<div class="numbers">{{ totalFbLikeShareCount }}</div>
				</div>
			</div>
		</div>
		
		<iron-ajax
				id="UserAuthorFollowPostApi"
				url="/api/userauthor/follow"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_userAuthorFollowPostApiResponse"
				on-error="_userAuthorFollowPostApiError"
				></iron-ajax>
	</template>
	<script>
		function abbrNum( n, d ) {
			if( n < 1000 ) return n;
			d = d != null ? d : 2;
			x = ( '' + n ).length, p = Math.pow, d = p( 10,d );
			x -= x % 3;
			return Math.round( n * d / p ( 10, x ) ) / d + " kMGTPE" [ x / 3 ]; 
		}

		function commaSeparatedNumber(x) {
		    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
		}
	
	Polymer({

		is: 'pratilipi-author-details',
		
		properties: {
			author: { type: Object, observer: "_authorObserver" },
			userAuthor: { type: Object, observer: "_userAuthorObserver" },
			
			followCount: { type: Object, observer: "_followCountObserver" },
			imageUploaded: { type: Boolean, value: false }
		},
		
		attached: function() {
			this._authorObserver(); <#-- Calling first time -->
		},

		_authorObserver: function() {
			if( document.querySelector( 'pratilipi-user' ) == null ) return;
			this.set( 'hasAccessToFollow', this.author.user.userId != document.querySelector( 'pratilipi-user' ).getCurrentUser().userId );
			this.set( 'hasAccessToUpdate', this.author.hasAccessToUpdate );
			this.set( 'name', this.author.name != null ? this.author.name : this.author.nameEn );
			this.set( 'imageUrl', this.author.imageUrl + ( this.author.imageUrl.indexOf( '?' ) == -1 ? "?" : "&" ) + "width=150" );
			this.set( 'followCount', this.author.followCount != null ? this.author.followCount : 0 );
			this.set( 'contentPublished', commaSeparatedNumber( this.author.contentPublished ) );
			this.set( 'totalReadCount', commaSeparatedNumber( this.author.totalReadCount ) );
			this.set( 'totalFbLikeShareCount', commaSeparatedNumber( this.author.totalFbLikeShareCount ) );
		},

		_userAuthorObserver: function( userAuthor ) {
			this.set( 'following', ( userAuthor != null && userAuthor.following != null ) ? userAuthor.following : false )
		},
		
		_followCountObserver: function() {
			this.followCountAbbr = this.followCount > 0 ? ( "  |  " + abbrNum( this.followCount ) ) : null;
		},
		
		_checkUserLoginStatus: function() {
			if( document.querySelector( 'pratilipi-user' ).getCurrentUser().isGuest ) {
				document.querySelector( 'pratilipi-user' ).logIn( true );
				return false;
			}
			return true;
		},
		
		_disableFollowButtons: function() {
			jQuery( this.querySelector( '.follow-author-button .pratilipi-light-blue-button' ) ).prop( 'disabled', true );
			jQuery( this.querySelector( '.follow-author-button .pratilipi-grey-button' ) ).prop( 'disabled', true );
		},

		_enableFollowButtons: function() {
			jQuery( this.querySelector( '.follow-author-button .pratilipi-light-blue-button' ) ).prop( 'disabled', false );
			jQuery( this.querySelector( '.follow-author-button .pratilipi-grey-button' ) ).prop( 'disabled', false );
		},

		_postFollowApi: function( following ) {
			if( ! this._checkUserLoginStatus() )
				return;
			this._swapFollowButton();
			this._disableFollowButtons();
			var body = { authorId: this.author.authorId, following: following };
			this.$.UserAuthorFollowPostApi.body = jQuery.param( body );
			this.$.UserAuthorFollowPostApi.generateRequest();
		},
		
		followAuthor: function() {
			this._postFollowApi( true );
		},
		
		unFollowAuthor: function() {
			this._postFollowApi( false );
		},
		
		_swapFollowButton: function() {
			this.set( 'following', this.following ? false : true );
			this.set( 'followCount', this.following ? this.followCount + 1 : this.followCount - 1 );
		},
		
		_userAuthorFollowPostApiResponse: function( response ) {
			var following = response.detail.response.following;
			this._enableFollowButtons();
			if( this.following != following ) {
				this._userAuthorFollowPostApiError();
			}
		},
		
		_userAuthorFollowPostApiError: function( response ) {
			this._swapFollowButton();
			this._enableFollowButtons();
			if( response != null && response.detail.request.xhr.response.message != null ) {
				document.querySelector( 'pratilipi-alert' ).alert( response.detail.request.xhr.response.message, false );
			} else {
				document.querySelector( 'pratilipi-alert' ).alert( "${ _strings.server_error_message }", false );
				console.log( response );
			}
		},
		
		editAuthorProfile: function() {
			this.domHost.editAuthorProfile();
		},
		
		shareAuthorOnFacebook: function() {
			window.open( "http://www.facebook.com/sharer.php?u=" + "http://${ domain }" + this.author.pageUrl, 
					"share" + "%26" + "utm_source=author_page", "width=1100,height=500,left=70px,top=60px" );
		},
		
		shareAuthorOnTwitter: function() {
			window.open( "http://www.facebook.com/sharer.php?u=" + "http://${ domain }" + this.author.pageUrl,
					"share" + "%26" + "utm_source=author_page", "width=1100,height=500,left=70px,top=60px" );
		},
		
		shareAuthorOnGplus: function() {
			window.open( "http://www.facebook.com/sharer.php?u=" + "http://${ domain }" + this.author.pageUrl,
					"share" + "%26" + "utm_source=author_page", "width=1100,height=500,left=70px,top=60px" );
		},

		_chooseFile: function() {
			document.getElementById( "uploadAuthorImageInput" ).click();
		},
		
		_onchangeiframe: function( response ) {
			if( this.imageUploaded ) {
				this.async( function() { this.imageUploaded = false; }, 500 );
				this.domHost.getAuthor();
			}
		},

		uploadImage: function( event ) {
			if( this.imageUploaded ) return;
			var FileList = event.target.files;
			if( FileList.length != 1 ) return; // No file or more than 1 file is selected.
			var file = FileList[0];
			if( file == null ) return;
			var fileName = file.name.toLowerCase();
			if( ! ( fileName.match( ".*\.jpg" ) || fileName.match( ".*\.png" ) ) ) return; // Only jpg and png
			document.getElementById( "uploadAuthorImage" ).submit();
			this.imageUploaded = true;
		}

	});
	</script>
</dom-module>
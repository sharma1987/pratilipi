
<dom-module id="pratilipi-author-details">
	<style>
		:host {
			display: block;
			margin-bottom: 8px;
		}
		.cover-image {
			display: flex;
			justify-content: center;
			width: 100%;
			height: 350px;
			border-radius: 0;
			background-color: #FFF;
			background-repeat: no-repeat;
			background-position: top;
			background-size: cover;
			text-align: center;
		}
		.author-detail-container {
			align-self: center;
			padding: 12px 16px;
		}
		.profile-picture {
			width: 150px;
			height: 150px;
			padding: 2px;
		}
		.author-name {
			margin: 12px auto;
			color: #FFFFFF;
			font-size: 21px;
			font-weight: 700;
			text-shadow: 4px 1px 4px rgba(0,0,0,0.50);
			letter-spacing: 1.13px;
		}
		.follow-author button.pratilipi-light-blue-button {
			display: block;
			margin: 0 auto;
			border-radius: 5px;
			font-weight: 400;
			font-size: 15px;
		}
		.follow-author button.pratilipi-grey-button {
			display: block;
			margin: 0 auto;
			border-radius: 5px;
			font-weight: 400;
			font-size: 15px;
			-webkit-box-shadow: none;
			-moz-box-shadow: none;
			box-shadow: none;
		}
		.follow-author iron-icon {
			width: 20px;
			height: 20px;
			margin-top: -4px;
			margin-right: 3px;
		}
		.upload-cover {
			position: absolute;
			top: 16px;
			left: 16px;
		}
		.upload-cover paper-fab {
			width: 24px;
			height: 24px;
			--paper-fab-background: #ADADAD;
			--paper-fab-iron-icon: {
				color: #FFF;
				width: 18px;
				height: 18px;
			}
		}
		.share-author {
			position: absolute;
			top: 8px;
			right: 8px;
		}
		.share-author paper-menu-button paper-fab {
			width: 12px;
			height: 12px;
			--paper-fab-background: #F5F5F5;
			--paper-fab-iron-icon: {
				color: #333;
			}
		}
		.share-author paper-menu-button paper-menu {
			padding: 0;
			cursor: pointer;
			--paper-menu-color: #333;
			--paper-menu-focused-item: {
				color: #333;
			};
		}
		.meta-data {
			padding: 12px 16px;
			margin: 4px auto 0 auto;
			text-align: center;
		}
		.meta-data span {
			display: block;
			font-size: 13px;
		}
		.meta-data div.numbers {
			font-size: 21px;
			font-weight: 500;
		}
	</style>
	<template>
		<paper-card class="cover-image pratilipi-shadow" style="background-image: url('http://trendymods.com/wp-content/uploads/2015/10/facebook-cover-photos-ideas-5.jpg')">
		
			<template is="dom-if" if="{{ hasAccessToUpdate }}">
				<div class="upload-cover">
					<paper-fab mini icon="editor:insert-photo"></paper-fab>
				</div>
			</template>
			
			<div class="share-author">
				<paper-menu-button horizontal-align="right" vertical-align="top">
					<paper-fab icon="social:share" class="dropdown-trigger"></paper-fab>
					<paper-menu class="dropdown-content">
						<paper-item on-click="shareAuthorOnFacebook"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></paper-item>
						<paper-item on-click="shareAuthorOnTwitter"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></paper-item>
						<paper-item on-click="shareAuthorOnGplus"><i class="fa fa-google-plus fa-lg" aria-hidden="true"></i></paper-item>
					</paper-menu>
				</paper-menu-button>
			</div>
			<div class="author-detail-container">
				<img class="img-thumbnail img-circle profile-picture" src="{{ imageUrl }}">
				<div class="author-name">{{ name }}</div>
				<template is="dom-if" if="{{ !hasAccessToUpdate }}">
					<div class="follow-author">
						<template is="dom-if" if="{{ !following }}">
							<button class="pratilipi-light-blue-button" on-click="followAuthor">
								<iron-icon icon="social:person-add"></iron-icon>
								Follow{{ followCountAbbr }}
							</button>
						</template>
						<template is="dom-if" if="{{ following }}">
							<button class="pratilipi-grey-button" on-click="unFollowAuthor">
								<iron-icon icon="icons:remove-circle"></iron-icon>
								UnFollow{{ followCountAbbr }}
							</button>
						</template>
					</div>
				</template>
			</div>
			
		</paper-card>
		<div class="secondary-500 meta-data pratilipi-shadow">
			<div class="row">
				<div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
					<span>${ _strings.author_count_works }</span>
					<div class="numbers">{{ contentPublished }}</div>
				</div>
				<div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
					<span>${ _strings.author_count_reads }</span>
					<div class="numbers">{{ totalReadCount }}</div>
				</div>
				<div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
					<span>${ _strings.author_count_likes }</span>
					<div class="numbers">{{ totalFbLikeShareCount }}</div>
				</div>
			</div>
		</div>
		
		<iron-ajax
				id="UserAuthorFollowPostApi"
				url="/api/userauthor/follow"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_userAuthorFollowPostApiResponse"
				on-error="_userAuthorFollowPostApiError"
				></iron-ajax>
				
		<iron-ajax
				id="AuthorGetApi"
				url="/api/author"
				method="GET"
				content-type="application/json"
				handle-as="json"
				on-response="_authorGetApiResponse"
				></iron-ajax>
				
		<iron-ajax
				id="UserAuthorGetApi"
				url="/api/userauthor/follow"
				method="GET"
				content-type="application/json"
				handle-as="json"
				on-response="_userAuthorGetApiResponse"
				></iron-ajax>
	</template>
	<script>
		function abbrNum( n, d ) {
			if( n < 1000 ) return n;
			d = d != null ? d : 2;
			x = ( '' + n ).length, p = Math.pow, d = p( 10,d );
			x -= x % 3;
			return Math.round( n * d / p ( 10, x ) ) / d + " kMGTPE" [ x / 3 ]; 
		}
	
	Polymer({

		is: 'pratilipi-author-details',
		
		properties: {
			user: { type: Object, observer: "_userObserver" },
			authorData: { type: Object },
			userAuthorData: { type: Object },
			author: { type: Object, notify: true },
			userAuthor: { type: Object, notify: true },
			
			followCount: { type: Object, observer: "_followCountObserver" }
		},
		
		_userObserver: function() {
			if( this.author == null || this.userAuthor == null || this.user == null )
				return;

			this.$.AuthorGetApi.params.authorId = this.author.authorId;
			this.$.UserAuthorGetApi.params.authorId = this.author.authorId;
			this.$.AuthorGetApi.generateRequest();
			this.$.UserAuthorGetApi.generateRequest();
		},
		
		_authorGetApiResponse: function( response ) {
			this.updateAuthor( response.detail.response );
		},
		
		_userAuthorGetApiResponse: function( response ) {
			this.updateUserAuthor( response.detail.response );
		},
		
		_checkUserLoginStatus: function() {
			if( this.user.isGuest ) {
				document.querySelector( 'pratilipi-user' ).logIn( true );
				return false;
			}
			return true;
		},
		
		_followCountObserver: function() {
			this.followCountAbbr = this.followCount > 0 ? ( "  |  " + abbrNum( this.followCount ) ) : null;
		},
		
		updateAuthor: function( author ) {
			this.set( 'author', author );
			this.set( 'hasAccessToUpdate', author.hasAccessToUpdate );
			this.set( 'name', author.name != null ? author.name : author.nameEn );
			this.set( 'imageUrl', author.imageUrl + ( author.imageUrl.indexOf( '?' ) == -1 ? "?" : "&" ) + "width=150" );
			this.set( 'followCount', author.followCount != null ? author.followCount : 0 );
			this.set( 'contentPublished', abbrNum( author.contentPublished ) );
			this.set( 'totalReadCount', abbrNum( author.totalReadCount ) );
			this.set( 'totalFbLikeShareCount', abbrNum( author.totalFbLikeShareCount ) );
		},

		updateUserAuthor: function( userAuthor ) {
			this.set( 'userAuthor', userAuthor );
			this.set( 'following', userAuthor.following )
		},
		
		attached: function() {
			this.updateAuthor( this.authorData );
			this.updateUserAuthor( this.userAuthorData );
		},
		
		shareAuthorOnFacebook: function() {
			window.open( "http://www.facebook.com/sharer.php?u=" + "http://${ domain }" + this.author.pageUrl, 
					"share", "width=1100,height=500,left=70px,top=60px" );
		},
		
		shareAuthorOnTwitter: function() {
			window.open( "http://www.facebook.com/sharer.php?u=" + "http://${ domain }" + this.author.pageUrl,
					"share", "width=1100,height=500,left=70px,top=60px" );
		},
		
		shareAuthorOnGplus: function() {
			window.open( "http://www.facebook.com/sharer.php?u=" + "http://${ domain }" + this.author.pageUrl,
					"share", "width=1100,height=500,left=70px,top=60px" );
		},
		
		followAuthor: function() {
			if( ! this._checkUserLoginStatus() )
				return;
			var body = { authorId: this.author.authorId, following: true };
			this.$.UserAuthorFollowPostApi.body = jQuery.param( body );
			this.$.UserAuthorFollowPostApi.generateRequest();
		},
		
		unFollowAuthor: function() {
			if( ! this._checkUserLoginStatus() )
				return;
			var body = { authorId: this.author.authorId, following: false };
			this.$.UserAuthorFollowPostApi.body = jQuery.param( body );
			this.$.UserAuthorFollowPostApi.generateRequest();
		},
		
		_userAuthorFollowPostApiResponse: function( response ) {
			this.set( 'following', this.following ? false : true );
			this.set( 'followCount', this.following ? this.followCount + 1 : this.followCount - 1 );
		},
		
		_userAuthorFollowPostApiError: function( response ) {
			if( response.detail.request.xhr.response.message != null ) {
				document.querySelector( 'pratilipi-alert' ).alert( response.detail.request.xhr.response.message, false );
			} else {
				document.querySelector( 'pratilipi-alert' ).alert( "Some error Occured! Please try again", false );
				console.log( response );
			}
		}
		
	});
	</script>
</dom-module>
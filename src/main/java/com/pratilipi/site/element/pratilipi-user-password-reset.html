<dom-module id="pratilipi-user-password-reset">

	<template>
		<div class="popup">
		
			<h5 class="popup-heading">${ _strings.forgot_password }</h5>
			
			<div class="popup-body">
				<div class="text-center text-muted">
					${ _strings.reset_password_help }
				</div>
				<hr/>
				<div class="form-group" on-keyup="onSubmit">
					<label for="FormInput-UserEmail">${ _strings.email }</label>
					<input type="email" class="form-control" id="FormInput-UserEmail" placeholder="name@example.com" value="{{ email::input }}">
				</div>
				<div class="text-center">
					<span class="text-center text-success">{{ message }}</span>
					<span class="text-center text-danger">{{ errMessage }}</span>
					<br/>
					<br/>
					<button type="button" class="btn" on-click="onSubmit">${ _strings.reset_password }</button>
				</div>
				<br/>
				<br/>
				<br/>
				<div class="small">
					<a class="text-muted" href="#" on-click="logIn">Back</a>
				</div>
			</div>

		</div>
				
		<iron-ajax
            id="AjaxPost"
            url="/api/user/email"
            method="POST"
			content-type="application/json"
			handle-as="json"
            on-response="_handleAjaxPostResponse"
            on-error="_handleAjaxPostError"
            ></iron-ajax>
				
	</template>

   
	<script>
		Polymer({

			is: 'pratilipi-user-password-reset',

			behaviors: [
				Polymer.IronOverlayBehavior
			],
			
			properties: {
				email: { type: String, value:"" },
				message: { type: String },
				errMessage: { type: String },
			},
			
			logIn: function() {
				document.querySelector( 'pratilipi-user' ).logIn();
			},
			
			clearMessages: function() {
				this.errMessage = null;
				this.message = null;
			},
			
			onSubmit: function( event ) {
				this.clearMessages();
				
				if( event.keyCode != null && event.keyCode != 0 && event.keyCode != 13 )
					return;
				
				this.message = "Working ...";
				
				var ajaxPost = this.$.AjaxPost;
				ajaxPost.params = { email: this.email, sendPasswordResetMail: true };
				ajaxPost.generateRequest();
			},
			
			_handleAjaxPostResponse: function( event ) {
				this.clearMessages();
				if( event.detail.xhr.status == 0 ) {
					this.errMessage = "Could not connect to server !";
				} else {
					this.message= "A mail has been sent to your email Id! Check your inbox! ";
					this.async( function() {
 						this.message = null;				
						this.close();
					}, 2000 );
				}
			},
			
			_handleAjaxPostError: function( event ) {
				this.clearMessages();
				if( event.detail.request.xhr.response.email != null )
					this.errMessage = event.detail.request.xhr.response.email;
				else
					this.errMessage = event.detail.request.xhr.response.message;
			},
		});
		
	</script>

</dom-module>
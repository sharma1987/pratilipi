<dom-module id="pratilipi-author-mail">

	<style>
		
		:host {
			display: block;
		}
		
		.modal-fullscreen .modal-dialog .modal-content {max-width: 768px;padding-top:5px;}
		
	</style>

	<template>
		<div class="modal modal-fullscreen fade" id="pratilipiAuthorMail" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-fullscreen-close-button">
						<paper-icon-button noink icon="close" data-dismiss="modal"></paper-icon-button>
					</div>
					<img title="${ _strings.pratilipi }" alt="${ _strings.pratilipi }" src="http://0.ptlp.co/resource-${ lang }/logo/pratilipi_logo.png" />
					<h6 class="modal-fullscreen-heading">Send Mail To {{ authorName }}</h6>
					<div style="height: 2px; background-color: #FFF; text-align: center; margin-top: 20px; margin-bottom: 20px;"></div>
					<script language="javascript" type="text/javascript">tinymce.init({ selector:'#authorMail', editor_selector : "authorMail", height: "300", content_css : "https://storage.googleapis.com/devo-pratilipi.appspot.com/custom.css", language: '${ _strings.tinymce_language }', menubar: false, toolbar: 'styleselect | bold italic underline | link image', });</script>
					<paper-textarea class="pratilipi-blue" id="authorMail" value="{{ body::input }}"></paper-textarea>
					<div class="display-message-div"><p>{{ message }}</p></div>
					<button id="pratilipiAuthorMailButton" style="margin: 0 auto; display: block;" class="pratilipi-dark-blue-button" type="button" on-click="onSubmit">Send Mail</button>					
				</div>
			</div>
		</div>
		
		<iron-ajax
				id="AjaxPost"
				url="/api/user/email"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
	</template>
	
	<script>
		Polymer({

			is: 'pratilipi-author-mail',

			properties: {
				authorName: { type: String },
				authorId: { type: String },
				body: { type: String },
				message: { type: String }
			},
			
			ready: function() {
				console.log( "Attached" );
			},
			
			sendAuthorMail: function( author ) {
				if( author.authorId == null )
					alert( "Sorry, can't send mail to the author!" );
				
				this.authorName = author.name == null ? "Author" : author.name;
				this.authorId = author.authorId;
				this.body = "";
				if( tinyMCE != null && tinyMCE.activeEditor != null )
					this.body = tinyMCE.get( 'authorMail' ).setContent( this.body );
				this.open();
			},
			
			clearAndClose: function() {
				this.authorName = null;
				this.authorId = null;
				this.body = null;
				this.message = null;
				if( tinyMCE != null && tinyMCE.activeEditor != null )
					this.body = tinyMCE.get( 'authorMail' ).setContent( this.body );
				this.close();
			},
			
			open: function() {
				this.async( function() {
					jQuery( "#pratilipiAuthorMail" ).modal();
				});
			},
			
			close: function() {
				jQuery( "#pratilipiAuthorMail" ).modal( 'hide' );	
			},
			
			onSubmit: function( event ) {
				
				jQuery( '#pratilipiAuthorMailButton' ).prop( 'disabled', true );
				
				if( tinyMCE != null && tinyMCE.activeEditor != null )
					this.body = tinyMCE.get( 'authorMail' ).getContent();
				
				this.body = JSON.stringify( this.body );
				this.body = this.body.substring( 1, this.body.length - 1 );
				
				this.message = "${ _strings.working }";
				
				var ajaxBody = "authorId=" + this.authorId + "&"
							 + "message=" + this.body 
							 + "&" + "sendAuthorMail=true";
				
				this.$.AjaxPost.body = ajaxBody;
				this.$.AjaxPost.generateRequest();
			},
			
			_handleAjaxPostResponse: function( event ) {
				jQuery( '#pratilipiAuthorMailButton' ).prop( 'disabled', false );
				if( event.detail.request.xhr.status != 200 ) {
					this._handleAjaxPostError();
					return;
				}
				
				this.message = "Mail Sent successfully!";
				this.async( function() {
					this.clearAndClose();
				}, 1000 );
			},
			
			_handleAjaxPostError: function( event ) {
				jQuery( '#pratilipiAuthorMailButton' ).prop( 'disabled', false );
				this.message = "Failed to send Mail. Try once again!";
			}
			
		});
	</script>

</dom-module>
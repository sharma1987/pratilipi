<dom-module id="pratilipi-facebook-login">

	<style>
		
		:host {
			display: block;
		}
		
		div.social-wrap button {
			padding-left: 20px;
			padding-right: 0px;
			margin-left: auto;
			margin-right: auto;
			height: 35px;
			background: none;
			border: none;
			display: block;
			background-size: 25px 25px, cover;
			background-position: 10px center, center center;
			background-repeat: no-repeat, repeat;
			border-radius: 4px;
			color: white;
			font-size: 14px;
			margin-bottom: 15px;
			width: 275px;
			border-bottom: 2px solid transparent;
			border-left: 1px solid transparent;
			border-right: 1px solid transparent;
			box-shadow: 0 4px 2px -2px gray;
			text-shadow: rgba(0, 0, 0, .4) -1px -1px 0;
		}

		div.social-wrap > .facebook {
			background-color: #3b5998;
			background: url('http://0.ptlp.co/resource-all/icon/facebook-login/facebook_transparent_icon_25x25.png') no-repeat 10px #3b5998;
			background: url(http://0.ptlp.co/resource-all/icon/facebook-login/facebook_transparent_icon_25x25.png), -webkit-gradient(linear, left top, left bottom, color-stop(0%, #4c74c4), color-stop(100%, #3b5998));
			background-size: 25px 25px, cover;
			background-position: 10px center, center center;
			background-repeat: no-repeat, repeat;
			outline: none;
		}
		
	</style>

	<template>
		<div class="social-wrap">
			<button on-click="fb_login" class="facebook">${ _strings.user_sign_in_with_facebook }</button>
		</div>
		
		<iron-ajax
					id="AjaxPost"
					url="/api/user/login/facebook"
					method="POST"
					content-type="application/x-www-form-urlencoded"
					handle-as="json"
					on-response="_handleAjaxPostResponse"
					on-error="_handleAjaxPostError"
					></iron-ajax>
	</template>

	<script>
		Polymer ({
			
			is: 'pratilipi-facebook-login',
			
			properties: {
				requestOnFlight: { type: Boolean, value: false }
			},
			
			sendData: function( authResponse ) {
				if( this.requestOnFlight )
					return;
				if( authResponse != null ) {
					this.requestOnFlight = true; 
					this.$.AjaxPost.body = ( "fbUserAccessToken=" + authResponse.accessToken );
					this.$.AjaxPost.generateRequest();
				}
			},
			
			fb_login: function() {
				
				FB.init({
					appId: ${ fbAppId },
					cookie : true,
					xfbml: true,
					version: 'v2.6'
				});
				
				FB.login( function( response ) {
					document.querySelector( 'pratilipi-facebook-login' ).sendData( response.authResponse );
				}, { scope: 'public_profile,email,user_birthday' } );
				
			},
			
			ready: function() {
				if( typeof(FB) == 'undefined' ) {
					(function(d, s, id) {
						var js, fjs = d.getElementsByTagName(s)[0];
						if (d.getElementById(id)) return;
						js = d.createElement(s); js.id = id;
						js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.0";
						fjs.parentNode.insertBefore(js, fjs);
					}(document, 'script', 'facebook-jssdk'));
				}
			},
			
			_handleAjaxPostResponse: function( event ) {
				this.requestOnFlight = false;
				document.querySelector( 'pratilipi-user' ).updateUser( event.detail.response );
				document.querySelector( 'pratilipi-user' ).closeAllElements();
			},
			
			_handleAjaxPostError: function( event ) {
				this.requestOnFlight = false;
				alert( event.detail.request.xhr.response.message );
			}, 
		});
	</script>
</dom-module>
<dom-module id="pratilipi-edit-author">
	
	<style>
	
		:host {
			display: block;
		}
		
		.popup-heading span {
			font-size: 14px;
			color: #333;
			display: inline-block;
		}
		
		paper-input.edit, paper-textarea.edit {
			--paper-input-container-focus-color: #107FE5;
			display: block;
			--paper-input-container-label: {
				font-size: 15px;
				font-family: Helvetica,'Noto Sans Tamil', sans-serif;
			};
		}
		
		paper-dropdown-menu {
			--paper-dropdown-menu-focus-color: #107FE5;
			width: 100%;
			--paper-dropdown-menu-ripple: {
				left: auto;
				right: auto;
			};
		}
		
		paper-menu {
			--paper-menu-color: #333;
			--paper-menu-focused-item: {
				color: #107FE5;
			};
		}
	</style>
	
	<template>
		<div class="modal fade" id="pratilipiEditAuthor" role="dialog">
			<div class="modal-dialog modal-lg" role="document">
				<div class="modal-content">
			
					<div class="modal-header">
						<h6 style="margin: 0px; padding: 0px; font-weight: 700;">${ _strings.edit_author_heading }</h6>
						<span style="float: right; margin-top: -25px; margin-right: -10px;"><paper-icon-button noink icon="close" data-dismiss="modal"></paper-icon-button></span>
					</div>
					
					<div class="modal-body">
						<div class="row">
							<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
								<paper-input class="edit" label="${ _strings.edit_author_first_name }" value="{{ params.firstName::input }}"></paper-input>
							</div>
							<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
								<paper-input class="edit" label="${ _strings.edit_author_last_name }" value="{{ params.lastName::input }}"></paper-input>
							</div>
						</div>
						<div class="row">
							<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
								<paper-input class="edit" label="${ _strings.edit_author_first_name_en }" value="{{ params.firstNameEn::input }}"></paper-input>
							</div>
							<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
								<paper-input class="edit" label="${ _strings.edit_author_last_name_en }" value="{{ params.lastNameEn::input }}"></paper-input>
							</div>
						</div>
						<div class="row">
							<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
								<paper-input class="edit" label="${ _strings.edit_author_pen_name }" value="{{ params.penName::input }}"></paper-input>
							</div>
							<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
								<paper-input class="edit" label="${ _strings.edit_author_pen_name_en }" value="{{ params.penNameEn::input }}"></paper-input>
							</div>
						</div>
						
						<div class="row">
							<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
								<paper-input class="edit" type="date" label="${ _strings.edit_author_birthday_ddmmyyyy }" always-float-label value="{{ params.birthday::input }}"></paper-input>
							</div>
							<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
								<paper-dropdown-menu id="authorLanguage" noink label="${ _strings.edit_author_language }">
									<paper-menu noink selected="[[ selected ]]" class="dropdown-content" style="white-space: nowrap; width: auto;">
										<paper-item>Bengali</paper-item>
										<paper-item>Gujarati</paper-item>
										<paper-item>Hindi</paper-item>
										<paper-item>Malayalam</paper-item>
										<paper-item>Marathi</paper-item>
										<paper-item>Tamil</paper-item>
									</paper-menu>
								</paper-dropdown-menu>
							</div>
						</div>
						<div style="margin-top: 15px; margin-bottom: 5px;">
							<span>${ _strings.edit_author_summary }</span>
						</div>
						<script language="javascript" type="text/javascript">tinymce.init({ selector:'#authorSummary', editor_selector : "authorSummary", content_css : "https://storage.googleapis.com/devo-pratilipi.appspot.com/custom.css", language: 'ta', menubar: false, toolbar: 'styleselect | bold italic underline | link image', });</script>
						<paper-textarea class="edit" id="authorSummary" value="{{ summary::input }}"></paper-textarea>
						<div class="text-center" style="min-height: 20px;">
							<span>{{ message }}</span>
						</div>
					</div>
					
					<div class="modal-footer">
						<button id="authorEditButton" class="pratilipi-dark-blue-button" type="button" on-click="onSubmit">${ _strings.edit_author_save_changes }</button>
					</div>
				</div>
			</div>
		</div>
		<iron-ajax
				id="AjaxPost"
				url="/api/author"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
	</template>
	
	<script>
		Polymer({
	
			is: 'pratilipi-edit-author',
			
			properties: {
				author: { type: Object, notify: true },
				params: { type: Object, value: {} },
				
				summary: { type: String }
			},
			
			processBirthday: function( input ) {
				var datePart = input.match(/\d+/g);
				
				if( parseInt( datePart[0] ) < 1800 )
					return input;
					
				var year = datePart[0],
				month = datePart[1],
				day = datePart[2];

				return day+'-'+month+'-'+year;
				
			},
			
			ready: function() {
				if( this.author == null )
					return;
				
				this.set( 'params', this.author );
				
				this.summary = this.params.summary == null ? "" : this.params.summary;
				
				if( this.params.language.toUpperCase() === "BENGALI" )
					this.selected = 0;
				else if( this.params.language.toUpperCase() === "GUJARATI" )
					this.selected = 1;
				else if( this.params.language.toUpperCase() === "HINDI" )
					this.selected = 2;
				else if( this.params.language.toUpperCase() === "MALAYALAM" )
					this.selected = 3;
				else if( this.params.language.toUpperCase() === "MARATHI" )
					this.selected = 4;
				else if( this.params.language.toUpperCase() === "TAMIL" )
					this.selected = 5;
			},
			
			open: function() {
				this.async( function() {
					jQuery( "#pratilipiEditAuthor" ).modal();
				});
			},
			
			close: function() {
				jQuery( "#pratilipiEditAuthor" ).modal( 'hide' );
			},
			
			onSubmit: function() {
				
				if( tinyMCE.activeEditor != null )
					this.params.summary = tinyMCE.get( 'authorSummary' ).getContent();
				else
					this.params.summary = this.summary;
				
				if( this.params.birthday != null )
					this.params.birthday = this.processBirthday( this.params.birthday );
				
				this.params.language = this.$.authorLanguage.selectedItemLabel.toUpperCase();

				this.message = "Please Wait...";
				jQuery( '#authorEditButton' ).prop( 'disabled', true );				
				
				this.$.AjaxPost.body = ( jQuery.param( this.params ) );

				this.$.AjaxPost.generateRequest();
				
			},
			
			_handleAjaxPostResponse: function( event ) {
				
				this.message = "${ _strings.updated_author_info_success }";
				
				var author = event.detail.response;
				this.set( 'author', author );
				this.set( 'params', author );
				document.querySelector( 'pratilipi-author' ).updateAuthor( author );
				
				this.async( function() {
					jQuery( '#authorEditButton' ).prop( 'disabled', false );
					this.message = null;
					this.close();
				}, 1000 );
			},
			
			_handleAjaxPostError: function( event ) {
				jQuery( '#authorEditButton' ).prop( 'disabled', false );
				if( event.detail.request.xhr.status === 400 || event.detail.request.xhr.status === 401 || event.detail.request.xhr.status === 500 )
					this.message = event.detail.request.xhr.response.message;
				else
					this.message = "Some Error occured! Please try Again."
			}
			
		});
	</script>
	
</dom-module>
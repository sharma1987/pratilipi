<dom-module id="pratilipi-follow-author">
	<style>
		:host {
			display: block;
		}
		.follow-author {
			padding: 14px 12px;
			display: flex;
		}
		.follow-author .follow-author-image {
			float: left;
			text-align: center;
			align-self: center;
			margin-right: 16px;
		}
		.follow-author .follow-author-name {
			float: left;
			width: 70%;
			text-align: left;
			align-self: center;
			font-size: 15px;
		}
		.follow-author .follow-author-name a, .follow-author .follow-author-name a:hover, .follow-author .follow-author-name a:focus {
			color: #333;
			display: inline-block;
		}
		.follow-author .follow-author-button {
			margin-left: 8px;
			float: right;
			white-space: nowrap;
			text-align: center;
			align-self: center;
		}
		.follow-author .follow-author-button .pratilipi-light-blue-button {
			margin: 0;
			border-radius: 4px;
			font-weight: 400;
			font-size: 15px;
		}
		.follow-author .follow-author-button .pratilipi-grey-button {
			border-radius: 4px;
			font-weight: 400;
			font-size: 13px;
			-webkit-box-shadow: none;
			-moz-box-shadow: none;
			box-shadow: none;
			margin: 0;
		}
		.follow-author .yourself {
			margin-left: 8px;
			float: right;
			text-align: right;
			align-self: center;
			font-size: 14px;
			color: #1c9963;
			font-weight: 600;
		}
	</style>
	<template>
		<div class="follow-author">
			<div class="follow-author-image">
				<a href="{{ pageUrl }}"><img src="{{ imageUrl }}" class="img-circle" /></a>
			</div>
			<div class="follow-author-name contain-title ellipsed">
				<a href="{{ pageUrl }}">{{ name }}</a>
			</div>
			<template is="dom-if" if="{{ canFollow }}">
				<div class="follow-author-button pull-right">
					<template is="dom-if" if="{{ !following }}">
						<button class="pratilipi-light-blue-button" on-click="followAuthor">${ _strings.author_follow }{{ followCountString }}</button>
					</template>
					<template is="dom-if" if="{{ following }}">
						<button class="pratilipi-grey-button" on-click="unFollowAuthor">${ _strings.author_unfollow }{{ followCountString }}</button>
					</template>
				</div>
			</template>
			<template is="dom-if" if="{{ !canFollow }}">
				<div class="yourself pull-right">${ _strings.author_cannot_follow_yourself }</div>
			</template>
		</div>
		<iron-ajax
			id="UserAuthorFollowApi"
			url="/api/userauthor/follow"
			method="POST"
			content-type="application/x-www-form-urlencoded"
			handle-as="json"
			on-response="_userAuthorFollowApiResponse"
			on-error="_userAuthorFollowApiError"
		></iron-ajax>
	</template>

	<script>

		Polymer({

			is: 'pratilipi-follow-author',
			
			properties: {
				followObject: { type: Object, observer: "_followObjectObserver" },

				authorId: { type: String },
				name: { type: String },
				pageUrl: { type: String },
				followCount: { type: Number, observer: "_followCountObserver" },
				imageUrl: { type: String },
				following: { type: Boolean },
				canFollow: { type: Boolean }
			},
			
			_followCountObserver: function() {
				this.set( 'followCountString', this.followCount > 0 ? ( " | " + this.followCount ) : "" );
			},
			
			_followObjectObserver: function() {
				this.set( 'authorId', this.followObject.authorId );
				this.set( 'name', this.followObject.name );
				this.set( 'pageUrl', this.followObject.pageUrl );
				this.set( 'followCount', this.followObject.followCount );
				this.set( 'imageUrl', this.followObject.imageUrl + ( this.followObject.imageUrl.indexOf( "?" ) == -1 ? "?" : "&" ) + "width=48" );
				this.set( 'following', this.followObject.following );
				this.set( 'canFollow', this.followObject.canFollow );
			},
			
			_makeFollowApiCall: function( following ) {
				if( document.querySelector( 'pratilipi-user' ).getCurrentUser().isGuest ) {
					document.querySelector( 'pratilipi-user' ).logIn( true );
					return;
				}
				this._swapFollowingState();
				this._disableFollowButtons();
				var body = { authorId: this.authorId, following: following };
				this.$.UserAuthorFollowApi.body = jQuery.param( body );
				this.$.UserAuthorFollowApi.generateRequest();
			},
			
			followAuthor: function() {
				this._makeFollowApiCall( true );
			},
			
			unFollowAuthor: function() {
				this._makeFollowApiCall( false );
			},

			_userAuthorFollowApiResponse: function( event ) {
				if( event.detail.response.following != this.following ) {
					this._swapFollowingState();
				}
				this._enableFollowButtons();
			},

			_userAuthorFollowApiError: function( event ) {
				this._swapFollowingState();
				this._enableFollowButtons();
				if( event != null && event.detail.request.xhr.response.message != null ) {
					document.querySelector( 'pratilipi-alert' ).alert( event.detail.request.xhr.response.message, false );
				} else {
					document.querySelector( 'pratilipi-alert' ).alert( "${ _strings.server_error_message }", false );
					console.log( event );
				}
			},

			_disableFollowButtons: function() {
				jQuery( this.querySelector( '.follow-author-button .pratilipi-light-blue-button' ) ).prop( 'disabled', true );
				jQuery( this.querySelector( '.follow-author-button .pratilipi-grey-button' ) ).prop( 'disabled', true );
			},

			_enableFollowButtons: function() {
				jQuery( this.querySelector( '.follow-author-button .pratilipi-light-blue-button' ) ).prop( 'disabled', false );
				jQuery( this.querySelector( '.follow-author-button .pratilipi-grey-button' ) ).prop( 'disabled', false );
			},

			_swapFollowingState: function() {
				this.set( 'following', !this.following );
				this.set( 'followCount', ( this.following ? ( this.followCount + 1 ) : ( this.followCount - 1 ) ) );
			}

		});

	</script>

</dom-module>
<dom-module id="pratilipi-review">

	<style>
		
		:host {
			display: block;
		}
		
		paper-card#reviewcard {
			width: 100%;
			margin-bottom: 5px;
			padding: 20px;
		}
		
		.user-name {
			color: #333; 
			text-transform: capitalize; 
			display: inline-block; 
			margin: 0px;
			font-size: 15px;
		}
		
		.user-dp {
			width: 64px; 
			height: 64px; 
			float: left; 
		}

		.reviewText {
			text-align: justify; 
			white-space:pre-wrap; 
			font-size: 15px;
			margin: 16px 0px 16px 8px;
		}
		
		a.reply-text {
			margin-right: 16px;
			font-size: 15px;
		}
		
		a.expand-comments {
			font-size: 13px;
		}
		
		a.expand-comments iron-icon {
			margin-left: -4px;
			width: 16px;
		}
		
		.reply-section {
			margin-bottom: 16px;
		}
		
		paper-menu-button {
			padding: 0px;
		}
		
		paper-menu {
			cursor: pointer;
			--paper-menu-color: #333;
			--paper-menu-focused-item: {
				color: #107FE5;
			};
		}
		
		paper-item {
			cursor: pointer;
			font-family: inherit;
			font-size: 13px;
		}

	</style>

	
	<template>
		<paper-card id="reviewcard">
			<template is="dom-if" if="{{ hasAccessToUpdate }}">
				<div class="dropdown">
					<paper-icon-button style="color: #333;" class="dropdown-trigger pull-right" icon="icons:more-horiz" noink type="button" data-toggle="dropdown"></paper-icon-button>
					<ul style="margin-top: 0; margin-right: -12px;" class="dropdown-menu pull-right">
						<li>
							<a style="padding: 0; margin: 0;" on-click="showReviewInput">
								<paper-item>
									<paper-icon-item><iron-icon style="margin-right: 4px; width: 22px;" icon="editor:mode-edit"></iron-icon></paper-icon-item>
									<paper-item-body>${ _strings.review_edit_review }</paper-item-body>
								</paper-item>
							</a>
						</li>
						<li>
							<a style="padding: 0; margin: 0;" on-click="openDeleteReview">
								<paper-item>
									<paper-icon-item><iron-icon style="margin-right: 4px; width: 22px;" icon="icons:description"></iron-icon></paper-icon-item>
									<paper-item-body>${ _strings.review_delete_review }</paper-item-body>
								</paper-item>
							</a>
						</li>
					</ul>
				</div>
			</template>
			<div>
   				<a href="{{ review.userProfilePageUrl }}">
   					<img class="img-circle user-dp pratilipi-shadow" src="{{ reviewUserImageUrl }}" alt="{{ user.userName }}" title="{{ user.userName }}"/>
   				</a>
   				<div style="display: inline-block; margin-left: 16px;">
   					<a class="user-name" href="{{ review.userProfilePageUrl }}">{{ review.userName }}</a>
	   				<pratilipi-rating value="{{ review.rating }}" />
	   				<span style="display: block;">{{ reviewDateMillis }}</span>
   				</div>
			</div>
			<div class="reviewText">{{ reviewText }}</div>
			<div class="reply-section">
				<a class="reply-text pratilipi-red" on-click="writeComment">
					${ _strings.comment_reply_to_comment }
				</a>
				<br/>
				<template is="dom-if" if="{{ showCommentCount }}">
					<a class="expand-comments pratilipi-red" on-click="showOrHideComments">
						<iron-icon icon="icons:unfold-more"></iron-icon>
						{{ commentNumberText }}
					</a>
				</template>
			</div>
			
			<pratilipi-comment-list
				id="comment-{{ review.userPratilipiId }}"
				comment-count="{{ commentCount }}"
				user="{{ user }}"
				parent-id="{{ review.userPratilipiId }}"
				parent-type="REVIEW"></pratilipi-comment-list>
		</paper-card>
	</template>
	

	<script>
	
		Polymer({

			is: 'pratilipi-review',
			
			properties: {
				user: { type: Object },
				review: { type: Object, observer: "ready" },
				
				hasAccessToUpdate: { type: Boolean, value: false },
				commentCount: { type: Number, value: 0, observer: "_commentCountObserver" },
				showCommentCount: { type: Boolean, value: false }
			},
			
			ready: function() {
				
				if( ( this.review.reviewTitle == null || this.review.reviewTitle.trim() == "" )
						&& ( this.review.review == null || this.review.review.trim() == "" ) ) {
					this.$.reviewcard.style.display =  'none';
					return;
				}
				
				var reviewText = "";
				
				if( this.review.reviewTitle != null && this.review.reviewTitle.trim() != "" )
					reviewText = this.review.reviewTitle + "\n\n";
					
				if( this.review.review != null && this.review.review.trim() != "" )
					reviewText = reviewText + this.review.review;
					
				this.set( 'reviewText', reviewText );

				if( this.review.userImageUrl ) {
					if( this.review.userImageUrl.indexOf( '?' ) == -1 )
						this.reviewUserImageUrl = this.review.userImageUrl + "?" + "width=64";
					else
						this.reviewUserImageUrl = this.review.userImageUrl + "&" + "width=64";
				}
				
				if( this.review.reviewDateMillis )
					this.reviewDateMillis = convertDate( this.review.reviewDateMillis );
				
				this.commentCount = this.review.commentCount;
			},
			
			_commentCountObserver: function() {
				this.showCommentCount = this.commentCount != null && this.commentCount > 0 ? true : false;
				this.commentNumberText = this.commentCount + " " + 
										this.commentCount != null && this.commentCount > 1 ? 
										"${ _strings.comment_number_of_comments_plural }" : "${ _strings.comment_number_of_comments_singular }";  
			},
			
			writeComment: function() {
				this.querySelector( 'pratilipi-comment-list#comment-' + this.review.userPratilipiId ).writeComment();
			},
			
			showOrHideComments: function() {
				this.querySelector( 'pratilipi-comment-list#comment-' + this.review.userPratilipiId ).showOrHideComments();
			},
			
			
			showReviewInput: function() {
				this.domHost.showReviewInput();
			},
			
			openDeleteReview: function() {
				this.domHost.openDeleteReview();
			}

		});
		
	</script>

</dom-module>

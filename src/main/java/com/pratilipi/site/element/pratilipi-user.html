<link rel="import" href="pratilipi-facebook-login.html" />
<link rel="import" href="pratilipi-user-login.html" />
<link rel="import" href="pratilipi-user-register.html" />
<link rel="import" href="pratilipi-user-password-reset.html" />

<dom-module id="pratilipi-user">

	<template>
		<pratilipi-user-login with-backdrop></pratilipi-user-login>
		<pratilipi-user-register with-backdrop></pratilipi-user-register>
		<pratilipi-user-password-reset with-backdrop></pratilipi-user-password-reset>

		<iron-ajax
				id="AjaxGet"
				url="/api/user/logout"
				method="GET"
				content-type="application/json"
				handle-as="json"
				on-response="_handleAjaxGetResponse"
				on-error="_handleAjaxGetError"
				></iron-ajax>
	</template>
	
	<script>
	
		Polymer({
			
	 		is: 'pratilipi-user',

	 		properties: {
				user: { type: Object, notify: true },
				userData: { type: Object }
			},
			
			updateUser: function( user ) {
				this.set( 'user', user );
			},

			logIn: function() {
				this.querySelector( 'pratilipi-user-register' ).close();
				this.querySelector( 'pratilipi-user-password-reset' ).close();
				this.async( function() {
					this.querySelector( 'pratilipi-user-login' ).open();
				});
			},
			
			logOut: function() {
				this.$.AjaxGet.generateRequest();
			},
			
			register: function() {
				this.querySelector( 'pratilipi-user-login' ).close();
				this.querySelector( 'pratilipi-user-password-reset' ).close();
				this.async( function() {
					this.querySelector( 'pratilipi-user-register' ).open();
				});
			},
			
			resetPassword: function() {
				this.querySelector( 'pratilipi-user-login' ).close();
				this.querySelector( 'pratilipi-user-register' ).close();
				this.async( function() {
					this.querySelector( 'pratilipi-user-password-reset' ).open();
				});
			},
			
			_handleAjaxGetResponse: function(  request ) {
				if( ! request.detail.response ) {
					// TODO: show error
					return;
				}
				
				this.updateUser( request.detail.response );
			},

			_handleAjaxGetError: function() {
				// TODO: show error
			},

			ready: function() {
				this.updateUser( this.userData );
				window.fbAsyncInit = function() {
					FB.init({
						appId: ${ fbAppId },
						cookie : true,
						xfbml: true,
						version: 'v2.0'
					});
				}; 
				if( typeof(FB) == 'undefined' ) {
					( function( d, s, id ) {
						var js, fjs = d.getElementsByTagName(s)[0];
						if ( d.getElementById( id ) ) return;
						js = d.createElement(s); js.id = id;
						js.src = "//connect.facebook.net/en_US/sdk.js";
						fjs.parentNode.insertBefore(js, fjs);
					}( document, 'script', 'facebook-jssdk' ) );
				}
			}
			
		});

	</script>
	
</dom-module>
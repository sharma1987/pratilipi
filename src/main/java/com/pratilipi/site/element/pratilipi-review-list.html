<link rel="import" href="pratilipi-review.html" />
<link rel="import" href="pratilipi-review-input.html" />

<dom-module id="pratilipi-review-list">

	<style>
		
		:host {
			display: block;
		}
		
		paper-card {
			width: 100%;
			padding: 10px;
			--paper-card-header: { display: none };
		}

		paper-card h3 {
			margin: 0px;
			padding: 10px;
			display: inline-block;
		}

		paper-card a {
			margin-bottom: 6px;
		}

	</style>

	
	<template>

		<paper-card>
			<h3 style="color: #D0021B;">${ _strings.reviews }</h3>
			<template is="dom-if" if="{{ !isactive }}">
				<a class="pratilipi-grey-button" role="button" href="#ReviewInput" on-click="showReviewInput">${ _strings.write_a_review }</a>
			</template>
			
			<pratilipi-review-input
					id="ReviewInput"
					user="{{ user }}"
					pratilipi="{{ pratilipi }}"
					userpratilipi="{{ userpratilipi }}"
					isactive="{{ isactive }}"
					></pratilipi-review-input>
					
			<template is="dom-repeat" items="{{ reviewList }}" as="review">
				<hr style="border: 1px solid #E5E5E5; margin: 0; padding: 0;"/>
				<pratilipi-review review="{{ review }}"></pratilipi-review>
			</template>
		</paper-card>

		
		<iron-ajax
				id="AjaxGet"
				url="/api/userpratilipi/review/list"
				method="GET"
				content-type="application/json"
				handle-as="json"
				on-response="_handleAjaxGetResponse"
				on-error="_handleAjaxGetError"
				></iron-ajax>

	</template>


	<script>

		Polymer({
			
			is: 'pratilipi-review-list',

			properties: {
				user: { type: Object, observer:"_userChanged" },
				pratilipi: { type:Object },
				userpratilipi: { type:Object },
				
				reviewList: { type: Array },
				pratilipiId: { type:Number },
				cursor: { type: String },

				isLoading: { type: Boolean, value: false },
				isFinished: { type: Boolean, value: false },
				
				reviewButtonClicked: { type: Boolean, value: false },
				isactive: { type: Boolean, value: false }
			},
			
			_userChanged: function() {
				if( this.user.isGuest ) {
					this.reviewButtonClicked = false;
					this.querySelector( 'pratilipi-review-input' ).close();
				}
				if( ! this.user.isGuest && this.reviewButtonClicked ) {
					this.showReviewInput();
				}
			},
			
			showReviewInput: function() {
				if( this.user.isGuest ) {
					this.reviewButtonClicked = true;
					document.querySelector( 'pratilipi-user' ).logIn();
				} 
				else {
					this.reviewButtonClicked = false;
					this.isactive = true;
					this.$.ReviewInput.open();
				}
			},
			
			loadMore: function( scrollTop ) {
				if( this.isLoading || this.isFinished )
					return;

				var reqHeight = scrollTop
						- jQuery( this ).context.offsetTop
						+ jQuery( window ).height()
						+ 2 * jQuery( window ).height();
		
				if( jQuery( this ).outerHeight( true ) >= reqHeight )
					return;
				
				this.isLoading = true;
				this.$.AjaxGet.generateRequest();
			},
			
			_handleAjaxGetResponse: function( event ) {
				if( event.detail.xhr.status == 0 ) {
					this.isLoading = false;
					return;
				}
				
				var reviewList = event.detail.response.reviewList;
				for( var i = 0; i < reviewList.length; i++ )
					this.push( 'reviewList', reviewList[ i ] );

				if( event.detail.response.cursor ) {
					this.$.AjaxGet.params.cursor = event.detail.response.cursor;
					this.isLoading = false;
				} else {
					this.isFinished = true;
				}
			},

			_handleAjaxGetError: function() {
				this.isLoading = false;
			},
			
			ready: function() {
				if( this.pratilipiId && this.cursor ) {
					var ajaxGet = this.$.AjaxGet;
					ajaxGet.params = { 'pratilipiId':this.pratilipiId, 'cursor':this.cursor };
				} else {
					this.isFinished = true;
				}
			}

		});

	</script>

</dom-module>
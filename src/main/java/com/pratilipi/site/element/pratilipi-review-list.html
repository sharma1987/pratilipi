<link rel="import" href="pratilipi-review.html" />
<link rel="import" href="pratilipi-review-input.html" />

<dom-module id="pratilipi-review-list">

	<style>
		
		:host {
			display: block;
		}
		
		.secondary-500 {
			width: 100%;
			padding: 10px;
		}

		.secondary-500 h3 {
			margin: 0px;
			padding: 10px;
			display: inline-block;
		}

		.secondary-500 a {
			margin-bottom: 6px;
		}
		
		.modal {
			text-align: center;
		}

		@media screen { 
			.modal:before {
				display: inline-block;
				vertical-align: middle;
				content: " ";
				height: 100%;
			}
		}

		.modal-dialog {
			display: inline-block;
			text-align: left;
			vertical-align: middle;
		}
		
		paper-spinner.pratilipi-spinner {
			--paper-spinner-layer-1-color: #D0021B;
			--paper-spinner-layer-2-color: #107FE5;
			--paper-spinner-layer-3-color: #D0021B;
			--paper-spinner-layer-4-color: #107FE5;
		}

	</style>

	
	<template>
		<div class="secondary-500 pratilipi-shadow">
			<h3 style="color: #D0021B;">${ _strings.review_heading }</h3>
			<!-- <template is="dom-if" if="{{ userpratilipi.hasAccessToReview }}"> -->
				<template is="dom-if" if="{{ !isactive }}">
				
					<template is="dom-if" if="{{ !reviewAvailable }}">
						<a class="pratilipi-grey-button" role="button" href="#ReviewInput" on-click="showReviewInput">${ _strings.review_write_a_review }</a>
					</template>
					
					<template is="dom-if" if="{{ reviewAvailable }}">
						<div style="white-space: nowrap; display: inline-block;">
							<a class="pratilipi-grey-button" role="button" href="#ReviewInput" on-click="showReviewInput">${ _strings.review_edit_review }</a>
							<a class="pratilipi-grey-button" role="button" on-click="openDeleteReview">${ _strings.review_delete_review }</a>
						</div>
					</template>
					
				</template>
			<!-- </template> -->
		</div>
		
		<pratilipi-review-input
				id="ReviewInput"
				pratilipi="{{ pratilipi }}"
				userpratilipi="{{ userpratilipi }}"
				isactive="{{ isactive }}"
				></pratilipi-review-input>
		
		<div class="row">
			<template is="dom-if" if="{{ userpratilipi.review }}">
				<template is="dom-if" if="{{ !isactive }}">
					<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
						<pratilipi-review review="{{ userpratilipi }}"></pratilipi-review>
					</div>
				</template>
			</template>
			<template id="repeat" is="dom-repeat" items="[[reviewList]]">
					<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
						<pratilipi-review review="[[ item ]]"></pratilipi-review>
					</div>
			</template>	
		</div>
		<!-- <template is="dom-if" if="{{ !isFinished }}">
			<paper-spinner style="margin: 15px auto; display: block;" class="pratilipi-spinner" active></paper-spinner>
		</template> -->
		
		<div class="modal fade" id="deleteReview">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<span>${ _strings.review_delete_review }</span>
						<span style="float: right;"><paper-icon-button style="margin-top: -10px; margin-right: -10px;" noink="true" icon="close" data-dismiss="modal"></paper-icon-button></span>
					</div>
					<div class="modal-body">
						${ _strings.review_delete_review_confirm }
						<div style="margin-top: 5px; min-height: 20px;" class="text-center">
							<span>{{ message }}</span>
						</div>
					</div>
					<div class="modal-footer">
						<button id="deleteReviewButton" style="float: left; outline: none;" class="btn btn-danger" on-click="deleteReview">${ _strings.okay }</button>
						<div style="display: inline-block; min-width: 40px;" ></div>
						<button style="float: right; outline: none;" class="btn btn-primary" on-click="closeDeleteReview">${ _strings.cancel }</button>
					</div>
				</div>
			</div>
		</div>
		

		<iron-ajax
				id="AjaxGet"
				url="/api/userpratilipi/review/list"
				method="GET"
				content-type="application/json"
				handle-as="json"
				on-response="_handleAjaxGetResponse"
				on-error="_handleAjaxGetError"
				></iron-ajax>

	</template>


	<script>

		Polymer({
			
			is: 'pratilipi-review-list',

			properties: {
				user: { type: Object, observer:"_userChanged" },
				pratilipi: { type: Object },
				userpratilipi: { type: Object, value: {}, observer:"_userPratilipiChanged" },
				
				reviewList: { type: Array, value: [], notify: true },
				cursor: { type: String, value: null },

				isLoading: { type: Boolean, value: false },
				isFinished: { type: Boolean, value: false },
				
				isactive: { type: Boolean, value: false },
				
				reviewAvailable: { type: Boolean, value: false },
				userReviewDeleted: { type: Boolean, value: false }
			},
			
			_userChanged: function() {
				
				if( this.user.isGuest && this.userReviewDeleted ) {
					this.userReviewDeleted = false;
					this.set( 'reviewList', [] );
					this.$.AjaxGet.params.pratilipiId = this.pratilipi.pratilipiId;
					this.$.AjaxGet.params.cursor = null;
					this.$.AjaxGet.generateRequest();
				}
					
			},
			
			_userPratilipiChanged: function() {		
				if( this.userpratilipi == null || this.userpratilipi.review == null || this.reviewList == null ) {
					this.reviewAvailable = false;
					return;
				}

				this.reviewAvailable = true;
				
				var temp = this.reviewList;
				
				var index = -1;
				for( var i = 0; i < temp.length; i++ ) {
					if( this.userpratilipi.userPratilipiId == temp[i].userPratilipiId ) {
						index = i;
						break;
					}
				}
				
				if( index != -1 ) {
					this.splice( 'reviewList', index, 1 );
					this.userReviewDeleted = true;
					this.$.repeat.render();
				}
				
			},
			
			attached: function() {
				this._userPratilipiChanged();
			},
			
			openDeleteReview: function() {
				jQuery( "#deleteReview" ).modal();
			},
			
			closeDeleteReview: function() {
				jQuery( "#deleteReview" ).modal( 'hide' );
			},
			
			deleteReview: function() {
				this.message = "Please Wait";
				this.querySelector( 'pratilipi-review-input' ).deleteReview();
				jQuery( '#deleteReviewButton' ).prop( 'disabled', true );
				this.async( function() {
					jQuery( '#deleteReviewButton' ).prop( 'disabled', false );
					this.message = null;
					this.closeDeleteReview();
				}, 1000 );
			},
			
			showReviewInput: function() {
				if( this.user.isGuest )
					document.querySelector( 'pratilipi-user' ).logIn();
				else {
					this.isactive = true;
					this.querySelector( 'pratilipi-review-input' ).open();
				}
			},
			
			reset: function() {
				
				var ajaxGet = this.$.AjaxGet;

				if( ajaxGet.lastRequest )
					ajaxGet.lastRequest.abort();
				
				this.set( 'reviewList', [] );
				this.cursor = null;
				
				this.isLoading = false;
				this.isFinished = false;

			},
			
			loadMore: function( scrollTop ) {

				if( this.isLoading || this.isFinished || this.cursor == null )
					return;
				
				var reqHeight = scrollTop
						- jQuery( this ).context.offsetTop
						+ jQuery( window ).height()
						+ 2 * jQuery( window ).height();
		
				if( jQuery( this ).outerHeight( true ) >= reqHeight )
					return;
				
				this.isLoading = true;
				
				this.$.AjaxGet.params.pratilipiId = this.pratilipi.pratilipiId;
				this.$.AjaxGet.params.cursor = this.cursor;
				this.$.AjaxGet.generateRequest();
			},
			
			_handleAjaxGetResponse: function( event ) {
				if( event.detail.xhr.status == 0 ) {
					this.isLoading = false;
					return;
				}
				
				var reviewList = event.detail.response.reviewList;
				for( var i = 0; i < reviewList.length; i++ )
					this.push( 'reviewList', reviewList[ i ] );

				if( event.detail.response.cursor != null ) {
					this.cursor = event.detail.response.cursor;
					this.isLoading = false;
				} else {
					this.cursor = null;
					this.isFinished = true;
				}
			},

			_handleAjaxGetError: function() {
				this.isLoading = false;
			},
			
		});

	</script>

</dom-module>
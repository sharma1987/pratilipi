<link rel="import" href="pratilipi-edit-pratilipi.html" />
<link rel="import" href="pratilipi-rating.html" />
<link rel="import" href="pratilipi-social.html" />

<dom-module id="pratilipi-pratilipi">

	<style>
	
		:host {
			display: block;
		}
		
		paper-card {
			width: 100%;
			--paper-card-header: { display: none };
		}
		
		#more, #less {
			color: #333;
		}
		
		.less {
			max-height: 190px; 
			overflow: hidden;
		}
		
		.more {
			max-height: auto;
			overflow: visible;
		}
		
	</style>

	<template>
		<paper-card>
			
			<template is="dom-if" if="{{ pratilipi.hasAccessToUpdate }}">
				<paper-icon-button style="color: #333;" class="pull-right" icon="create" noink="true" on-click="openPratilipiEdit"></paper-icon-button>
				<pratilipi-edit-pratilipi pratilipi="{{ pratilipi }}"></pratilipi-edit-pratilipi>
			</template>
			
			<!-- For wide-screens and mobile screens-->
			<div id="pratilipi-row">
	    		<div id="pratilipi-col-left" style=" max-width: 170px; padding-bottom: 10px;">
	    			<div style="padding: 20px 0px 0px 10px;">
	    				<img style="width: 150px; height: 225px;" class="pratilipi-shadow" src="{{ pratilipi.coverImageUrl }}" alt="{{ title }}" title="{{ titleEn }}"/>
						<!-- <template is="dom-if" if="{{ !mobile }}">
							<paper-icon-button style="position: absolute; top: 200px; left: 120px;" type="button" on-click="_chooseFile" icon="file-upload" noink="true">choose file</paper-icon-button>
						</template>
						<input id="fileupload" type="file" name="files[]" data-url="api/pratilipi/" multiple> -->
						<div style="padding: 10px; margin-bottom: 15px;">
		    				<pratilipi-social shareUrl="getShareUrl"></pratilipi-social>
		    			</div>
		    		</div>
	    		</div>
	    		<div id="pratilipi-col-right" style="padding: 20px;">
					<h2 style="margin-top: 0px; color: #D0021B">{{ title }}</h2>
					<template is="dom-if" if="{{ pratilipi.author }}">
						<a href="{{ pratilipi.author.pageUrlAlias }}">
							<h5>{{ pratilipi.author.name }}</h5>
						</a>
					</template>
					
					<pratilipi-rating value="{{ pratilipi.averageRating }}">
							<span class="rating-text">&nbsp;({{ pratilipi.ratingCount }})</span>
					</pratilipi-rating>
					
					<template is="dom-if" if="{{ pratilipi.publicationYear }}">
						<div style="margin-top: 10px;">
							${ _strings.pratilipi_published }: {{ pratilipi.publicationYear }}
						</div>
					</template>
					
					<template is="dom-if" if="{{ !mobile }}">
						<div style="position: absolute; bottom: 110px;">
							<a on-click="redirectToReader" class="pratilipi-light-blue-button">${ _strings.pratilipi_read }</a>
							<!-- <button class="pratilipi-grey-button">Add to your Library</button> -->
						</div>
					</template>
					<template is="dom-if" if="{{ mobile }}">
						<div style="position: relative; margin-top: 25px;">
						<a on-click="redirectToReader" class="pratilipi-light-blue-button">${ _strings.pratilipi_read }</a>
							<!-- <button class="pratilipi-grey-button">Add to your Library</button> -->
						</div>
					</template>
					
	    		</div>
	    	</div>
	    	
			<hr style="border: 1px solid #E5E5E5; margin: 0; padding: 0;"/>
			
			<!-- Works, Reads and Likes -->
			<div class="row" style="text-align: center; padding: 10px; font-family: HelveticaNeue;">
				<div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
					<h3 style="display: inline-block;">{{ pratilipi.readCount }}</h3>&nbsp;&nbsp;<p style="display: inline-block;">Reads</p>
				</div>
				<div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
					<h3 style="display: inline-block;">{{ pratilipi.reviewCount }}</h3>&nbsp;&nbsp;<p style="display: inline-block;">Reviews</p>
				</div>
				<div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
					<h3 style="display: inline-block;">{{ pratilipi.fbLikeShareCount }}</h3>&nbsp;&nbsp;<p style="display: inline-block;">Likes</p>
				</div>
			</div>
			
		</paper-card>
		
		<br class="pratilipi-break" />
		
		<!-- Displaying author summary if.. -->
		<div id="pratilipi-summary">
			<paper-card>
				<div style="padding: 10px 20px 20px 20px; text-align: justify;">
					<h3 style="color: #D0021B;">${ _strings.pratilipi_summary }</h3>
						<div id="pratilipi-summary-text" style="margin-top: 10px; margin-down: 20px;">{{ summary }}</div>
						<div style="text-align: center; padding-top: 10px;">
							<a id="more" on-click="_toggleSnippet"><span>(${ _strings.show_more })</span></a>
							<a id="less" on-click="_toggleSnippet"><span>(${ _strings.show_less })</span></a>
						</div>
				</div>
			</paper-card>
			<br class="pratilipi-break" />
		</div>
	</template>
	
	<script>
	
	/* $(function () {
		$('#fileupload').fileupload({
			dataType: 'json',
	        done: function (e, data) {
	            $.each(data.result.files, function (index, file) {
	                $('<p/>').text(file.name).appendTo(document.body);
	            });
	        }
	    });
	}); */
	
		function getValue( url, key ) {
			   if( key = ( new RegExp( '[?&]' +encodeURIComponent( key ) + '=([^&]*)' ) ).exec( url ) )
			      return decodeURIComponent( key[1] );
			   else
				   return "";
		}
		
		function replaceAll( string, find, replace ) {
			return string.replace( new RegExp( find, 'g' ), replace );
		}
	
		Polymer({

			is: 'pratilipi-pratilipi',
			
			behaviors: [
				Polymer.IronResizableBehavior
			],
			
			listeners: {
				'iron-resize': '_onIronResize'
			},
			
			properties: {
				pratilipi: { type:Object, notify: true },
				mobile: { type: Boolean }
			},
			
			getShareUrl: function() {
				return 'http://' + ${ domain } + this.pratilipi.pageUrl;
			},
			
			openPratilipiEdit: function() {
				this.querySelector( 'pratilipi-edit-pratilipi' ).open();
			},
			
			redirectToReader: function() {
				if( this.pratilipi.readPageUrl !== undefined ) 
					window.location.href = "http://www.pratilipi.com/read?id=" + this.pratilipi.readPageUrl.substring( 6 ) + "&ret=" + window.location.href;
			},
			
			_onIronResize: function() {
				var windowsize = this.clientWidth;
				if( windowsize > 600 ) {
					this.mobile = false;
					jQuery( '#pratilipi-row' ).removeClass( 'row-mobile' );
					jQuery( '#pratilipi-col-left' ).removeClass( 'col-left-mobile' );
					jQuery( '#pratilipi-col-right' ).removeClass( 'col-right-mobile' );
					
					jQuery( '#pratilipi-row' ).addClass( 'row-widescreen' );
					jQuery( '#pratilipi-col-left' ).addClass( 'col-left-widescreen' );
					jQuery( '#pratilipi-col-right' ).addClass( 'col-right-widescreen' );
				}
				else {
					this.mobile = true;
					jQuery( '#pratilipi-row' ).removeClass( 'row-widescreen' );
					jQuery( '#pratilipi-col-left' ).removeClass( 'col-left-widescreen' );
					jQuery( '#pratilipi-col-right' ).removeClass( 'col-right-widescreen' );
					
					jQuery( '#pratilipi-row' ).addClass( 'row-mobile' );
					jQuery( '#pratilipi-col-left' ).addClass( 'col-left-mobile' );
					jQuery( '#pratilipi-col-right' ).addClass( 'col-right-mobile' );
				}
				
			},
			
			process: function( data ) {
				if( data.title === undefined && data.titleEn !== undefined )
					data.title = data.titleEn;
				if( data.author.name === undefined && data.author.name !== undefined )
					data.author.name = data.author.nameEn;
				data.averageRating = data.averageRating === undefined ? 0 : data.averageRating;
				data.ratingCount = data.ratingCount === undefined ? 0 : data.ratingCount;
				data.readCount = data.readCount === undefined ? 0 : data.readCount;
				data.reviewCount = data.reviewCount === undefined ? 0 : data.reviewCount;
				data.fbLikeShareCount = data.fbLikeShareCount === undefined ? 0 : data.fbLikeShareCount;
				return data;
			},
			
			updatePratilipi: function( pratilipi ) {
				this.set( 'pratilipi', this.process( pratilipi ) );
				this.title = pratilipi.title;
				this.titleEn = pratilipi.titleEn;
				this.processSummary();
			},
			
			attached: function() {
				this.updatePratilipi( this.pratilipi );
			},
			
			processSummary: function() {
				// Not displaying Summary if..
				if( this.pratilipi.summary === undefined ) { 
					document.getElementById( "pratilipi-summary" ).style.display = "none";
					return;
				}
				
				jQuery( '#pratilipi-summary-text' ).removeClass( 'less' );
				jQuery( '#pratilipi-summary-text' ).removeClass( 'more' );
				
				this.summary = this.pratilipi.summary;
				var jSummary = jQuery( "#pratilipi-summary-text" );
				jSummary.html( this.pratilipi.summary );
				var height = jSummary.height();
				
				if( height > 190 ) {
					jQuery( '#pratilipi-summary-text' ).addClass( 'less' );
					document.getElementById( "less" ).style.display = "none";
					document.getElementById( "more" ).style.display = "block";
				} else {
					document.getElementById( "less" ).style.display = "none";
					document.getElementById( "more" ).style.display = "none";
				}
			},
			
			_toggleSnippet: function() {
				jQuery( '#pratilipi-summary-text' ).toggleClass( 'less' );
				jQuery( '#pratilipi-summary-text' ).toggleClass( 'more' );
				
				if( document.getElementById( "more" ).style.display === "block" )
					document.getElementById( "more" ).style.display = "none";
				else
					document.getElementById( "more" ).style.display = "block";
				
				if( document.getElementById( "less" ).style.display === "block" )
					document.getElementById( "less" ).style.display = "none";
				else
					document.getElementById( "less" ).style.display = "block";
			},
			
			/* _chooseFile: function() {
				$( '#fileupload' ).click();
			}, */
			
		});
		
		
	</script>

</dom-module>

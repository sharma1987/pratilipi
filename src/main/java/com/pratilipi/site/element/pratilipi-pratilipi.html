<!-- Version:6.0 -->

<link rel="import" href="pratilipi-rating.html" />
<link rel="import" href="pratilipi-social.html" />
<link rel="import" href="pratilipi-rating-input.html" />

<dom-module id="pratilipi-pratilipi">

	<style>
	
		:host {
			display: block;
		}

		.media {
			padding: 10px;
		}
		
		
		.media-left {
			padding: 10px;
		}
		
		.media-left img {
			width: 150px;
			height: 225px;
		}


		.media-body {
			padding: 10px;
		}
		
	</style>

	<template>
		<div class="secondary-500">
			<div class="media">
	
				<div class="media-left">
					<img class="media-object" src="{{ pratilipi.coverImageUrl }}" alt="{{ pratilipi.title }}" title="{{ pratilipi.titleEn }}"/>
					<div style="text-align:center">
						<pratilipi-rating-input
								user="{{ user }}"
								pratilipi-id="{{ pratilipi.pratilipiId }}"
								value="{{ userpratilipi.rating }}"
								></pratilipi-rating-input>
						<pratilipi-social shareUrl="getShareUrl"></pratilipi-social>
					</div>
				</div>
				
				<div class="media-body">
					<h1 class="media-heading">{{ pratilipi.title }}</h1>
					<h4><a href="{{ pratilipi.author.pageUrlAlias }}">{{ pratilipi.author.name }}</a></h4>
					<div>
						<pratilipi-rating value="{{ pratilipi.averageRating }}">
							<strong><strong>&nbsp;&bull;&nbsp;</strong></strong>
							<strong>{{ getRatingsStr( pratilipi.ratingCount ) }}</strong>
						</pratilipi-rating>
					</div>
					<br/>
					<div>
						<a href="{{ pratilipi.readerPageUrl }}" target="_blank" class="btn">${ _strings.pratilipi_read }</a>
						<span class="text-success">${ _strings.pratilipi_free }</span>
					</div>
					<br/>
					<div>
						<span class="summary" style="text-align:justify;">{{ pratilipi.summary }}</span>
						<a href="#" class="show-more" on-click="showCompleteSummary"><small>(${ _strings.show_more })</small></a>
						<a href="#" class="show-less" on-click="showSummarySnippet"><small>(${ _strings.show_less })</small></a>
					</div>
					<br/>
				</div>
	
			</div>
			<hr/>
		</div>
	</template>
	

	<script>
	
	function getValue( url, key ) {
		   if( key = ( new RegExp( '[?&]' +encodeURIComponent( key ) + '=([^&]*)' ) ).exec( url ) )
		      return decodeURIComponent( key[1] );
		   else
			   return "";
	}
	
	function replaceAll( string, find, replace ) {
		return string.replace( new RegExp( find, 'g' ), replace );
	}

		Polymer({

			is: 'pratilipi-pratilipi',
			
			properties: {
				user: { type: Object },
				pratilipi: { type:Object, notify:true },
				pratilipiData: { type:Object },
				userpratilipi: { type:Object, notify:true }
			},
			
			getRatingsStr: function( ratingCount ) {
				return this.pratilipi.ratingCount + ' ' + ( this.pratilipi.ratingCount <= 1 ? '${ _strings.rating }' : '${ _strings.ratings }' );
			},

			getShareUrl: function() {
				return 'http://' + ${ domain } + pratilipi.pageUrl;
			},
			
			showCompleteSummary: function() {
				var jSummary = jQuery( this.querySelector( '.summary' ) );
				jSummary.html( this.pratilipi.summary );
				if( jSummary.text().length > 200 ) {
					jQuery( this.querySelector( '.show-more' ) ).hide();
					jQuery( this.querySelector( '.show-less' ) ).show();
				} else {
					jQuery( this.querySelector( '.show-more' ) ).hide();
					jQuery( this.querySelector( '.show-less' ) ).hide();
				}
			},
			
			showSummarySnippet: function() {
				var jSummary = jQuery( this.querySelector( '.summary' ) );
				jSummary.html( this.pratilipi.summary );
				if( jSummary.text().length > 200 ) {
					jSummary.text( jSummary.text().substr( 0, 200 ) + '...' );
					jQuery( this.querySelector( '.show-more' ) ).show();
					jQuery( this.querySelector( '.show-less' ) ).hide();
				} else {
					jQuery( this.querySelector( '.show-more' ) ).hide();
					jQuery( this.querySelector( '.show-less' ) ).hide();
				}
			},
			
			ready: function() {
				
				// Reduce Pratilipi Cover size to 67% on small screen devices.
				if( this.clientWidth < 600 )
					this.pratilipi.coverImageUrl = replaceAll( this.pratilipi.coverImageUrl, 
					"width=" + getValue( this.pratilipi.coverImageUrl, "width" ), 
					"width=" + ( getValue( this.pratilipi.coverImageUrl, "width" ) * 2/3 ) );

				this.pratilipiData.readerPageUrl = "http://www.pratilipi.com" + this.pratilipiData.readerPageUrl;
				this.set( 'pratilipi', this.pratilipiData );
				this.showSummarySnippet();
			}
			
		});
		
		
	</script>

</dom-module>
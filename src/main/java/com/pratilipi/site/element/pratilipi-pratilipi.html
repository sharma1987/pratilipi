<link rel="import" href="pratilipi-rating.html" />
<link rel="import" href="pratilipi-social.html" />

<dom-module id="pratilipi-pratilipi">

	<style>
	
		:host {
			display: block;
		}
		
		paper-card {
			width: 100%;
			--paper-card-header: { display: none };
		}
		
		paper-menu {
			--paper-menu-color: #333;
			--paper-menu-focused-item: {
				color: #107FE5;
			};
		}
		
		paper-item {
			cursor: pointer;
		}
		
		.col-right-mobile table {
			margin: 0 auto;
			text-align: left;
			white-space: nowrap;
		}
		
		.col-right-widescreen table td, .col-right-widescreen table th, .col-right-mobile table td, .col-right-mobile table th {
			white-space: nowrap;
			font-weight: 700;
			color: #333;
			height: 30px;
		}
		
		.col-right-widescreen table td, .col-right-mobile table td {
			padding-left: 10px;
		}
		
		#more, #less {
			color: #333;
		}
		
		.less {
			max-height: 190px; 
			overflow: hidden;
		}
		
		.more {
			max-height: auto;
			overflow: visible;
		}
		
		th {
			font-weight: 400;
			font-size: 15px;
		}
		
		td {
			font-weight: 400;
			font-size: 14px;
		}
		
		.pratilipi-file-upload {
			width: 150px;
		}
		
		paper-spinner.pratilipi-spinner {
			display: block;
			position: absolute;
			top: 40%;
			left: 40%;
			--paper-spinner-layer-1-color: #D0021B;
			--paper-spinner-layer-2-color: #107FE5;
			--paper-spinner-layer-3-color: #D0021B;
			--paper-spinner-layer-4-color: #107FE5;
		}
		
	</style>

	<template>
		<paper-card>
			
			<template is="dom-if" if="{{ pratilipi.hasAccessToUpdate }}">
				<paper-menu-button horizontal-align="right" class="pull-right">
					<paper-icon-button style="color: #333;" class="dropdown-trigger" icon="more-vert" noink></paper-icon-button>
						<paper-menu class="dropdown-content">
							<paper-item on-click="openPratilipiEdit">${ _strings.pratilipi_edit_info }</paper-item>
							<paper-item on-click="openWriterPanel">${ _strings.pratilipi_edit_content }</paper-item>
						</paper-menu>
				</paper-menu-button>
			</template>
			
			<!-- For wide-screens and mobile screens-->
			<div id="pratilipi-row">
				<div id="pratilipi-col-left" style="padding: 20px 0px 10px 10px;">
					<template is="dom-if" if="{{ !pratilipi.hasAccessToUpdate }}">
						<img class="pratilipi-shadow" src="{{ pratilipiCoverImageUrl }}" alt="{{ title }}" title="{{ titleEn }}"/>
					</template>
					<template is="dom-if" if="{{ pratilipi.hasAccessToUpdate }}">
						<div style="position: absolute; top: -1000px;">
							<form id="uploadImage" method="post" enctype="multipart/form-data" action="/api/pratilipi/cover?pratilipiId={{ pratilipi.pratilipiId }}" target="upload_target">
								<input id="uploadImageInput" type="file" on-change="uploadImage" name="{{ pratilipi.pratilipiId }}" accept="image/*">
							</form>
							<iframe id="upload_target" name="upload_target" style="display: none;" on-load="_onchangeiframe"></iframe>
						</div>
						<div class="pratilipi-file-upload">
							<template is="dom-if" if="{{ !imageUploaded }}">
								<img class="pratilipi-shadow" src="{{ pratilipiCoverImageUrl }}" alt="{{ title }}" title="{{ titleEn }}"/>
							</template>
							<template is="dom-if" if="{{ imageUploaded }}">
								<div style="width: 150px; height: 225px;" class="pratilipi-shadow">
									<paper-spinner class="pratilipi-spinner" active></paper-spinner>
								</div>
							</template>
							<iron-icon icon="icons:cloud-upload"></iron-icon>
							<div class="pratilipi-file-upload-caption" on-click="_chooseFile">
								<iron-icon icon="icons:cloud-upload"></iron-icon>
								<strong>Upload Photo</strong>
							</div>
						</div>
					</template>
					<div style="width: 150px; margin: 0px auto 15px auto; display: block; padding: 15px 0px;">
						<pratilipi-social show-like-count share-url="[[ pratilipiData.pageUrl ]]"></pratilipi-social>
					</div>
				</div>
				<div id="pratilipi-col-right" style="padding: 20px;">
					<h3 style="margin-top: 0px; color: #D0021B;">{{ title }}</h3>
					<template is="dom-if" if="{{ pratilipi.author }}">
						<a href="{{ pratilipi.author.pageUrl }}">
							<h6>{{ pratilipi.author.name }}</h6>
						</a>
					</template>
					
					<pratilipi-rating style="cursor: pointer;" on-click="showReviewInput" value="{{ pratilipi.averageRating }}">
							<span class="rating-text">&nbsp;({{ pratilipi.ratingCount }})</span>
					</pratilipi-rating>
					
					<h6 style="margin-top: 10px; font-weight: bold;">{{ type }}</h6>
					
					<table style="margin-top: 10px; margin-bottom: 5px;">
						<tr> <th>${ _strings.pratilipi_listing_date } :</th> 	<td>{{ listingDate }}</td> </tr>
						<tr> <th>${ _strings.pratilipi_count_reads } :</th> 	<td>{{ pratilipi.readCount }}</td> </tr>
					</table>
					
					<div style="position: relative; display: inline-block;">
						<button on-click="redirectToReader" class="pratilipi-light-blue-button">${ _strings.read }</button>
						<!-- <button class="pratilipi-grey-button">Add to your Library</button> -->
						<template is="dom-if" if="{{ pratilipi.hasAccessToUpdate }}">
							<button id="changeStateButton" on-click="changePratilipiState" class="pratilipi-light-blue-button">{{ changeState }}</button>
						</template>
					</div>
					
				</div>
			</div>
		</paper-card>
		
		<br class="pratilipi-break" />
		
		<!-- Displaying author summary if.. -->
		<div id="pratilipi-summary">
			<paper-card>
				<div style="padding: 10px 20px 20px 20px; text-align: justify;">
					<h4 style="color: #D0021B;">${ _strings.pratilipi_summary }</h4>
						<div id="pratilipi-summary-text" style="margin-top: 10px; margin-down: 20px;">{{ summary }}</div>
						<div style="text-align: center; padding-top: 10px;">
							<a id="more" style="font-size: 14px; font-weight: 700;" on-click="_toggleSnippet">(${ _strings.show_more })</a>
							<a id="less" style="font-size: 14px; font-weight: 700;" on-click="_toggleSnippet">(${ _strings.show_less })</a>
						</div>
				</div>
			</paper-card>
			<br class="pratilipi-break" />
		</div>
		
		<div id="alertSuccess" class="modal fade">
			<div class="modal-dialog modal-sm">
				<div class="modal-content">
					<div class="modal-body">
						<button type="button" class="close" data-dismiss="modal">&times;</button>
						<div style="margin-top: 50px; margin-bottom: 50px; text-align: center;">
							<h5>${ _strings.updated_pratilipi_info_success }</h5>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<iron-ajax
				id="AjaxGet"
				url="/api/pratilipi"
				method="GET"
				content-type="application/json"
				handle-as="json"
				on-response="_handleAjaxGetResponse"
				></iron-ajax>
		<iron-ajax
				id="AjaxPost"
				url="/api/pratilipi"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
	</template>
	
	<script>
	
		function convertDate( date ) {
			var d = new Date( date );
			function day(d) { return (d < 10) ? '0' + d : d; }
			function month(m) { var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; return months[m]; }
			return [ day(d.getDate()), month(d.getMonth()), d.getFullYear() ].join(' ');
		}
	
		Polymer({

			is: 'pratilipi-pratilipi',
			
			behaviors: [		
				Polymer.IronResizableBehavior		
			],
			
			listeners: {
				'iron-resize': '_onIronResize'
			},
			
			properties: {
				user: { type: Object, observer: "_userChanged" },
				pratilipi: { type:Object, notify: true },
				pratilipiData: { type: Object },
				pratilipiTypes: { types: Object },
				
				mobile: { type: Boolean },
				imageUploaded: { type: Boolean, value: false }
			},
			
			showReviewInput: function() {
				document.querySelector( 'pratilipi-review-list' ).showReviewInput();
			},
			
			openPratilipiEdit: function() {
				document.querySelector( 'pratilipi-write' ).editExistingPratilipi( this.pratilipi );
			},
			
			openWriterPanel: function() {
				window.location.href = this.pratilipi.writePageUrl + "&ret=" + window.location.pathname;
			},
			
			redirectToReader: function() {
				window.location.href = this.pratilipi.readPageUrl + "&ret=" + window.location.pathname;
			},
			
			_onIronResize: function() {
				var windowsize = this.clientWidth;
				if( windowsize > 600 ) {
					this.mobile = false;
					jQuery( '#pratilipi-row' ).removeClass( 'row-mobile' );
					jQuery( '#pratilipi-col-left' ).removeClass( 'col-left-mobile' );
					jQuery( '#pratilipi-col-right' ).removeClass( 'col-right-mobile' );
					
					jQuery( '#pratilipi-row' ).addClass( 'row-widescreen' );
					jQuery( '#pratilipi-col-left' ).addClass( 'col-left-widescreen' );
					jQuery( '#pratilipi-col-right' ).addClass( 'col-right-widescreen' );
				}
				else {
					this.mobile = true;
					jQuery( '#pratilipi-row' ).removeClass( 'row-widescreen' );
					jQuery( '#pratilipi-col-left' ).removeClass( 'col-left-widescreen' );
					jQuery( '#pratilipi-col-right' ).removeClass( 'col-right-widescreen' );
					
					jQuery( '#pratilipi-row' ).addClass( 'row-mobile' );
					jQuery( '#pratilipi-col-left' ).addClass( 'col-left-mobile' );
					jQuery( '#pratilipi-col-right' ).addClass( 'col-right-mobile' );
				}
				
			},
			
			process: function( data ) {
				data.averageRating = data.averageRating == null ? 0 : data.averageRating;
				data.ratingCount = data.ratingCount == null ? 0 : data.ratingCount;
				data.readCount = data.readCount == null ? 0 : data.readCount;
				data.reviewCount = data.reviewCount == null ? 0 : data.reviewCount;
				data.fbLikeShareCount = data.fbLikeShareCount == null ? 0 : data.fbLikeShareCount;
				return data;
			},
			
			updatePratilipi: function( pratilipi ) {
				this.set( 'pratilipi', this.process( pratilipi ) );
				
				this.title = pratilipi.title;
				this.titleEn = pratilipi.titleEn;
				
				if( pratilipi.coverImageUrl.indexOf( '?' ) == -1 )
					this.pratilipiCoverImageUrl = pratilipi.coverImageUrl + "?" + "width=150";
				else
					this.pratilipiCoverImageUrl = pratilipi.coverImageUrl + "&" + "width=150";
				
				this.type = this.pratilipiTypes[ pratilipi.type.toUpperCase() ].name;
				this.listingDate = convertDate( pratilipi.listingDateMillis );
				if( pratilipi.state == "DRAFTED" )
					this.changeState = "${ _strings.pratilipi_publish_it }";
				else if ( pratilipi.state == "PUBLISHED" )
					this.changeState = "${ _strings.pratilipi_move_to_drafts }";
				else
					jQuery( '#changeStateButton' ).hide();


				// Not displaying Summary if..
				if( pratilipi.summary == null || pratilipi.summary.trim() == "" ) { 
					document.getElementById( "pratilipi-summary" ).style.display = "none";
				} else {
					jQuery( '#pratilipi-summary-text' ).removeClass( 'less' );
					jQuery( '#pratilipi-summary-text' ).removeClass( 'more' );
					this.summary = pratilipi.summary;
					var jSummary = jQuery( "#pratilipi-summary-text" );
					jSummary.html( this.summary );
					var height = jSummary.height();
					
					if( height > 190 ) {
						jQuery( '#pratilipi-summary-text' ).addClass( 'less' );
						document.getElementById( "less" ).style.display = "none";
						document.getElementById( "more" ).style.display = "block";
					} else {
						document.getElementById( "less" ).style.display = "none";
						document.getElementById( "more" ).style.display = "none";
					}
				}
				
			},
			
			attached: function() {
				this.pratilipiTypes = jQuery.parseJSON( this.pratilipiTypes );
				this.updatePratilipi( this.pratilipiData );
			},
			
			
			_toggleSnippet: function() {
				jQuery( '#pratilipi-summary-text' ).toggleClass( 'less' );
				jQuery( '#pratilipi-summary-text' ).toggleClass( 'more' );
				
				if( document.getElementById( "more" ).style.display === "block" )
					document.getElementById( "more" ).style.display = "none";
				else
					document.getElementById( "more" ).style.display = "block";
				
				if( document.getElementById( "less" ).style.display === "block" )
					document.getElementById( "less" ).style.display = "none";
				else
					document.getElementById( "less" ).style.display = "block";
			},
			
			_userChanged: function() {
				if( this.pratilipi == null )
					return;

				var ajaxGet = this.$.AjaxGet;
				ajaxGet.params.pratilipiId = this.pratilipi.pratilipiId;
				ajaxGet.generateRequest();
			},
			
			_handleAjaxGetResponse: function( event ) {
				this.updatePratilipi( event.detail.response );
			},
			
			changePratilipiState: function() {
				if( this.pratilipi.state == "DRAFTED" )
					this.publishPratilipi();
				else if( this.pratilipi.state == "PUBLISHED" )
					this.moveToDrafts();
			},
			
			publishPratilipi: function( pratilipiId ) {
				this.$.AjaxPost.body = ( "pratilipiId=" + this.pratilipi.pratilipiId + "&" + "state=PUBLISHED" );
				this.$.AjaxPost.generateRequest();
			},
			
			moveToDrafts: function( pratilipiId ) {
				this.$.AjaxPost.body = ( "pratilipiId=" + this.pratilipi.pratilipiId + "&" + "state=DRAFTED" );
				this.$.AjaxPost.generateRequest();
			},
			
			_handleAjaxPostResponse: function( event ) {
				var pratilipi = event.detail.response;
				this.updatePratilipi( pratilipi );
				this.async( function() {
					jQuery( "#alertSuccess" ).modal();
				});
				this.async( function() {
					jQuery( "#alertSuccess" ).modal( 'hide' );
				}, 1200);
			},
			
			_handleAjaxPostError: function( event ) {
				if( event.detail.request.xhr.status === 400 || event.detail.request.xhr.status === 401 || event.detail.request.xhr.status === 500 )
					alert( event.detail.request.xhr.response.message );
				else
					alert( "Some Error occured! Please try Again." );
			},
			
			_chooseFile: function() {
				document.getElementById( "uploadImageInput" ).click();
			},
			
			_onchangeiframe: function() {
				if( this.imageUploaded ) {
					this.imageUploaded = false;
					this.async( function() {
						this.pratilipiCoverImageUrl = this.pratilipiCoverImageUrl + "&" + "version=" + new Date().getTime();
					}, 50 );
				}
			},
			
			uploadImage: function() {
				document.getElementById( "uploadImage" ).submit();
				this.imageUploaded = true;
			}
			
		});
		
		
	</script>

</dom-module>

<dom-module id="pratilipi-author-books">

	<style>

		:host {
			display: block;
		}
		
		paper-card {
			width: 100%;
			padding-top: 15px;
			padding-bottom: 15px;
			background: #EFEFEF;
		}
		
		paper-spinner.pratilipi-spinner {
			--paper-spinner-layer-1-color: #D0021B;
			--paper-spinner-layer-2-color: #107FE5;
			--paper-spinner-layer-3-color: #D0021B;
			--paper-spinner-layer-4-color: #107FE5;
		}
		
	</style>


	<template>
		<paper-card>
			<div class="row text-center">
				<a id="drafts" class="col-xs-6 col-sm-6 col-md-6 col-lg-6" on-click="draftsClicked">
					${ _strings.author_drafts }
				</a>
				<a id="published" class="col-xs-6 col-sm-6 col-md-6 col-lg-6" on-click="publishedClicked">
					${ _strings.author_published_works }
				</a>
			</div>
		</paper-card>
		
		<br class="pratilipi-break" />
		
		<pratilipi-card-grid
			id='draftedBooksByAuthor'
			author-id='[[ author.authorId ]]'
			include-add-card
			drafts-active="[[ draftsActive ]]"
			published-active="[[ publishedActive ]]"
			pratilipi-list='[[ draftedList ]]'
			></pratilipi-card-grid>
		
		<pratilipi-card-grid
			id='publishedBooksByAuthor'
			author-id='[[ author.authorId ]]'
			include-add-card
			drafts-active="[[ draftsActive ]]"
			published-active="[[ publishedActive ]]"
			pratilipi-list='[[ publishedList ]]'
			></pratilipi-card-grid>
		
		<div id="author-books-spinner">
			<paper-spinner class="pratilipi-spinner pratilipi-spinner-center" active></paper-spinner>	
		</div>
		
		<iron-ajax
				id="AjaxGetDraftedList"
				url="/api/pratilipi/list"
				method="GET"
				content-type="application/json"
				handle-as="json"
				on-response="_handleAjaxGetDraftedListResponse"
				on-error="_handleAjaxGetDraftedListError"
				></iron-ajax>
		<iron-ajax
				id="AjaxGetPublishedList"
				url="/api/pratilipi/list"
				method="GET"
				content-type="application/json"
				handle-as="json"
				on-response="_handleAjaxGetPublishedListResponse"
				on-error="_handleAjaxGetPublishedListError"
				></iron-ajax>
	</template>


	<script>

		Polymer({
			
			is: 'pratilipi-author-books',
			
			properties: {
				author: { type: Object },
				
				draftedList: { type: Array, value: [], notify: true },
				draftedListCursor: { type: String, value: "" },
				draftsActive : { type: Boolean, value: false },
				draftsLoading: { type: Boolean, value: false },
				
				publishedList: { type: Array, value: [], notify: true },
				publishedListCursor: { type: String, value: "" },
				publishedActive : { type: Boolean, value: false },
				publishedLoading: { type: Boolean, value: false }
			},
			
			clearDraftedList: function() {
				this.set( 'draftedList', [] );
				this.draftedListCursor = "";
			},
			
			clearPublishedList: function() {
				this.set( 'publishedList', [] );
				this.publishedListCursor = "";
			},
			
			addToDraftedList: function( draftedContent ) {
				this.unshift( 'draftedList', draftedContent );
			},
			
			addToPublishedList: function( publishedContent ) {
				this.unshift( 'publishedList', publishedContent );
			},
			
			removeFromDraftedList: function( draftedContent ) {
				var index = -1;
				for( var i = 0; i < this.draftedList.length; i++ ) {
					if( draftedContent.pratilipiId == this.draftedList[i].pratilipiId ) {
						index = i;
						break;
					}
				}
				
				if( index != -1 )
					this.splice( 'draftedList', index, 1 );

			},
			
			removeFromPublishedList: function( publishedContent ) {
				var index = -1;
				for( var i = 0; i < this.publishedList.length; i++ ) {
					if( publishedContent.pratilipiId == this.publishedList[i].pratilipiId ) {
						index = i;
						break;
					}
				}

				if( index != -1 )
					this.splice( 'publishedList', index, 1 );
					
			},
			
			removeAllClasses: function() {
				jQuery( '#drafts' ).removeClass( 'active' );
				jQuery( '#drafts' ).removeClass( 'inactive' );
				jQuery( '#published' ).removeClass( 'active' );
				jQuery( '#published' ).removeClass( 'inactive' );
			},
			
			attached: function() {
				this.draftsClicked();
				this.async( function() {
					this.publishedLoading = true;
					this._makeAjaxCall( this.$.AjaxGetPublishedList, this.author.authorId, "", "PUBLISHED" );
				}, 100);
			},
			
			draftsClicked: function() {
				
				if( this.draftsActive )
					return;
				
				// Highlight Drafts 
				this.removeAllClasses();
				jQuery( '#drafts' ).addClass( 'active' );
				jQuery( '#published' ).addClass( 'inactive' );
				
				// Set Boolean flags
				this.draftsActive = true;
				this.publishedActive = false;
				
				// Render the card grid
				document.getElementById( "draftedBooksByAuthor" ).style.display = "block";
				document.getElementById( "publishedBooksByAuthor" ).style.display = "none";

				// Load Drafted Contents
				this.loadDraftedContents();
				
			},
		
			publishedClicked: function() {
				
				if( this.publishedActive )
					return;
				
				// Highlight Published
				this.removeAllClasses();
				jQuery( '#published' ).addClass( 'active' );
				jQuery( '#drafts' ).addClass( 'inactive' );
				
				// Set Boolean flags
				this.publishedActive = true;
				this.draftsActive = false;
				
				// Render the card grid
				document.getElementById( "publishedBooksByAuthor" ).style.display = "block";
				document.getElementById( "draftedBooksByAuthor" ).style.display = "none";

				// Load Published Contents
				this.loadPublishedContents();
				
			},
			
			_checkWindowHeight: function() {
				var reqHeight = jQuery( window ).scrollTop()
								- jQuery( this ).position().top
								+ jQuery( window ).height()
								+ 3 * jQuery( window ).height();

				if( jQuery( this ).outerHeight( true ) >= reqHeight )
					return false;
				else
					return true;
			},
			
			loadMore: function() {
				if( !this._checkWindowHeight )
					return;
				if( this.draftsActive )
					this.loadDraftedContents();
				if( this.publishedActive )
					this.loadPublishedContents();
			},
			
			loadDraftedContents: function() {
				
				if( this.draftedListCursor == null && this.draftsActive )
					jQuery( '#author-books-spinner' ).css( "display", "none" );

				if( this.draftedListCursor == null || ! this.draftsActive || ! this._checkWindowHeight() || this.draftsLoading )
					return;
				
				// Make the spinner active
				jQuery( '#author-books-spinner' ).css( "display", "block" );
				
				// Make AJAX Call
				this.draftsLoading = true;
				this._makeAjaxCall( this.$.AjaxGetDraftedList, this.author.authorId, this.draftedListCursor, "DRAFTED" );
				
			},
			
			loadPublishedContents: function() {
				
				if( this.publishedListCursor == null && this.publishedActive )
					jQuery( '#author-books-spinner' ).css( "display", "none" );

				if( this.publishedListCursor == null || ! this.publishedActive || ! this._checkWindowHeight() || this.publishedLoading )
					return;
				
				// Make the spinner active
				jQuery( '#author-books-spinner' ).css( "display", "block" );
				
				// Make AJAX Call
				this.publishedLoading = true;
				this._makeAjaxCall( this.$.AjaxGetPublishedList, this.author.authorId, this.publishedListCursor, "PUBLISHED" );
				
			},
			
			_makeAjaxCall: function( listName, authorId, cursor, state ) {
				listName.params.authorId = authorId;
				listName.params.cursor = cursor;
				listName.params.state = state;
				listName.generateRequest();
			},
			
			_handleAjaxGetDraftedListResponse: function( event ) {
				
				this.draftsLoading = false;
				
				if( event.detail.response == null ) {
					this.async( function() {
						this.loadDraftedContents();
					}, 100 );
					return;
				}
				
				var draftedList = event.detail.response.pratilipiList;
				
				for( var i = 0; i < draftedList.length; i++ )
					this.push( 'draftedList', draftedList[i] );
				
				if( draftedList.length < 20 || event.detail.response.cursor == null )
					this.draftedListCursor = null;
				else if( event.detail.response.cursor != null )
					this.draftedListCursor = event.detail.response.cursor;
				
				// Disable the spinner
				if( this.draftsActive )
					jQuery( '#author-books-spinner' ).css( "display", "none" );
				
			},
			
			_handleAjaxGetPublishedListResponse: function( event ) {
				
				this.publishedLoading = false;
				
				if( event.detail.response == null ) {
					this.async( function() {
						this.loadPublishedContents();
					}, 100 );
					return;
				}
				
				var publishedList = event.detail.response.pratilipiList;
				
				for( var i = 0; i < publishedList.length; i++ )
					this.push( 'publishedList', publishedList[i] );
				
				if( publishedList.length < 20 || event.detail.response.cursor == null )
					this.publishedListCursor = null;
				else if( event.detail.response.cursor != null )
					this.publishedListCursor = event.detail.response.cursor;
				
				// Disable the spinner
				if( this.publishedActive ) 
					jQuery( '#author-books-spinner' ).css( "display", "none" );
				
			},
			
			_handleAjaxGetDraftedListError: function( event ) {
				this.draftsLoading = false;
				if( event.detail.request.xhr.status == 401 ) {
					return;
				}
				this.async( function() {
					this.loadDraftedContents();
				}, 10000 );
			},
			
			_handleAjaxGetPublishedListError: function( event ) {
				this.publishedLoading = false;
				if( event.detail.request.xhr.status == 401 ) {
					return;
				}
				this.async( function() {
					this.loadPublishedContents();
				}, 10000 );
			}
			
		});

	</script>

</dom-module>
<dom-module id="pratilipi-user-password-change">

	<template>
		<div class="popup">
			<h5 class="popup-heading">Change Password</h5>
			<div class="popup-body" on-keyup="onSubmit">
				<div class="form-group">
					<label for="FormInput-Password">${ _strings.password }</label>
					<input type="password" class="form-control" id="FormInput-Password" placeholder="********" value="{{ userPassword::input }}">
					<span class="text-danger">{{ password }}</span>
				</div>
				<div class="form-group">
					<label for="FormInput-Password2">${ _strings.confirm_password }</label>
					<input type="password" class="form-control" id="FormInput-Password2" placeholder="********" value="{{ userPassword2::input }}">
					<span class="text-danger">{{ password2 }}</span>
				</div>
				<div class="text-center">
					<span class="text-center text-success">{{ message }}</span>
					<span class="text-center text-danger">{{ errMessage }}</span>
					<br/>
					<br/>
					<button type="button" class="btn" on-click="onSubmit">${ _strings.sign_up }</button>
				</div>
			</div>
		</div>
		
		<iron-ajax
				id="AjaxPost"
				url="/api/user/upatepassword"
				method="POST"
				content-type="application/json"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
				
	</template>

   
	<script>
	
		Polymer({
			
			is: 'pratilipi-user-password-change',
			
			behaviors: [
				Polymer.IronOverlayBehavior
			],
			
			properties: {
				email: { type: String },
				verificationToken: { type: String },
				userPassword: { type: String },
				userPassword2: { type: String },
				message: { type: String },
				errMessage: { type: String },
			},
			
			setData: function( email, token ) {
				this.email = email;
				this.token = token;
			},
			
			clearMessages: function() {
				this.message = null;
				this.errMessage = null; 
				this.password = null;
				this.password2 = null;
			},
			
			onSubmit: function( event ) {
				
				if( event.keyCode != null && event.keyCode != 0 && event.keyCode != 13 )
					return;
				
				this.message = "Working ...";

				var ajaxPost = this.$.AjaxPost;
				ajaxPost.params = { 
						email: this.email,
						verificationToken: this.token,
						newPassword: this.userPassword,
						newPassword2: this.userPassword2 };
				ajaxPost.generateRequest();

			},
			
			_handleAjaxPostResponse: function( event ) {
				this.clearMessages();
				if( event.detail.xhr.status == 0 ) {
					this.errMessage = "Could not connect to server !";
				} else {
					this.message= "Password has been changed Successfully!";
					this.async( function() {
 						this.message = null;				
						this.close();
					}, 2000 );
				}
				document.querySelector( 'pratilipi-user' ).updateUser( event.detail.response );
 				window.location = "http://" + window.location.host; 
			},
			
			_handleAjaxPostError: function( event ) {
				this.clearMessages();
				if( event.detail.request.xhr.status == 400 ) {
					this.password = event.detail.request.xhr.response.password;
					this.password2 = event.detail.request.xhr.response.password2;
					if( event.detail.request.xhr.response.token != null )
						this.errMessage = event.detail.request.xhr.response.token;
					else if( event.detail.request.xhr.response.errMessage != null )
						this.errMessage = event.detail.request.xhr.response.errMessage;
					else
						this.errMessage = "Invalid Input";
				} else {
					this.errMessage = event.detail.request.xhr.response.message;
				}
			},
		});
		
	</script>

</dom-module>
<link rel='import' href='pratilipi-reader-header.html'>
<link rel='import' href='pratilipi-reader-navigation.html'>
<link rel='import' href='pratilipi-reader-content.html'>
<link rel='import' href='pratilipi-reader-footer.html'>

<dom-module id="pratilipi-reader-page">

	<template>
		<header class="nav-down">
    		<pratilipi-reader-header 
    				pratilipi="{{ pratilipi }}"
    				font-size="[[ fontSize ]]"></pratilipi-reader-header>
			<pratilipi-reader-navigation
					page-no="{{ pageNo }}"
					></pratilipi-reader-navigation>
		</header>
		<main>
			<div class="parent-container margin-top-bottom">
				<div class="container">
					<div style="overflow:hidden">
						<pratilipi-reader-content
							content="{{ content }}"
							font-size="{{ fontSize }}"></pratilipi-reader-content> 
					</div>
				</div>
			</div>
		</main>
		<footer>
    		<pratilipi-reader-footer
    			page-no="{{ pageNo }}"
    			page-count="{{ pageCount }}"></pratilipi-reader-footer>
		</footer>
		<div class="scroll-top-button">
			<a id="scrollToTop" on-click="scrollToTop"><img src="http://0.ptlp.co/resource-all/icon/footer/arrow_up_transparent_64.png"/></a>
		</div>
		<iron-ajax
				id="AjaxGet"
				url="/api/pratilipi/content"
				method="GET"
				content-type="application/json"
				handle-as="json"
				on-response="_onResponse"
				on-error="_onError"
				></iron-ajax>
	</template>

	<script>
		function getCookie( name ) {
			var nameEQ = name + "=";
			var ca = document.cookie.split( ';' );
			for( var i = 0; i < ca.length; i++ ) {
				var c = ca[i];
				while( c.charAt(0) == ' ' ) c = c.substring( 1, c.length );
				if( c.indexOf( nameEQ ) == 0 ) return c.substring( nameEQ.length, c.length );
			}
			return null;
		}
		function setCookie( name, value, days ) {
			var date = new Date();
			date.setTime( date.getTime() + ( days * 24 * 60 * 60 * 1000 ) );
			var expires = "; expires=" + date.toGMTString();
			document.cookie = name + "=" + value + expires + "; path=/";
		}
		function eraseCookie( name ) {
			createCookie( name, "" ,-1 );
		}
		function getUrlParameter( key ) {
		   if( key = ( new RegExp( '[?&]' +encodeURIComponent( key ) + '=([^&]*)' ) ).exec( location.search ) )
		      return decodeURIComponent( key[1] );
		   else
			   return null;
		}
	
		Polymer({

			is: 'pratilipi-reader-page',
			
			properties: {
				userData: { type: Object },
				pratilipi: { type: Object },
				fontSize: { type: Number, notify: true },
				pageNo: { type: Number, observer: "_pageNoChanged" },
				pageCount: { type: Number },
				content: { type: String },
				contentMap: { type: Object, value: {} },
				lastScrollTop: { type: Number, value: 0 },
			},
			
			setFontSize: function( fontSize ) {
				fontSize = fontSize == null ? 14 : parseInt( fontSize );
				this.set( "fontSize", fontSize );
				setCookie( "fontSize", fontSize, 15 );
			},
			
			increaseFontSize: function() {
				var cutoff = 32;
				if( this.fontSize + 2 <= cutoff )
					this.setFontSize( this.fontSize + 2 );
			},
			
			decreaseFontSize: function() {
				var cutoff = 12;
				if( this.fontSize - 2 >= cutoff )
					this.setFontSize( this.fontSize - 2 );
			},
			
			exitReader: function() {
				if( getUrlParameter( "ret" ) != null ) 
					window.location.href = getUrlParameter( "ret" );
				else
					window.location.href = "/pratilipi/" + this.pratilipi.pratilipiId;
			},
			
			ready: function() {
				jQuery( '#scrollToTop' ).css( "display", "none" );
				this.setFontSize( getCookie( "fontSize" ) );
				this.contentMap[ this.pageNo ] = this.content;
			},
			
			_pageNoChanged: function() {
				// Called before ready function
				if( this.contentMap == null || jQuery.isEmptyObject( this.contentMap ) )
					return;
				
				if( this.contentMap[ this.pageNo ] != null )	// Check in Map if exists
					this.set( 'content', this.contentMap[ this.pageNo ] );
				else											// Else make api call
					this._loadContent( this.pageNo );
				
				console.log( this.contentMap );
				
				//this._precache();								// Load Previous and next pages
				
			},
			
			_loadContent: function( pageNo ) {
				if( pageNo == null )
					return;
				
				var ajaxGet = this.$.AjaxGet;
				ajaxGet.params.pratilipiId = this.pratilipi.pratilipiId;
				ajaxGet.params.chapterNo = pageNo;
				ajaxGet.params.pageNo = pageNo;
				ajaxGet.generateRequest();
			},
			
			_onResponse: function( event ) {
				
				var response = event.detail.response;

				// Populate map
				this.contentMap[ response.pageNo ] = response.pageContent;
				
				// Update content if response page no == this page no
				if( this.pageNo == response.pageNo )
					this.set( 'content', response.pageContent );
			},
			
			_onError: function( event ) {
				// Show appropriate message
				alert( "Sorry! Some exception occured at the server! Try again" );
				// Try again in 3 seconds
			},
			
			scrollToTop: function() {
				$( 'html, body' ).animate( { scrollTop : 0 },800 );
			},
			
			scrollHandler: function( st ) {
				if( st > this.lastScrollTop || st < 100 )
					jQuery( '#scrollToTop' ).fadeOut();
				else
					jQuery( '#scrollToTop' ).fadeIn();
				this.lastScrollTop = st;
			}
			
		});
	</script>

</dom-module>
<link rel='import' href='pratilipi-reader-header.html?2016050202'>
<link rel='import' href='pratilipi-reader-content.html?20160503'>
<link rel='import' href='pratilipi-reader-footer.html?20160429'>
<link rel="import" href="pratilipi-review-input.html?20160502" />

<dom-module id="pratilipi-reader-page">

	<template>
		<header>
    		<pratilipi-reader-header 
    				pratilipi="{{ pratilipi }}"
    				font-size="[[ fontSize ]]"
    				has-access-to-update="[[ pratilipi.hasAccessToUpdate ]]"
    				added-to-lib="[[ addedToLib ]]"
    				hide-index-button="[[ hideIndexButton ]]"
    				page-no="[[ pageNo ]]"
    				index="{{ index }}"></pratilipi-reader-header>
		</header>
		<pratilipi-user user='{{ user }}' user-data="[[ userData ]]"></pratilipi-user>
		<pratilipi-alert></pratilipi-alert>
		<pratilipi-review-input pratilipi="[[ pratilipi ]]"></pratilipi-review-input>
		<div style="margin-top: 70px;">
			<div class="parent-container">
				<div class="container" style="margin: 0 auto;">
					<div style="overflow:hidden;">
						<pratilipi-reader-content
							content="{{ content }}"
							font-size="{{ fontSize }}"
							last-page="{{ lastPage }}"></pratilipi-reader-content>
					</div>
				</div>
			</div>
		</div>
		<footer>
    		<pratilipi-reader-footer
    			page-no="[[ pageNo ]]"
    			page-count="{{ pageCount }}"></pratilipi-reader-footer>
    		<pratilipi-footer></pratilipi-footer>
		</footer>
		<iron-ajax
				id="AjaxGet"
				url="/api/pratilipi/content"
				method="GET"
				content-type="application/json"
				handle-as="json"
				on-response="_onResponse"
				on-error="_onError"
				></iron-ajax>
		<iron-ajax
				id="AjaxPost"
				url="/api/userpratilipi/library"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
		<iron-ajax
				id="GetUserPratilipi"
				url="/api/userpratilipi"
				method="GET"
				content-type="application/json"
				handle-as="json"
				on-response="_getUserPratilipiResponse"
				on-error="_getUserPratilipiError"
				></iron-ajax>
	</template>

	<script>
		function getCookie( name ) {
			var nameEQ = name + "=";
			var ca = document.cookie.split( ';' );
			for( var i = 0; i < ca.length; i++ ) {
				var c = ca[i];
				while( c.charAt(0) == ' ' ) c = c.substring( 1, c.length );
				if( c.indexOf( nameEQ ) == 0 ) return c.substring( nameEQ.length, c.length );
			}
			return null;
		}
		function setCookie( name, value, days ) {
			var date = new Date();
			date.setTime( date.getTime() + ( days * 24 * 60 * 60 * 1000 ) );
			var expires = "; expires=" + date.toGMTString();
			document.cookie = name + "=" + value + expires + "; path=/";
		}
		function eraseCookie( name ) {
			createCookie( name, "" ,-1 );
		}
		function getUrlParameter( key ) {
		   if( key = ( new RegExp( '[?&]' +encodeURIComponent( key ) + '=([^&]*)' ) ).exec( location.search ) )
		      return decodeURIComponent( key[1] );
		   else
			   return null;
		}
	
		Polymer({

			is: 'pratilipi-reader-page',
			
			properties: {
				userData: { type: Object },
				user: { type: Object, observer: "_userChanged" },
				pratilipi: { type: Object },
				userpratilipi: { type: Object },
				fontSize: { type: Number, notify: true },
				pageNo: { type: Number, observer: "_pageNoChanged", notify: true },
				pageCount: { type: Number },
				content: { type: String },
				contentMap: { type: Object, value: {} },
				index: { types: Array, value: [] },
				
				addedToLibrary: { type: String },
				addedToLib: { type: Boolean },
				addToLibClicked: { type: Boolean, value: false },

				goToLibraryBoolean: { type: Boolean, value: false },
				reviewButtonClicked: { type: Boolean, value: false },
				hideIndexButton: { type: Boolean, value: false },

				lastPage: { type: Boolean, value: false }
			},
			
			showPrevious: function() {
				this.setPageNo( this.pageNo - 1 );
			},
			
			showNext: function() {
				this.setPageNo( this.pageNo + 1 );
			},
			
			setPageNo: function( pageNo ) {
				if( pageNo != this.pageNo && pageNo >= 1 && pageNo <= this.pageCount )
					this.set( 'pageNo', parseInt( pageNo ) );
			},

			setFontSize: function( fontSize ) {
				fontSize = fontSize == null ? 14 : parseInt( fontSize );
				this.set( "fontSize", fontSize );
				setCookie( "fontSize", fontSize, 15 );
			},
			
			increaseFontSize: function() {
				var cutoff = 32;
				if( this.fontSize + 2 <= cutoff )
					this.setFontSize( this.fontSize + 2 );
			},
			
			decreaseFontSize: function() {
				var cutoff = 12;
				if( this.fontSize - 2 >= cutoff )
					this.setFontSize( this.fontSize - 2 );
			},
			
			redirectToWriterPanel: function() {
				window.location.href = this.pratilipi.writePageUrl +
					( this.pratilipi.writePageUrl.indexOf( "?" ) != -1 ? "&" : "?" ) + 
					"ret=" +
					( getUrlParameter( "ret" ) != null ? getUrlParameter( "ret" ) : this.pratilipi.pageUrl );
			},
			
			exitReader: function() {
				window.location.href = getUrlParameter( "ret" ) != null ? getUrlParameter( "ret" ) : this.pratilipi.pageUrl;
			},
			
			writeReview: function() {
				if( this.user.isGuest ) {
					this.reviewButtonClicked = true;
					document.querySelector( 'pratilipi-user' ).logIn( true );
				} else {
					this.querySelector( 'pratilipi-review-input' ).openReviewInput( this.userpratilipi );
				}
			},
			
			shareOnFacebook: function() {
				window.open( "http://www.facebook.com/sharer.php?u=" + "http://${ domain }/read?id=" + 
						this.pratilipi.pratilipiId, "share", "width=1100,height=500,left=70px,top=60px" );
			},
			
			shareOnTwitter: function() {
				window.open( "http://twitter.com/share?url=" + "http://${ domain }/read?id=" + 
						this.pratilipi.pratilipiId, "share", "width=1100,height=500,left=70px,top=60px" );
			},
			
			shareOnGplus: function() {
				window.open( "https://plus.google.com/share?url=" + "http://${ domain }/read?id=" + 
						this.pratilipi.pratilipiId, "share", "width=1100,height=500,left=70px,top=60px" );
			},
			
			updateUserPratilipi: function( userpratilipi ) {
				this.set( 'userpratilipi', userpratilipi );
			},
			
			ready: function() {
				jQuery( '#scrollToTop' ).css( "display", "none" );
				this.setFontSize( getCookie( "fontSize" ) );
				this.contentMap[ this.pageNo ] = this.content;
				this._precache();
				
				if( this.index != null )
					this.index = jQuery.parseJSON( this.index );

				if( typeof this.index == "string" )
					this.index = JSON.parse( this.index );
				
				if( this.index == null || this.index.length == 0 )
					this.set( 'hideIndexButton', true );

				this.set( 'addedToLib', this.addedToLibrary == "true" ? true : false );
				this.set( 'lastPage', this.pageNo == this.pageCount ? true : false );
			},
			
			_precache: function() {
				// Check pageNo
				if( this.pageNo > 1 )
					this._loadContent( this.pageNo - 1 );
				if( this.pageNo < this.pageCount )
					this._loadContent( this.pageNo + 1 );
			},

			_pageNoChanged: function() {
				// Called before ready function
				if( this.contentMap == null || jQuery.isEmptyObject( this.contentMap ) )
					return;
				
				if( !this.lastPage && this.pageNo == this.pageCount )
					this.set( 'lastPage', true );
				else if( this.lastPage && this.pageNo != this.pageCount )
					this.set( 'lastPage', false );
				
				if( this.contentMap[ this.pageNo ] != null )	// Check in Map if exists
					this.set( 'content', this.contentMap[ this.pageNo ] );
				else {											// Else make api call
					this.set( 'content', "<paper-spinner class=\"pratilipi-spinner-center\" active></paper-spinner>" );
					this._loadContent( this.pageNo );
				}								
				
				this._precache();								// Load Previous and next pages
				
			},
			
			_loadContent: function( pageNo ) {

				if( pageNo == null || this.contentMap[ pageNo ] != null )
					return;
				
				var ajaxGet = this.$.AjaxGet;
				ajaxGet.params.pratilipiId = this.pratilipi.pratilipiId;
				ajaxGet.params.chapterNo = pageNo;
				ajaxGet.params.pageNo = pageNo;
				ajaxGet.generateRequest();
			},
			
			_onResponse: function( event ) {
				
				var response = event.detail.response;

				// Populate map
				this.contentMap[ response.pageNo ] = response.pageContent;
				
				// Update content if response page no == this page no
				if( this.pageNo == response.pageNo )
					this.set( 'content', response.pageContent );
			},
			
			_onError: function( event ) {
				// Show appropriate message
				/* alert( "Sorry! Some exception occured at the server! Try again" ); */
				// Try again in 3 seconds
			},
			
			_userChanged: function() {
				
				if( this.user.isGuest )
					return;
				
				if( this.addToLibClicked ) {
					this.addToLibClicked = false;
					this.async( function() { this.addToLibrary(); }, 1500 );
				} else if( this.goToLibraryBoolean ) {
					this.goToLibrary();
				} else if( this.reviewButtonClicked ) {
					// Load UserPratilipi
					var getUserPratilipi = this.$.GetUserPratilipi;
					getUserPratilipi.params.pratilipiId = this.pratilipi.pratilipiId;
					getUserPratilipi.generateRequest();
				}
			},
			
			_getUserPratilipiResponse: function( event ) {
				this.reviewButtonClicked = false;
				this.set( 'userpratilipi', event.detail.response );
				this.writeReview();
			},
			
			_getUserPratilipiError: function( event ) {
				this.async( function() { this._userChanged(); }, 3000 );
			},
			
			addToLibrary: function() {
				if( this.user.isGuest ) {
					this.addToLibClicked = true;
					document.querySelector( 'pratilipi-user' ).logIn( true );
				} else {
					this.$.AjaxPost.body = ( "pratilipiId=" + this.pratilipi.pratilipiId + "&" + "addedToLib=true" );
					this.$.AjaxPost.generateRequest();
				}
			},
			
			removeFromLibrary: function() {
				this.$.AjaxPost.body = ( "pratilipiId=" + this.pratilipi.pratilipiId + "&" + "addedToLib=false" );
				this.$.AjaxPost.generateRequest();
			},
			
			goToLibrary: function() {
				if( this.user.isGuest ) {
					this.goToLibraryBoolean = true;
					document.querySelector( 'pratilipi-user' ).logIn( true );
				} else {
					window.location.href = "/library";
				}
			},
			
			_handleAjaxPostResponse: function( event ) {
				if( event.detail.xhr.status != 200 )
					this._handleAjaxPostError( event );
				else {
					this.set( 'addedToLib', Boolean( event.detail.response.addedToLib ) );
					document.querySelector( 'pratilipi-alert' ).alert( event.detail.response.addedToLib ? 
							"${ _strings.added_to_library }" : "${ _strings.removed_from_library }" );
				}
			},
			
			_handleAjaxPostError: function( event ) {
				document.querySelector( 'pratilipi-alert' ).alert( "Sorry, Some error happened while adding/removing to/from library! Please try again.", false );
			},
			
			scrollHandler: function( st ) {},

			keyupHandler: function( keyCode ) {
				
				if( keyCode == null )
					return;
				
				if( this.querySelector( 'pratilipi-reader-footer' ).isInputFocused() )
					return;
				
				// Left
				if( parseInt( keyCode ) == 37 ) {
					this.showPrevious();
				}
				// Right
				else if( parseInt( keyCode ) == 39 ) { 
					this.showNext();
				}
			}
			
		});
	</script>

</dom-module>
<#include "pratilipi-reader-header.html">
<#include "pratilipi-reader-content.html">
<#include "pratilipi-reader-footer.html">
<#include "pratilipi-review-input.html">

<dom-module id="pratilipi-reader-page">

	<template>
		<header>
    		<pratilipi-reader-header 
    				pratilipi="{{ pratilipi }}"
    				has-access-to-update="[[ pratilipi.hasAccessToUpdate ]]"
    				added-to-lib="[[ addedToLib ]]"
    				hide-index-button="[[ hideIndexButton ]]"
    				page-no="[[ pageNo ]]"
    				index="{{ index }}"
    				content-type="{{ contentType }}"></pratilipi-reader-header>
		</header>
		<pratilipi-user user='{{ user }}' user-data="[[ userData ]]"></pratilipi-user>
		<pratilipi-alert></pratilipi-alert>
		<pratilipi-review-input pratilipi="[[ pratilipi ]]"></pratilipi-review-input>
		<div style="margin-top: 70px;">
			<div class="parent-container">
				<div class="container" style="margin: 0 auto;">
					<div style="overflow:hidden;">
						<pratilipi-reader-content
							content-type="{{ contentType }}"
							content="{{ content }}"
							font-size="{{ fontSize }}"
							page-no="{{ pageNo }}"
							page-count="{{ pageCount }}"
							pratilipi-id="{{ pratilipi.pratilipiId }}"></pratilipi-reader-content>
					</div>
				</div>
			</div>
		</div>
		<footer>
    		<pratilipi-reader-footer
    			page-no="[[ pageNo ]]"
    			page-count="{{ pageCount }}"></pratilipi-reader-footer>
    		<pratilipi-footer></pratilipi-footer>
		</footer>
		<iron-ajax
				id="AjaxPost"
				url="/api/userpratilipi/library"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
		<iron-ajax
				id="GetUserPratilipi"
				url="/api/userpratilipi"
				method="GET"
				content-type="application/json"
				handle-as="json"
				on-response="_getUserPratilipiResponse"
				on-error="_getUserPratilipiError"
				></iron-ajax>
	</template>

	<script>
		function getUrlParameter( key ) {
		   if( key = ( new RegExp( '[?&]' +encodeURIComponent( key ) + '=([^&]*)' ) ).exec( location.search ) )
		      return decodeURIComponent( key[1] );
		   else
			   return null;
		}
	
		Polymer({

			is: 'pratilipi-reader-page',
			
			properties: {
				userData: { type: Object },
				user: { type: Object, observer: "_userChanged" },
				pratilipi: { type: Object },
				userpratilipi: { type: Object },
				addedToLib: { type: Boolean },
				
				fontSize: { type: Number },
				pageNo: { type: Number },
				pageCount: { type: Number },
				contentType: { type: String },
				content: { types: String },
				index: { types: Array, value: [] },
				
				addToLibClicked: { type: Boolean, value: false },
				goToLibraryBoolean: { type: Boolean, value: false },
				reviewButtonClicked: { type: Boolean, value: false },
				hideIndexButton: { type: Boolean, value: false },
				
			},
			
			// Ready function
			ready: function() {
				if( this.index != null )
					this.index = jQuery.parseJSON( this.index );
				if( typeof this.index == "string" )
					this.index = JSON.parse( this.index );
				if( this.index == null || this.index.length == 0 )
					this.set( 'hideIndexButton', true );

				this.set( 'addedToLib', this.userpratilipi != null ? this.userpratilipi.addedToLib : false );
			},
			
			
			// Setting Page Number
			setPageNo: function( pageNo ) {
				if( pageNo != this.pageNo && pageNo >= 1 && pageNo <= this.pageCount ) {
					this.set( 'pageNo', parseInt( pageNo ) );
					//Set cookie
					setCookie( "reader_page_number_" + this.pratilipi.pratilipiId, pageNo, 30, "/read" );
				}
			},
			
			showPrevious: function() {
				this.setPageNo( this.pageNo - 1 );
			},
			
			showNext: function() {
				this.setPageNo( this.pageNo + 1 );
			},
			
			keyupHandler: function( keyCode ) {
				// paper-slider active
				if( this.querySelector( 'pratilipi-reader-footer' ).isInputFocused() )
					return;
				// Left - 37 ; Right - 39
				if( parseInt( keyCode ) == 37 )
					this.showPrevious();
				else if( parseInt( keyCode ) == 39 ) 
					this.showNext();
			},
			
			
			// Review and Share
			writeReview: function() {
				if( this.user.isGuest ) {
					this.reviewButtonClicked = true;
					document.querySelector( 'pratilipi-user' ).logIn( true );
				} else {
					this.querySelector( 'pratilipi-review-input' ).openReviewInput( this.userpratilipi );
				}
			},
			
			shareOnFacebook: function( pos ) {
				window.open( "http://www.facebook.com/sharer.php?u=" + "http://${ domain }" + this.pratilipi.pageUrl 
						+ ( this.pratilipi.pageUrl.indexOf( '?' ) == -1 ? '?' : '&' )
						+ "share=facebook" + ( pos != null ? "&pos=" + pos : "" ), 
						"share", "width=1100,height=500,left=70px,top=60px" );
			},
			
			shareOnTwitter: function( pos ) {
				window.open( "http://twitter.com/share?url=" + "http://${ domain }" + this.pratilipi.pageUrl 
						+ ( this.pratilipi.pageUrl.indexOf( '?' ) == -1 ? '?' : '&' )
						+ "share=twitter" + ( pos != null ? "&pos=" + pos : "" ),
						"share", "width=1100,height=500,left=70px,top=60px" );
			},
			
			shareOnGplus: function( pos ) {
				window.open( "https://plus.google.com/share?url=" + "http://${ domain }" + this.pratilipi.pageUrl 
						+ ( this.pratilipi.pageUrl.indexOf( '?' ) == -1 ? '?' : '&' )
						+ "share=gplus" + ( pos != null ? "&pos=" + pos : "" ),
						"share", "width=1100,height=500,left=70px,top=60px" );
			},
			
			
			// Library
			_userChanged: function() {
				if( this.user.isGuest )
					return;
				if( this.addToLibClicked ) {
					this.addToLibClicked = false;
					this.async( function() { this.addToLibrary(); }, 1500 );
				} else if( this.goToLibraryBoolean ) {
					this.goToLibraryBoolean = false;
					this.goToLibrary();
				} else if( this.reviewButtonClicked ) {
					// Load UserPratilipi
					var getUserPratilipi = this.$.GetUserPratilipi;
					getUserPratilipi.params.pratilipiId = this.pratilipi.pratilipiId;
					getUserPratilipi.generateRequest();
				}
			},
			
			updateUserPratilipi: function( userpratilipi ) {
				this.set( 'userpratilipi', userpratilipi );
			},
			
			_getUserPratilipiResponse: function( event ) {
				this.reviewButtonClicked = false;
				this.updateUserPratilipi( event.detail.response );
				this.writeReview();
			},
			
			_getUserPratilipiError: function( event ) {
				this.async( function() { this._userChanged(); }, 3000 );
			},
			
			addToLibrary: function() {
				if( this.user.isGuest ) {
					this.addToLibClicked = true;
					document.querySelector( 'pratilipi-user' ).logIn( true );
				} else {
					this.$.AjaxPost.body = ( "pratilipiId=" + this.pratilipi.pratilipiId + "&" + "addedToLib=true" );
					this.$.AjaxPost.generateRequest();
				}
			},
			
			removeFromLibrary: function() {
				this.$.AjaxPost.body = ( "pratilipiId=" + this.pratilipi.pratilipiId + "&" + "addedToLib=false" );
				this.$.AjaxPost.generateRequest();
			},
			
			_handleAjaxPostResponse: function( event ) {
				if( event.detail.xhr.status != 200 )
					this._handleAjaxPostError( event );
				else {
					this.set( 'addedToLib', Boolean( event.detail.response.addedToLib ) );
					document.querySelector( 'pratilipi-alert' ).alert( event.detail.response.addedToLib ? 
							"${ _strings.added_to_library }" : "${ _strings.removed_from_library }" );
				}
			},
			
			_handleAjaxPostError: function( event ) {
				document.querySelector( 'pratilipi-alert' ).alert( "Sorry, Some error happened while adding/removing to/from library! Please try again.", false );
			},
			
			goToLibrary: function() {
				if( this.user.isGuest ) {
					this.goToLibraryBoolean = true;
					document.querySelector( 'pratilipi-user' ).logIn( true );
				} else {
					window.location.href = "/library";
				}
			},
			
			
			// Reader functions
			redirectToWriterPanel: function() {
				window.location.href = this.pratilipi.writePageUrl +
					( this.pratilipi.writePageUrl.indexOf( "?" ) != -1 ? "&" : "?" ) + 
					"ret=" +
					( getUrlParameter( "ret" ) != null ? getUrlParameter( "ret" ) : this.pratilipi.pageUrl );
			},
			
			exitReader: function() {
				window.location.href = getUrlParameter( "ret" ) != null ? getUrlParameter( "ret" ) : this.pratilipi.pageUrl;
			},
			
			
			// Ignore this
			scrollHandler: function( st ) {},
			
		});
	</script>

</dom-module>
<link rel='import' href='pratilipi-navigation-drawer.html'>

<dom-module id="pratilipi-header">

	<style>
		paper-card {
			width: 100%;
			@apply(--layout-center);
		}
		
		.container, .container div {
			display: inline-block;
		}
		
		paper-input.search {
	        --paper-input-container-focus-color: #797979;
		}
		
		paper-icon-button.search-icon {
			margin-bottom: -5px;
			margin-right: -10px;
		}
		
		paper-icon-button.menu-icon {
			margin-bottom: -5px;
			margin-left: -10px;
		}
		
		paper-item {
			--paper-item-min-height: 40px;
			--paper-item-min-weight: 0px;
			--paper-item: {
				font-size: 13px;
				font-weight: 300;
				font-family: Helvetica,'Noto Sans Tamil', sans-serif;
				color: #333;
			};
		}
		
		paper-dropdown-menu {
			margin-top: -10px;
		}
		
		iron-icon {
			--iron-icon-height: 20px;
			--iron-icon-width: 20px;
		}
		
	</style>

	<template>
		<paper-card>
			<div class="parent-container"> 
				<div class="container">
					<table style="min-width: 100%; white-space: nowrap;">
						<tr>
							<td align="left" width="65px">
								<a href="/">
									<img style="padding-top: 5px; max-width: 60px;" title="${ _strings.pratilipi_logo }" alt="${ _strings.pratilipi_logo }" src="https://storage.googleapis.com/devo-pratilipi.appspot.com/Logo-for-Site-Header.png" />
								</a>
							</td>
							
							<template is="dom-if" if="{{ !mobile }}">
								<td width="90px">
									<a href="/">
										<img style= "padding-top: 5px; max-width: 90px;" title="${ _strings.pratilipi_logo }" alt="${ _strings.pratilipi_logo }" src="https://storage.googleapis.com/devo-pratilipi.appspot.com/Pratilipi-Text.png" />
									</a>
								</td>
							</template>
							
							<template is="dom-if" if="{{ medium }}">
								<td width="25px"></td>
							</template>
							
							<td width="auto">
								<form method="get" action="/search" style="margin: -20px 15px auto 10px;" id="form" on-submit="onSubmit">
									<template is="dom-if" if="{{ !mobile }}">
										<paper-input name="q" class="search" type="search" placeholder="${ _strings.search_bar_help }" onfocus="this.placeholder = ''" onblur="this.placeholder = '${ _strings.search_bar_help }'" value="{{ query::input }}">
											<paper-icon-button class="search-icon" suffix icon="search" noink="true" on-click="onSubmit"></paper-icon-button>
											<template is="dom-if" if="{{ !medium }}">
												<paper-icon-button class="menu-icon" prefix icon="menu" noink="true" on-click="showMenu"></paper-icon-button>
											</template>
										</paper-input>
									</template>
									<template is="dom-if" if="{{ mobile }}">
										<paper-input name="q" class="search" type="search" placeholder="${ _strings.search }" onfocus="this.placeholder = ''" onblur="this.placeholder = '${ _strings.search }'" value="{{ query::input }}">
											<paper-icon-button class="search-icon" suffix icon="search" noink="true"></paper-icon-button>
											<paper-icon-button class="menu-icon" prefix icon="menu" noink="true" on-click="showMenu"></paper-icon-button>
										</paper-input>
									</template>
								</form>
							</td>
							
							<td align="right" width="85px">
								<template is="dom-if" if="{{ user.isGuest }}">
									<button type="button" class="pratilipi-white-button" on-click="logInButtonClicked"><small>${ _strings.sign_in }</small></button>
								</template>
								<template is="dom-if" if="{{ !user.isGuest }}">
									<paper-dropdown-menu noink="true" label="{{ user.displayName }}">
										<div class="dropdown-content" style="white-space: nowrap; width: auto;">
											<paper-item on-click="myProfile">
												<paper-icon-item><iron-icon style="color: #107FE5;" icon="description"></iron-icon></paper-icon-item>
												&nbsp;&nbsp;
												<paper-item-body>My Profile</paper-item-body>
											</paper-item>
											<paper-item on-click="myAccount">
												<paper-icon-item><iron-icon style="color: #107FE5;" icon="account-circle"></iron-icon></paper-icon-item>
												&nbsp;&nbsp;
												<paper-item-body>My Account</paper-item-body>
											</paper-item>
											<paper-item on-click="logOut">
												<paper-icon-item><iron-icon style="color: #D0021B;" icon="remove-circle"></iron-icon></paper-icon-item>
												&nbsp;&nbsp;
												<paper-item-body>${ _strings.sign_out }</paper-item-body>
											</paper-item>
										</div>
									</paper-dropdown-menu>
								</template>
							</td>

							
							<template is="dom-if" if="{{ !container }}">
								<template is="dom-if" if="{{ !mobile }}">
									<td width="10px"></td>
									<td width="85px">
										<button type="button" class="pratilipi-dark-blue-button" on-click="write"><iron-icon style="margin-top: -5px;" icon="create"></iron-icon>&nbsp;${ _strings.write }</button>
									</td>
								</template>
							</template>
						</tr>
					</table>
				</div>
				
				<template is="dom-if" if="{{ !mobile }}">
					<template is="dom-if" if="{{ container }}">
						<div style="position: absolute; display: inline-block; top: 12px; margin-left: 12px;">
							<button type="button" class="pratilipi-dark-blue-button" on-click="write"><iron-icon style="margin-top: -5px;" icon="create"></iron-icon>&nbsp;${ _strings.write }</button>
						</div>
					</template>
				</template>
			</div>
		</paper-card>
		
		<!-- Navigation & Search bar for extra-small & small screens. -->
		<div class="hidden-md hidden-lg">
			<pratilipi-navigation-drawer with-backdrop></pratilipi-navigation-drawer>
		</div>
		
		<div class="modal fade" id="myAccount" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					
					<div class="modal-header">
						<span>Edit My Account</span>
						<span style="float: right;"><paper-icon-button style="margin-top: -10px; margin-right: -10px;" noink="true" icon="close" data-dismiss="modal"></paper-icon-button></span>
					</div>
					
					<div class="modal-body">
						<paper-input noink always-float-label disabled label="Email" value="{{ user.email }}" ></paper-input>
						
						<div class="row" style="margin-top: 15px;">
							<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
								<template is="dom-if" if="{{ ! user.isEmailVerified }}">
									<button style="margin: 0 auto; display: block;" class="pratilipi-new-blue-button" on-click="verifyEmail">Verify Email</button>
								</template>
								<template is="dom-if" if="{{ user.isEmailVerified }}">
									<iron-icon style="color: #107FE5; width: 32px; height: 32px;" icon="check-circle"></iron-icon>
									<h6 style="display: inline-block;">Email Verified!</h6>
								</template>
							</div>
							<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
								<button style="margin: 0 auto; display: block;" class="pratilipi-new-blue-button" on-click="changePassword"> Change Password </button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		
	</template>


	<script>

		Polymer({
			
			is: 'pratilipi-header',
			
			behaviors: [
				Polymer.IronResizableBehavior
			],
			
			listeners: {
				'iron-resize': '_onIronResize'
			},
			
			properties: {
				user: { type: Object, notify: true, observer: "_userChanged" },
				query: { type: String },
				
				writeButtonActive: { type: Boolean, value: false },
				
				/* Screen sizes */
				mobile: { type: Boolean },
				container: { type: Boolean },
				medium: { type: Boolean }
			},
			
			myAccount: function() {
				jQuery( "#myAccount" ).modal();
			},
			
			changePassword: function() {
				jQuery( "#myAccount" ).modal( 'hide' );
				document.querySelector( 'pratilipi-user' ).changePassword();
			},
			
			verifyEmail: function() {
				jQuery( "#myAccount" ).modal( 'hide' );
				document.querySelector( 'pratilipi-user' ).sendVerificationMail();
			},
			
			myProfile: function() {
				// Redirect to MyProfile Page
				if( this.user.profilePageUrl != null && window.location != "http://" + window.location.host + this.user.profilePageUrl )
					window.location.href = "http://" + window.location.host + this.user.profilePageUrl; 
			},
			
			_userChanged: function() {
				if( ! this.user.isGuest && this.writeButtonActive ) {
					this.async( function() {
						this.write();
					}, 1000 );
				}
			},
			
			write: function() {
				if( this.user.isGuest ) {
					this.writeButtonActive = true;
					document.querySelector( 'pratilipi-user' ).logIn();
				}
				else {
					this.writeButtonActive = false;
					document.querySelector( 'pratilipi-write' ).open();
				}
			},
			
			showMenu: function() {
				this.querySelector( 'pratilipi-navigation-drawer' ).show();
			},
			
			logInButtonClicked: function() {
				this.writeButtonActive = false;
				document.querySelector( 'pratilipi-user' ).logIn();
			},
			
			logOut: function() {
				document.querySelector( 'pratilipi-user' ).logOut();
			},
			
			_onIronResize: function() {
				var windowsize = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
				
				if( windowsize > 600 )
					this.mobile = false;
				else
					this.mobile = true;

				if( windowsize > 1100 )
					this.container = true;
				else
					this.container = false;
				
				if( windowsize > 991 )
					this.medium = true;
				else
					this.medium = false;
					
			},
			
			ready: function() {
			    var reParam = new RegExp( '(?:[\?&]|&)q=([^&]+)', 'i' );
			    var match = window.location.search.match( reParam ) ;
			    if( match && match.length > 1 )
			    	this.query = decodeURIComponent( match[ 1 ] ).split("+").join(" ");;
			},
			
			onSubmit: function( event ) {
				var searchResult = jQuery( '#SearchResult' )[0];
				if( searchResult != null ) {
					jQuery( searchResult ).attr( 'search-query', this.query.trim() );
					searchResult.reset();
					event.preventDefault();
				} else if( this.query == undefined || this.query.trim() == '' ) {
					event.preventDefault();
				} else {
					this.query = this.query.trim();
				}
			},

		});

	</script>

</dom-module>
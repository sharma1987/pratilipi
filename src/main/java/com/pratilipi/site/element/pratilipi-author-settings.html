<dom-module id="pratilipi-author-settings">

	<style>

		:host {
			display: block;
		}

		textarea {
			display: block;
			width: 100%;
		}

		paper-dropdown-menu {
			width: 100%;
			--paper-dropdown-menu-focus-color: #107FE5;
			--paper-dropdown-menu-input-color: #333;
			--paper-input-container-input: {
				font-family: Helvetica,'Noto Sans Tamil', sans-serif;
			};
			--paper-input-container-underline: {
				background: #107FE5;
			};
			--paper-input-container-label: {
				font-size: 15px;
				font-family: Helvetica,'Noto Sans Tamil', sans-serif;
				text-align: left;
				color: #107FE5;
			};
		}

		paper-menu {
			--paper-menu-color: #333;
			width: 100%;
			--paper-menu-focused-item: {
				color: #107FE5;
			};
		}

		paper-menu paper-item {
			font-size: 15px;
			font-family: Helvetica,'Noto Sans Tamil', sans-serif;
			color: #333;
			white-space: nowrap;
		}

		.row {padding-left: 10px;padding-right: 10px;}
		.modal-fullscreen .modal-dialog .modal-content {max-width: 768px;padding-top:5px;}
	</style>

	<template>
		<div class="modal modal-fullscreen fade" id="pratilipiAuthorSettings" role="dialog" tabindex="-1">
			<div class="modal-dialog" role="document">
				<div class="modal-content">

					<div class="modal-fullscreen-close-button">
						<paper-icon-button noink icon="close" data-dismiss="modal"></paper-icon-button>
					</div>

					<img title="${ _strings.pratilipi }" alt="${ _strings.pratilipi }" src="http://0.ptlp.co/resource-${ lang }/logo/pratilipi_logo.png" />

					<div class="row">
						<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
							<pratilipi-input label="${ _strings.edit_author_first_name }" value="{{ firstName::input }}"></pratilipi-input>
						</div>
						<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
							<pratilipi-input label="${ _strings.edit_author_last_name }" value="{{ lastName::input }}"></pratilipi-input>
						</div>
						<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
							<pratilipi-input label="${ _strings.edit_author_first_name_en }" value="{{ firstNameEn::input }}"></pratilipi-input>
						</div>
						<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
							<pratilipi-input label="${ _strings.edit_author_last_name_en }" value="{{ lastNameEn::input }}"></pratilipi-input>
						</div>
						<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
							<pratilipi-input label="${ _strings.edit_author_pen_name }" value="{{ penName::input }}"></pratilipi-input>
						</div>
						<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
							<pratilipi-input label="${ _strings.edit_author_pen_name_en }" value="{{ penNameEn::input }}"></pratilipi-input>
						</div>
						<div class="col-xs-12 col-sm-4 col-md-4 col-lg-4">
							<paper-input class="pratilipi-blue" type="date" label="${ _strings.edit_author_birthday_ddmmyyyy }" always-float-label value="{{ dateOfBirth::input }}"></paper-input>
						</div>
						<div class="col-xs-12 col-sm-4 col-md-4 col-lg-4">
							<paper-dropdown-menu id="authorGender" noink label="Gender" value="{{ gender::input }}">
								<paper-menu noink selected="[[ selectedGender ]]" class="dropdown-content" style="white-space: nowrap; width: auto;">
									<paper-item value="MALE">${ _strings.gender_male }</paper-item>
									<paper-item value="FEMALE">${ _strings.gender_female }</paper-item>
									<paper-item value="OTHER">${ _strings.gender_other }</paper-item>
								</paper-menu>
							</paper-dropdown-menu>
						</div>
						<div class="col-xs-12 col-sm-4 col-md-4 col-lg-4">
							<paper-dropdown-menu id="authorLanguage" noink label="${ _strings.edit_author_language }">
								<paper-menu noink selected="[[ selectedLanguage ]]" class="dropdown-content" style="white-space: nowrap; width: auto;">
									<paper-item value="BENGALI">${ _strings.language_bn }</paper-item>
									<paper-item value="GUJARATI">${ _strings.language_gu }</paper-item>
									<paper-item value="HINDI">${ _strings.language_hi }</paper-item>
									<paper-item value="MALAYALAM">${ _strings.language_ml }</paper-item>
									<paper-item value="MARATHI">${ _strings.language_mr }</paper-item>
									<paper-item value="TAMIL">${ _strings.language_ta }</paper-item>
									<paper-item value="TELUGU">${ _strings.language_te }</paper-item>
									<paper-item value="KANNADA">${ _strings.language_kn }</paper-item>
								</paper-menu>
							</paper-dropdown-menu>
						</div>
						<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
							<div style="margin-top: 25px; margin-bottom: 5px; text-align: left;"><span class="pratilipi-blue" style="font-size: 14px;">${ _strings.edit_author_summary }</span></div>
							<textarea rows="10" value="{{ summary::input }}"></textarea>
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<div class="display-message-div"><p>{{ message }}</p></div>
				<button id="authorSaveChangesButton" style="position: fixed; bottom: 15px; right: 15px;" class="pratilipi-dark-blue-button" type="button" on-click="onSubmit">${ _strings.edit_author_save_changes }</button>
			</div>
		</div>
		<iron-ajax
				id="AuthorApi"
				url="/api/author"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_authorApiResponse"
				on-error="_authorApiError"
				></iron-ajax>
	</template>

	<script>
		function updateObject( o1, o2 ) {
			if( o2 == null || typeof(o2) != 'object' ) return o2;
			for( var key in o2 ) {
				if( o1[key] == null ) o1[key] = new o2[key].constructor()
				o1[key] = updateObject( o1[key], o2[key] );
			}
			return o1;
		}
		Polymer({

			is: 'pratilipi-author-settings',

			properties: {
				author: { type: Object },

				// Specific to input fields
				authorId: { type: String },
				firstName: { type: String },
				lastName: { type: String },
				penName: { type: String },
				firstNameEn: { type: String },
				lastNameEn: { type: String },
				penNameEn: { type: String },
				gender: { type: String },
				dateOfBirth: { type: String },
				language: { type: String },
				summary: { type: String },

				// Specific to the modal
				selectedLanguage: { type: Number },
				selectedGender: { type: Number },
 				message: { type: String }
			},

			_processDateOfBirth: function( input ) {
				var datePart = input.match(/\d+/g);
				if( parseInt( datePart[0] ) < 1800 ) return input;
				var year = datePart[0], month = datePart[1], day = datePart[2];
				return day+'-'+month+'-'+year;
			},

			_setDateProcess: function( input ) {
				var date = input.split( "-" );
				if( date[2] > 1800 ) return date[2] + "-" + date[1] + "-" + date[0];
				return input;
			},

			process: function( author ) {
				this.message = null;
				this.authorId = author.authorId;
				this.firstName = author.firstName;
				this.lastName = author.lastName;
				this.penName = author.penName;
				this.firstNameEn = author.firstNameEn;
				this.lastNameEn = author.lastNameEn;
				this.penNameEn = author.penNameEn;
				this.dateOfBirth = author.dateOfBirth == null ? null : this._setDateProcess( author.dateOfBirth );
				this.summary = author.summary;				

				// paper-dropdown-menu for language
				this.language = author.language == null ? "${ language?upper_case }" : author.language;
				this.selectedLanguage = null;
				if( this.language == "BENGALI" )
					this.selectedLanguage = 0;
				else if( this.language == "GUJARATI" )
					this.selectedLanguage = 1;
				else if( this.language == "HINDI" )
					this.selectedLanguage = 2;
				else if( this.language == "MALAYALAM" )
					this.selectedLanguage = 3;
				else if( this.language == "MARATHI" )
					this.selectedLanguage = 4;
				else if( this.language == "TAMIL" )
					this.selectedLanguage = 5;
				else if( this.language == "TELUGU" )
					this.selectedLanguage = 6;
				else if( this.language == "KANNADA" )
					this.selectedLanguage = 7;

				// paper-dropdown-menu for language
				this.gender = author.gender == null ? null : author.gender.toUpperCase();
				this.selectedGender = null;
				if( this.gender == "MALE" )
					this.selectedGender = 0;
				else if( this.gender == "FEMALE" )
					this.selectedGender = 1; 
				else if( this.gender == "OTHER" )
					this.selectedGender = 2;
			},

			editAuthor: function() {
				this.process( this.author );
				this.async( function() {
					jQuery( "#pratilipiAuthorSettings" ).modal();
				});
			},

			close: function() {
				jQuery( "#pratilipiAuthorSettings" ).modal( 'hide' );
			},

			onSubmit: function( event ) {
				/* Mandatory fields */
				if( ( this.firstName == null || this.firstName.trim() == "" ) 
					&& ( this.firstNameEn == null || this.firstNameEn.trim() == "" ) ) {
					this.message = "Please enter the first name!";
					return;
				}
				if( this.$.authorLanguage.selectedItem == null ) {
					this.message = "Please enter your preferred Language!";
					return;
				}

				this.message = "${ _strings.working }";
				jQuery( '#authorSaveChangesButton' ).prop( 'disabled', true );

				this.language = this.$.authorLanguage.selectedItem.getAttribute( "value" );
				if( this.$.authorGender.selectedItem )
					this.gender = this.$.authorGender.selectedItem.getAttribute( "value" );

				var body = {
						authorId: this.authorId,
						language: this.language,
						summary: this.summary
				};

				if( this.firstName != null ) body.firstName = this.firstName;
				if( this.lastName != null ) body.lastName = this.lastName;
				if( this.penName != null ) body.penName = this.penName;
				if( this.firstNameEn != null ) body.firstNameEn = this.firstNameEn;
				if( this.lastNameEn != null ) body.lastNameEn = this.lastNameEn;
				if( this.penNameEn != null ) body.penNameEn = this.penNameEn;
				if( this.gender != null ) body.gender = this.gender;
				if( this.dateOfBirth != null ) body.dateOfBirth = this._processDateOfBirth( this.dateOfBirth );

				this.$.AuthorApi.body = jQuery.param( body );
				this.$.AuthorApi.generateRequest();				
			},

			_authorApiResponse: function( event ) {
				this.message = "${ _strings.updated_author_info_success }";
				jQuery( '#authorSaveChangesButton' ).prop( 'disabled', false );
				var author = updateObject( this.author, event.detail.response );
				this.domHost.updateAuthor( this.author, author );
				this.async( function() {
					this.message = null;
					this.close();
				}, 1000 );
			},

			_authorApiError: function( event ) {
				jQuery( '#authorSaveChangesButton' ).prop( 'disabled', false );
				this.message = event.detail.request.xhr.response.message != null ? 
						event.detail.request.xhr.response.message : "Some Error occurred! Please try Again.";   
			}

		});
	</script>
	
</dom-module>
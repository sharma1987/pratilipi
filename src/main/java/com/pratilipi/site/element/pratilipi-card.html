<link rel="import" href="pratilipi-rating.html">

<dom-module id="pratilipi-card">

	<style>
		
		paper-card {
			height: 200px;
			--paper-card-header: { display: none };
		}
		
		.pratilipi-card-heading, .pratilipi-card-heading:hover, .pratilipi-card-heading:focus {
			font-size: 16px;
			color: #D0021B;
		}
		
		.media {
			overflow: visible;
			min-width: 100%;
			padding: 10px;
		}
		
		.media-left img {
			width: 100px;
			height: 150px;
		}
		
	</style>


	<template>
		<paper-card>
			<div class="card-content">
				<div class="media">
					<div class="media-left">
						<a href="{{ pratilipi.pageUrl }}">
							<img class="media-object" src="{{ pratilipiCoverImage }}" alt="{{ pratilipi.title }}" title="{{ pratilipi.title }}"/>
						</a>
					</div>
				  	<div class="media-body">
				  		<h4 class="media-heading">
						 	<a class="pratilipi-card-heading" href="{{ pratilipi.pageUrl }}"  data-toggle="tooltip" data-placement="top" title="{{ pratilipi.title }}">{{ title }}</a>
						</h4>
						<h6>
							<a style="font-size: 12px; color: #434343; line-height: 20px;" href="{{ pratilipi.author.pageUrl }}">{{ pratilipi.author.name }}</a>
						</h6>
						<div>
							<pratilipi-rating value="{{ pratilipi.averageRating }}" />
							<span class="rating-text">&nbsp;({{ pratilipi.ratingCount }})</span>
						</div>
						<div style="position: absolute; bottom: 25px; display: inline-block;">
							<a on-click="redirectToReader" class="pratilipi-light-blue-button">${ _strings.read }</a>
							<template is="dom-if" if="{{ draftsActive }}">
								<a on-click="publishNow" class="pratilipi-light-blue-button">Publish Now!</a>
							</template>
							<template is="dom-if" if="{{ publishedActive }}">
								<a on-click="moveToDrafts" class="pratilipi-grey-button">Move to Drafts</a>
							</template>
						</div>
					</div>
				</div>
			</div>
		</paper-card>
		<iron-ajax
				id="AjaxPost"
				url="/api/pratilipi"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
	</template>


	<script>

		Polymer({

			is: 'pratilipi-card',
			
			behaviors: [
				Polymer.IronResizableBehavior
			],
          
			properties: {
				pratilipi: { type: Object },
				
				draftsActive: { type: Boolean, value: false },
				publishedActive: { type: Boolean, value: false }
			},
			
			listeners: {
				'iron-resize': '_onIronResize'
			},
			
			redirectToReader: function() {
				if( this.pratilipi.readPageUrl != null ) 
					window.location.href = "http://www.pratilipi.com/read?id=" + this.pratilipi.readPageUrl.substring( 6 ) + "&ret=" + window.location.href;
			},
			
			ready: function() {
				if( this.pratilipi.coverImageUrl.indexOf( '?' ) == -1 )
					this.pratilipiCoverImage = this.pratilipi.coverImageUrl + "?" + "width=100";
				else
					this.pratilipiCoverImage = this.pratilipi.coverImageUrl + "&" + "width=100";
			},
			
			attached: function() {
				$('[data-toggle="tooltip"]').tooltip();
			},
			
			_onIronResize: function() {
				// Adjusting heading
				var heading = jQuery( this.querySelector( '.pratilipi-card-heading' ) );
				this.title = this.pratilipi.title;
				heading.text( this.title );
				var len = this.title.length;
				while( heading.height() >= 24 && len > 20 ) {
					len = len - 1;
					heading.text( this.title.substring( 0, len - 3 ).trim() + " ..." );
				}
			},
			
			publishNow: function() {
				this.$.AjaxPost.body = ( "pratilipiId=" + this.pratilipi.pratilipiId + "&" + "state=PUBLISHED" );
				this.$.AjaxPost.generateRequest();
			},
			
			moveToDrafts: function() {
				this.$.AjaxPost.body = ( "pratilipiId=" + this.pratilipi.pratilipiId + "&" + "state=DRAFTED" );
				this.$.AjaxPost.generateRequest();
			},
			
			_handleAjaxPostResponse: function( event ) {
				
				var pratilipi = event.detail.response;
				
				// Move to Published Section if drafts is already active
				if( this.draftsActive ) {
					document.querySelector( 'pratilipi-author-books' ).addToPublishedList( pratilipi );
					document.querySelector( 'pratilipi-author-books' ).removeFromDraftedList( pratilipi );
					document.querySelector( 'pratilipi-author-books' ).publishedClicked();
				}
				// Move to Drafted Section if published is already active
				else if( this.publishedActive ) {
					document.querySelector( 'pratilipi-author-books' ).addToDraftedList( pratilipi );
					document.querySelector( 'pratilipi-author-books' ).removeFromPublishedList( pratilipi );
					document.querySelector( 'pratilipi-author-books' ).draftsClicked();
				}
				
			},
			
			_handleAjaxPostError: function( event ) {
				if( event.detail.request.xhr.status === 400 || event.detail.request.xhr.status === 401 || event.detail.request.xhr.status === 500 )
					alert( event.detail.request.xhr.response.message );
				else
					alert( "Some Error occured! Please try Again." );
			}
		});

	</script>

</dom-module>
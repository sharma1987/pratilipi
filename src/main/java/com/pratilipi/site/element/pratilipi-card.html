<link rel="import" href="pratilipi-rating.html">

<dom-module id="pratilipi-card">

	<style>
	
		:host {
			display: block;
		}
		
		paper-card {
			height: 200px;
			--paper-card-header: { display: none };
		}
		
		paper-menu {
			--paper-menu-color: #333;
			--paper-menu-focused-item: {
				color: #107FE5;
			};
		}
		
		paper-menu-button {
			position: absolute; 
			top: 0px; 
			right: 0px;
		}
		
		paper-icon-button {
			color: #333;
		}
		
		paper-item {
			cursor: pointer;
		}
		
	</style>


	<template>
		<paper-card>
				<div class="media pratilipi-card-media">
					
					<div class="media-left">
						<a href="{{ pratilipi.pageUrl }}">
							<img class="media-object pratilipi-card-image pratilipi-shadow" src="{{ pratilipiCoverImage }}" alt="{{ pratilipi.title }}" title="{{ pratilipi.title }}"/>
						</a>
					</div>
					
				  	<div class="media-body">
				  		<div class="contain-title ellipsed pratilipi-red" data-toggle="tooltip" data-placement="top" title="{{ pratilipi.title }}">
				  		 	<a class="pratilipi-card-heading pratilipi-red" href="{{ pratilipi.pageUrl }}">{{ title }}</a>
						</div>
						
						<template is="dom-if" if="{{ pratilipi.author }}">
							<h6><a class="pratilipi-card-author" href="{{ pratilipi.author.pageUrl }}">{{ pratilipi.author.name }}</a></h6>
						</template>
						
						<pratilipi-rating value="{{ pratilipi.averageRating }}">
							<span class="rating-text">&nbsp;({{ pratilipi.ratingCount }})</span>
						</pratilipi-rating>
						
						<template is="dom-if" if="{{ draftsActive }}">
							<paper-menu-button horizontal-align="right" class="pull-right">
								<paper-icon-button class="dropdown-trigger" icon="more-vert" noink="true"></paper-icon-button>
									<paper-menu class="dropdown-content">
										<paper-item on-click="redirectToReader">${ _strings.read }</paper-item>
									</paper-menu>
							</paper-menu-button>
						</template>

						<template is="dom-if" if="{{ publishedActive }}">
							<paper-menu-button horizontal-align="right" class="pull-right">
								<paper-icon-button class="dropdown-trigger" icon="more-vert" noink="true"></paper-icon-button>
									<paper-menu class="dropdown-content">
										<paper-item on-click="redirectToWriter">${ _strings.pratilipi_edit_content }</paper-item>
				                    	<paper-item on-click="moveToDrafts">${ _strings.pratilipi_move_to_drafts }</paper-item>
									</paper-menu>
							</paper-menu-button>
						</template>
						
						<div style="position: absolute; bottom: 25px; display: inline-block;">
							<template is="dom-if" if="{{ draftsActive }}">
								<a on-click="publishNow" class="pratilipi-light-blue-button">${ _strings.pratilipi_publish_it }</a>
								<br class="pratilipi-break" />
								<a on-click="redirectToWriter" class="pratilipi-light-blue-button">${ _strings.pratilipi_edit_content }</a>
							</template>
							<template is="dom-if" if="{{ ! draftsActive }}">
								<a on-click="redirectToReader" class="pratilipi-light-blue-button">${ _strings.read }</a>
							</template>
						</div>
						
					</div>
				</div>
		</paper-card>
		<iron-ajax
				id="AjaxPost"
				url="/api/pratilipi"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
	</template>


	<script>
	
		function getCookie( cname ) {
			var name = cname + "=";
			var ca = document.cookie.split( ';' );
			for( var i = 0; i < ca.length; i++ ) {
				var c = ca[i];
				while ( c.charAt(0)==' ' ) c = c.substring( 1 );
				if( c.indexOf( name ) == 0 ) return c.substring( name.length,c.length );
			}
			return "";
		}

		Polymer({

			is: 'pratilipi-card',
			
			properties: {
				pratilipi: { type: Object, observer: "init" },
				
				draftsActive: { type: Boolean, value: false, observer: "init" },
				publishedActive: { type: Boolean, value: false }
			},
			
			behaviors: [
				Polymer.IronResizableBehavior
			],
			
			listeners: {
				'iron-resize': '_onIronResize'
			},
			
			_onIronResize: function() {
				// titleWidth = width occupied by the title.
				var titleWidth = jQuery( this.querySelector( '.pratilipi-card-heading' ) ).width();
				// maxWidth = width of the card - image - padding.
				var maxWidth = jQuery( this ).width() - 130;
				
				// Setting the minimum of two to the card heading.
				jQuery( this.querySelector( '.contain-title' ) ).width( Math.min( titleWidth, maxWidth ) );
			},
			
			redirectToReader: function() {
				if( this.pratilipi.readPageUrl != null ) 
					window.location.href = "http://www.pratilipi.com/read?id=" + this.pratilipi.pratilipiId + "&ret=" + window.location.href + "&accessToken=" + getCookie( "access_token" );
			},
			
			redirectToWriter: function() {
				window.location.href = "http://www.pratilipi.com/write?id=" + this.pratilipi.pratilipiId + "&ret=" + window.location.href + "&accessToken=" + getCookie( "access_token" );
			},
			
			attached: function() {
				this.init();
				$('[data-toggle="tooltip"]').tooltip();
				this.async( function() {
					window.dispatchEvent( new Event( 'resize' ) );
				}, 2000 );
			},
			
			init: function() {
				if( this.pratilipi == null )
					return;
				
				if( this.pratilipi.coverImageUrl.indexOf( '?' ) == -1 )
					this.pratilipiCoverImage = this.pratilipi.coverImageUrl + "?" + "width=100";
				else
					this.pratilipiCoverImage = this.pratilipi.coverImageUrl + "&" + "width=100";
				
				this.title = this.pratilipi.title;
				jQuery( this.querySelector( '.contain-title' ) ).width( jQuery( this ).width() - 130 );
				this.async( function() {
					window.dispatchEvent( new Event( 'resize' ) );
				}, 1000 );
			},
			
			publishNow: function() {
				this.$.AjaxPost.body = ( "pratilipiId=" + this.pratilipi.pratilipiId + "&" + "state=PUBLISHED" );
				this.$.AjaxPost.generateRequest();
			},
			
			moveToDrafts: function() {
				this.$.AjaxPost.body = ( "pratilipiId=" + this.pratilipi.pratilipiId + "&" + "state=DRAFTED" );
				this.$.AjaxPost.generateRequest();
			},
			
			_handleAjaxPostResponse: function( event ) {
				
				var pratilipi = event.detail.response;
				
				// Move to Published Section if drafts is already active
				if( this.draftsActive ) {
					document.querySelector( 'pratilipi-author-books' ).addToPublishedList( pratilipi );
					document.querySelector( 'pratilipi-author-books' ).removeFromDraftedList( pratilipi );
					document.querySelector( 'pratilipi-author-books' ).publishedClicked();
				}
				// Move to Drafted Section if published is already active
				else if( this.publishedActive ) {
					document.querySelector( 'pratilipi-author-books' ).addToDraftedList( pratilipi );
					document.querySelector( 'pratilipi-author-books' ).removeFromPublishedList( pratilipi );
					document.querySelector( 'pratilipi-author-books' ).draftsClicked();
				}
				
			},
			
			_handleAjaxPostError: function( event ) {
				if( event.detail.request.xhr.status === 400 || event.detail.request.xhr.status === 401 || event.detail.request.xhr.status === 500 )
					alert( event.detail.request.xhr.response.message );
				else
					alert( "Some Error occured! Please try Again." );
			}
		});

	</script>

</dom-module>
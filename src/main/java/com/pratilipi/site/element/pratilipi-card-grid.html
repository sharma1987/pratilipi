<link rel="import" href="pratilipi-card.html" />

<dom-module id="pratilipi-card-grid">

	<style>
		
		:host {
			display: block;
		}

		.secondary-500 {
			padding: 10px;
		}
		
		.secondary-500 h3 {
			margin: 0px;
			padding: 10px;
		}

	</style>

	
	<template>

		<div class="secondary-500">
			<template is="dom-if" if="{{ heading }}">
				<h3>{{ heading }}</h3>
			</template>
			<div>
				<template is="dom-repeat" items="{{ pratilipiList }}" as="pratilipi">
					<pratilipi-card pratilipi="{{ pratilipi }}"></pratilipi-card>
				</template>
			</div>
		</div>

		<iron-ajax
				url="/api/pratilipi/list"
				method="GET"
				params="{{ filter }}"
				content-type="application/json"
				handle-as="json"
				on-response="_handleAjaxGetResponse"
				on-error="_handleAjaxGetError"
				></iron-ajax>

	</template>


	<script>

		Polymer({
			
			is: 'pratilipi-card-grid',

			properties: {
				heading: { type: String },
				pratilipiList: { type: Array },
				searchQuery: { type: String },
				filter: { type: Object },
				cursor: { type: String },

				isLoading: { type: Boolean, value: false },
				isFinished: { type: Boolean, value: false }
			},
			
			reset: function() {
				var ajaxGet = document.querySelector( 'iron-ajax' );

				if( ajaxGet.lastRequest )
					ajaxGet.lastRequest.abort();
				this.pratilipiList = [];

				ajaxGet.params.searchQuery = this.searchQuery;
				ajaxGet.params.cursor = null;
				ajaxGet.generateRequest();

				this.isLoading = true;
				this.isFinished = false;
			},
			
			loadMore: function() {
				if( this.isLoading || this.isFinished )
					return;

				var reqHeight = jQuery( window ).scrollTop()
						- jQuery( this ).position().top
						+ jQuery( window ).height()
						+ 3 * jQuery( window ).height();
		
				if( jQuery( this ).outerHeight( true ) >= reqHeight )
					return;
				
				document.querySelector( 'iron-ajax' ).generateRequest();
				this.isLoading = true;
			},
			
			_handleAjaxGetResponse: function(  request ) {
				if( ! request.detail.response ) {
					this.isLoading = false;
					return;
				}
				
				var pratilipiList = request.detail.response.pratilipiList;
				for( var i = 0; i < pratilipiList.length; i++ )
					this.push( 'pratilipiList', pratilipiList[ i ] );

				if( request.detail.response.cursor ) {
					document.querySelector( 'iron-ajax' ).params.cursor = request.detail.response.cursor;
					this.isLoading = false;
					this.loadMore();
				} else {
					this.isFinished = true;
				}
			},

			_handleAjaxGetError: function() {
				this.isLoading = false;
			},
			
			ready: function() {
				if( this.cursor && this.filter ) {
					var ajaxGet = document.querySelector( 'iron-ajax' );
					if( this.searchQuery )
						ajaxGet.params.searchQuery = this.searchQuery;
					ajaxGet.params.cursor = this.cursor;
					this.loadMore();
				} else {
					this.isFinished = true;
				}
			}

		});

	</script>

</dom-module>
<link rel="import" href="pratilipi-card.html?20160128" />

<dom-module id="pratilipi-card-grid">

	<style>
		
		:host {
			display: block;
		}
		
		paper-card.add {
			width: 100%;
			height: 200px;
			background: #E0E0E0;
			--paper-card-header: { display: none };
		}
		
		iron-icon {
			--iron-icon-height: 64px;
			--iron-icon-width: 64px;
		}
		
		paper-spinner.pratilipi-spinner {
			--paper-spinner-layer-1-color: #D0021B;
			--paper-spinner-layer-2-color: #107FE5;
			--paper-spinner-layer-3-color: #D0021B;
			--paper-spinner-layer-4-color: #107FE5;
		}
		
		/* Specific to card-grid */
		.row {
			margin-right: 0px;
			margin-left: -10px;
		}
		
		.col-xs-12, .col-sm-6, .col-md-6, .col-lg-6 {
			padding-left: 10px;
			padding-right: 0px;
		}
		
	</style>

	
	<template>
		<template is="dom-if" if="{{ heading }}">
			<div class="secondary-500 pratilipi-shadow pratilipi-card-grid-heading">{{ heading }}</div>
			<br class="pratilipi-break"/>
		</template>
		
		<div class="row">
			<template is="dom-if" if="{{ includeAddCard }}">
				<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
					<paper-card class="add">
						<div style="text-align: center; margin-top: 50px;">
							<a on-click="_write">
								<iron-icon icon="add-circle"></iron-icon>
							</a>
							<a on-click="_write">
								<h6 style="margin-top: 30px;">${ _strings.author_add_new_content }</h6>
							</a>
						</div>
					</paper-card>
				</div>
			</template>
			<template is="dom-repeat" id="repeatPratilipiList" items="[[ pratilipiList ]]">
				<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6">
					<pratilipi-card 
						pratilipi="[[ item ]]"
						drafts-active="[[ draftsActive ]]"
						published-active="[[ publishedActive ]]"></pratilipi-card>
				</div>
			</template>
		</div>
		<template is="dom-if" if="{{ isLoading }}">
			<paper-spinner class="pratilipi-spinner pratilipi-spinner-center" active></paper-spinner>
		</template>
		
		<iron-ajax
				id="AjaxGet"
				url="/api/pratilipi/list"
				method="GET"
				params="[[ filter ]]"
				content-type="application/json"
				handle-as="json"
				on-response="_handleAjaxGetResponse"
				on-error="_handleAjaxGetError"
				></iron-ajax>

	</template>


	<script>

		Polymer({
			
			is: 'pratilipi-card-grid',

			properties: {
				authorId: { type: String, value: null },
				heading: { type: String },
				pratilipiList: { type: Array, notify: true },
				searchQuery: { type: String },
				filter: { type: Object },
				cursor: { type: String },

				isLoading: { type: Boolean, value: false },
				isFinished: { type: Boolean, value: false },
				
				includeAddCard: { type: Boolean, value: false },
				
				draftsActive: { type: Boolean, value: false },
				publishedActive: { type: Boolean, value: false }
			},
			
			setPratilipiList: function( pratilipiList ) {
				this.set( 'pratilipiList', pratilipiList );
				this.$.repeatPratilipiList.render();
			},
			
			reset: function() {
				
				var ajaxGet = this.$.AjaxGet;

				if( ajaxGet.lastRequest )
					ajaxGet.lastRequest.abort();
				
				this.setPratilipiList( [] );
				
				// Setting the flags and clearing the cursor.
				this.cursor = null;
				this.isLoading = true;
				this.isFinished = false;

				// Set params and make ajax GET call. Filters already set when element initialised.
				if( this.searchQuery != null )
					ajaxGet.params.searchQuery = this.searchQuery;
				
				if( ajaxGet.params.state == null )
					ajaxGet.params.state = "PUBLISHED";
				
				ajaxGet.params.cursor = this.cursor;
				ajaxGet.generateRequest();
				
			},
			
			loadMore: function( scrollTop ) {
				
				// Return if there is an active call or cursor = null.
				if( this.isLoading || this.isFinished || this.cursor == null || this.cursor == "" )
					return;

				// Check for window height.
				var reqHeight = scrollTop
						- jQuery( this ).context.offsetTop
						+ jQuery( window ).height()
						+ 3 * jQuery( window ).height();
		
				if( jQuery( this ).outerHeight( true ) >= reqHeight )
					return;
				
				
				// Spinner Active
				this.isLoading = true;
				
				// Set params and make ajax GET call. Filters already set when element initialised.
				var ajaxGet = this.$.AjaxGet;
				if( this.searchQuery != null )
					ajaxGet.params.searchQuery = this.searchQuery;
				
				// Set state = PUBLISHED iff state is null. ( Might be set in filters )
				if( ajaxGet.params.state == null )
					ajaxGet.params.state = "PUBLISHED";
				
				ajaxGet.params.cursor = this.cursor;
				ajaxGet.generateRequest();
				
			},
			
			_handleAjaxGetResponse: function( request ) {
				
				// Disable spinner
				this.isLoading = false;
				
				// Call didn't succeed.
				if( ! request.detail.response )
					return;
				
				var pratilipiList = request.detail.response.pratilipiList;
				for( var i = 0; i < pratilipiList.length; i++ )
					this.push( 'pratilipiList', pratilipiList[i] );

				if( request.detail.response.cursor == null || pratilipiList.length < 20 )
					this.isFinished = true;
				else
					this.cursor = request.detail.response.cursor;

			},

			_handleAjaxGetError: function() {
				this.isLoading = false;
			},
			
			_write: function() {
				document.querySelector( 'pratilipi-write' ).setAuthorId( this.authorId );
				document.querySelector( 'pratilipi-write' ).open();
			}

		});

	</script>

</dom-module>
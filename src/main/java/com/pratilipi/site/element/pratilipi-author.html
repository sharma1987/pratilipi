<link rel="import" href="pratilipi-edit-author.html?2016031102" />
<link rel="import" href="pratilipi-social.html" />

<dom-module id="pratilipi-author">

	<style>

		:host {
			display: block;
		}
		
		paper-card {
			width: 100%;
			--paper-card-header: { display: none };
		}
		
		h6.author-works {
			color: #333;
		}
		
		.col-right-mobile table {
			margin: 0 auto;
			text-align: left;
			white-space: nowrap;
		}
		
		.col-right-widescreen table td, .col-right-widescreen table th, .col-right-mobile table td, .col-right-mobile table th {
			white-space: nowrap;
			color: #333;
			height: 30px;
		}
		
		.col-right-widescreen table td, .col-right-mobile table td {
			padding-left: 10px;
		}
		
		.less {
			max-height: 220px; 
			overflow: hidden;
		}
		
		.more {
			max-height: auto;
			overflow: visible;
		}
		
		#more, #less {
			color: #333;
		}
		
		th {
			font-weight: 400;
			font-size: 15px;
		}
		
		td {
			font-weight: 400;
			font-size: 14px;
		}
		
		.pratilipi-file-upload {
			width: 200px;
		}
		
		paper-spinner.pratilipi-spinner {
			display: block;
			position: absolute;
			top: 40%;
			left: 42%;
			--paper-spinner-layer-1-color: #D0021B;
			--paper-spinner-layer-2-color: #107FE5;
			--paper-spinner-layer-3-color: #D0021B;
			--paper-spinner-layer-4-color: #107FE5;
		}

	</style>
	
	
	<template>
		<paper-card>
			<!-- For wide-screens and mobile screens-->
			<div id="row">
				<div id="col-left" style="padding: 20px 0px 0px 10px;">
					<template is="dom-if" if="{{ !author.hasAccessToUpdate }}">
						<div style="width: 200px; height: 200px; margin: 0 auto;" class="pratilipi-shadow">
							<img class="pratilipi-shadow" src="{{ authorImageUrl }}" alt="{{ author.fullName }}" title="{{ author.fullNameEn }}"/>
						</div>
					</template>
					<template is="dom-if" if="{{ author.hasAccessToUpdate }}">
						<div style="position: absolute; top: -1000px;">
							<form id="uploadAuthorImage" method="post" enctype="multipart/form-data" action="/api/author/image?authorId={{ author.authorId }}" target="upload_target">
								<input id="uploadAuthorImageInput" type="file" on-change="uploadImage" name="{{ author.authorId }}" accept="image/*">
							</form>
							<iframe id="upload_target" name="upload_target" style="display: none;" on-load="_onchangeiframe"></iframe>
						</div>
						<div class="pratilipi-file-upload">
							<div style="width: 200px; height: 200px;" class="pratilipi-shadow">
								<template is="dom-if" if="{{ !imageUploaded }}">
									<img src="{{ authorImageUrl }}" alt="{{ author.fullName }}" title="{{ author.fullNameEn }}"/>
								</template>
								<template is="dom-if" if="{{ imageUploaded }}">
									<paper-spinner class="pratilipi-spinner" active></paper-spinner>
								</template>
							</div>
							<iron-icon icon="icons:cloud-upload"></iron-icon>
							<div class="pratilipi-file-upload-caption" on-click="_chooseFile">
								<iron-icon icon="icons:cloud-upload"></iron-icon>
								<strong>${ _strings.author_update_image }</strong>
							</div>
						</div>
					</template>
					<div style="width: 150px; margin: 0px auto 15px auto; display: block; padding: 15px 0px;">
						<pratilipi-social share-url="[[ authorData.pageUrl ]]"></pratilipi-social>
					</div>
				</div>
				<div id="col-right" style="padding: 20px;">
					<h3 style="margin-top: 0px; color: #D0021B;">{{ name }}</h3>

					<template is="dom-if" if="{{ penName }}">
						<h6 style="margin: 0px;">"<span>{{ penName }}</span>"</h6>
					</template>

					<br/>

					<table>
						<tr> <th>${ _strings.author_since } :</th> 	<td>{{ date }}</td> </tr>
					</table>

					<button class="pratilipi-light-blue-button" on-click="followOrUnfollow">{{ followOrUnfollowLabel }}</button>

					<template is="dom-if" if="{{ author.hasAccessToUpdate }}">
						<template is="dom-if" if="{{ !mobile }}">
							<div style="position: absolute; top: 180px;">
								<button class="pratilipi-light-blue-button" on-click="openAuthorEdit">${ _strings.author_edit_profile }</button>
							</div>
						</template>
						<template is="dom-if" if="{{ mobile }}">
							<div style="position: relative; margin-top: 20px;">
								<button class="pratilipi-light-blue-button" on-click="openAuthorEdit">${ _strings.author_edit_profile }</button>
							</div>
						</template>
						<pratilipi-edit-author></pratilipi-edit-author>
					</template>
				</div>
				<br/>
			</div>
			
			<hr style="border: 1px solid #E5E5E5; margin: 0; padding: 0;"/>
			
			<!-- Works, Reads and Likes -->
			<div class="row" style="text-align: center; padding: 10px;">
				<div class="col-xs-12 col-sm-4 col-md-4 col-lg-4">
					<h6 class="author-works">${ _strings.author_count_works }&nbsp;&minus;&nbsp;{{ author.contentPublished }}</h6>
				</div>
				<div class="col-xs-12 col-sm-4 col-md-4 col-lg-4">
					<h6 class="author-works">${ _strings.author_count_reads }&nbsp;&minus;&nbsp;{{ author.totalReadCount }}</h6>
				</div>
				<div class="col-xs-12 col-sm-4 col-md-4 col-lg-4">
					<h6 class="author-works">${ _strings.author_count_likes }&nbsp;&minus;&nbsp;{{ author.totalFbLikeShareCount }}</h6>
				</div>
			</div>
			
		</paper-card>
		
		<br class="pratilipi-break" />
		
		<!-- Displaying author summary if.. -->
		<div id="author-summary">
			<paper-card>
				<div style="padding: 10px 20px 20px 20px; text-align: justify;">
					<h4 style="color: #D0021B;">${ _strings.author_about }</h4>
					<div id="author-summary-text" style="margin-top: 15px; margin-down: 20px;">{{ summary }}</div>
					<div style="text-align: center; padding-top: 5px;">
						<a id="more" style="font-size: 14px; font-weight: 700;" on-click="_toggleSnippet">(${ _strings.show_more })</a>
						<a id="less" style="font-size: 14px; font-weight: 700;" on-click="_toggleSnippet">(${ _strings.show_less })</a>
					</div>
				</div>
			</paper-card>
			<br class="pratilipi-break"/>
		</div>
		
		<iron-ajax
				id="AjaxGet"
				url="/api/author"
				method="GET"
				content-type="application/json"
				handle-as="json"
				on-response="_handleAjaxGetResponse"
				></iron-ajax>
		
		<iron-ajax
				id="AjaxPost"
				url="/api/userauthor/follow"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
		
	</template>
	
	<script>
	
		function convertDate( date ) {
			var d = new Date( date );
			function day(d) { return (d < 10) ? '0' + d : d; }
			function month(m) { var months = ['${ _strings.month_jan }','${ _strings.month_feb }','${ _strings.month_mar }',
			                                  '${ _strings.month_apr }','${ _strings.month_may }','${ _strings.month_jun }',
			                                  '${ _strings.month_jul }','${ _strings.month_aug }','${ _strings.month_sep }',
			                                  '${ _strings.month_oct }','${ _strings.month_nov }','${ _strings.month_dec }']; return months[m]; }
			return [ day(d.getDate()), month(d.getMonth()), d.getFullYear() ].join(' ');
		}
		
		function capitalizeFirstLetter( string ) {
			return string.charAt(0).toUpperCase() + string.toLowerCase().slice(1);
		}
	
		Polymer({
			
			is: 'pratilipi-author',
			
			behaviors: [
				Polymer.IronResizableBehavior
			],
			
			listeners: {
				'iron-resize': '_onIronResize',
			},
			
			properties: {
				user: { type: Object, observer: "_loadAuthor" },
				author: { type: Object, notify: true },
				authorData: { type: Object },
				userAuthorData: { type: Object },
				
				mobile: { type: Boolean },
				imageUploaded: { type: Boolean, value: false }
			},
			
			openAuthorEdit: function() {
				this.querySelector( 'pratilipi-edit-author' ).createOrEditAuthor( this.author );
			},
			
			followOrUnfollow: function() {
				userAuthorData.following = ! userAuthorData.following;
				this.followOrUnfollowLabel = userauthor.following ? "Unfollow" : "Follow";
				var ajaxPost = this.$.AjaxPost;
				ajaxPost.params.authorId = this.userAuthorData.authorId;
				ajaxPost.params.following = userAuthorData.following;
				ajaxPost.generateRequest();
			},
			
			process: function( data ) {
				if( data.name == null && data.nameEn != null )
					data.name = data.nameEn;
				if( data.penName == null && data.penNameEn != null )
					data.penName = data.penNameEn;
				data.contentPublished = data.contentPublished == null ? 0 : data.contentPublished;
				data.totalFbLikeShareCount = data.totalFbLikeShareCount == null ? 0 : data.totalFbLikeShareCount;
				data.totalReadCount = data.totalReadCount == null ? 0 : data.totalReadCount;
				return data;
			},
			
			updateAuthor: function( author ) {

				this.set( 'author', this.process( author ) );
				
				this.name = author.name;
				if( author.penName != null )
					this.penName = author.penName;
				else if( author.penNameEn != null )
					this.penName = author.penNameEn;
				else
					this.penName = null;
				
				if( window.location.pathname != author.pageUrl )
					window.location.href = author.pageUrl;
				
				if( author.imageUrl.indexOf( '?' ) == -1 )
					this.authorImageUrl = author.imageUrl + "?" + "width=200";
				else
					this.authorImageUrl = author.imageUrl + "&" + "width=200";
				
				this.language = capitalizeFirstLetter( author.language );
				this.date = convertDate( author.registrationDateMillis );
				
				this.summary = author.summary;
				if( this.summary == null || this.summary.trim() == "" ) { 
					document.getElementById( "author-summary" ).style.display = "none";
				} else {
					document.getElementById( "author-summary" ).style.display = "block";
					jQuery( '#author-summary-text' ).removeClass( 'less' );
					jQuery( '#author-summary-text' ).removeClass( 'more' );
					
					var jSummary = jQuery( document.getElementById( "author-summary-text" ) );
					jSummary.html( this.summary ) 
					
					var height = jQuery( "#author-summary-text" ).height();
					
					if( height > 220 ) {
						jQuery( '#author-summary-text' ).addClass( 'less' );
						document.getElementById( "less" ).style.display = "none";
						document.getElementById( "more" ).style.display = "block";
					} else {
						document.getElementById( "less" ).style.display = "none";
						document.getElementById( "more" ).style.display = "none";
					}
				}
				
			},
			
			attached: function() {
				this.updateAuthor( this.authorData );
				this.followOrUnfollowLabel = userauthor.following ? "Unfollow" : "Follow";
			},
			
			_toggleSnippet: function() {
				jQuery( '#author-summary-text' ).toggleClass( 'less' );
				jQuery( '#author-summary-text' ).toggleClass( 'more' );
				
				if( document.getElementById( "more" ).style.display === "block" )
					document.getElementById( "more" ).style.display = "none";
				else
					document.getElementById( "more" ).style.display = "block";
				
				if( document.getElementById( "less" ).style.display === "block" )
					document.getElementById( "less" ).style.display = "none";
				else
					document.getElementById( "less" ).style.display = "block";
			},
			
			_onIronResize: function() {
				var windowsize = this.clientWidth;
				if( windowsize > 600 ) {
					this.mobile = false;
					jQuery( '#row' ).removeClass( 'row-mobile' );
					jQuery( '#col-left' ).removeClass( 'col-left-mobile' );
					jQuery( '#col-right' ).removeClass( 'col-right-mobile' );
					
					jQuery( '#row' ).addClass( 'row-widescreen' );
					jQuery( '#col-left' ).addClass( 'col-left-widescreen' );
					jQuery( '#col-right' ).addClass( 'col-right-widescreen' );
				}
				else {
					this.mobile = true;
					jQuery( '#row' ).removeClass( 'row-widescreen' );
					jQuery( '#col-left' ).removeClass( 'col-left-widescreen' );
					jQuery( '#col-right' ).removeClass( 'col-right-widescreen' );
					
					jQuery( '#row' ).addClass( 'row-mobile' );
					jQuery( '#col-left' ).addClass( 'col-left-mobile' );
					jQuery( '#col-right' ).addClass( 'col-right-mobile' );
				}
				
			},
			
			_loadAuthor: function() {
				// Exploiting the fact that Author will be undefined before DOM is attached.
				if( this.author == null )
					return;

				var ajaxGet = this.$.AjaxGet;
				ajaxGet.params.authorId = this.author.authorId;
				ajaxGet.generateRequest();
			},
			
			_handleAjaxGetResponse: function( event ) {
				this.updateAuthor( event.detail.response );
				// In case of image upload.
				this.async( function() {
					this.imageUploaded = false;
				}, 30 );
			},
			
			_chooseFile: function() {
				document.getElementById( "uploadAuthorImageInput" ).click();
			},
			
			_onchangeiframe: function() {
				if( this.imageUploaded )
					this._loadAuthor();
			},
			
			uploadImage: function() {
				document.getElementById( "uploadAuthorImage" ).submit();
				this.imageUploaded = true;
			},
			
		});

	</script>

</dom-module>

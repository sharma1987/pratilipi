<dom-module id="pratilipi-user-register">

	<style>

		.popup-heading span {
			font-size: 14px;
			color: #333;
			display: inline-block;
		}
		
		paper-input.pratilipi-blue {
			--paper-input-container-focus-color: #107FE5;
		}
		
	</style>

	<template>
		<div class="modal-content">
			<div class="modal-header">
				<span>${ _strings.sign_up_for_pratilipi }</span>
				<span style="float: right;"><paper-icon-button style="margin-top: -10px; margin-right: -10px;" noink="true" icon="close" data-dismiss="modal"></paper-icon-button></span>
			</div>
			<div class="modal-body" on-keyup="onSubmit">
				<pratilipi-facebook-login></pratilipi-facebook-login>
				<div style="margin-right: 10px; margin-left: 10px;">
					<br/>
					<div style="height: 2px; background-color: #f5f5f5; text-align: center;">
						<span style="background-color: white; position: relative; top: -1em;">
							&nbsp;&nbsp;OR&nbsp;&nbsp;
						</span>
					</div>
					
					<paper-input class="pratilipi-blue" label="{{ nameInput }}" value="{{ params.name::input }}">
						<iron-icon style="margin-right: 5px;" icon="account-box" prefix></iron-icon>
					</paper-input>
					<paper-input class="pratilipi-blue" label="{{ emailInput }}" value="{{ params.email::input }}">
						<iron-icon style="margin-right: 5px;" icon="mail" prefix></iron-icon>
					</paper-input>
					<paper-input class="pratilipi-blue" label="{{ passwordInput }}" type="password" value="{{ params.password::input }}">
						<iron-icon style="margin-right: 5px;" icon="lock" prefix></iron-icon>
					</paper-input>
					
					<div class="text-center">
						<span style="display: block;">{{ message }}</span>
						<button style="margin-top: 20px;" class="pratilipi-dark-blue-button" on-click="onSubmit">${ _strings.sign_up }</button>
						<span style="display: block; margin-top: 15px;">
							By registering, you agree to the
							<a href="/privacy-policy"><span style="color: #107FE5; white-space: nowrap;">privacy policy</span></a>
							&nbsp;and&nbsp;
							<a href="/terms-of-service"><span style="color: #107FE5; white-space: nowrap;">terms of service</span></a>.
						</span>
					</div>
					
				</div>
			</div>
			<div class="modal-footer">
				<p class=" text-center">Already a Member?&nbsp;<a style="color: #107FE5;" href="#" on-click="logIn">Sign In !</a></p>
			</div>
		</div>
		
		<iron-ajax
				id="AjaxPost"
				url="/api/user/register"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
		
	</template>
	
	
	<script>
	
	function transformRequest(obj) {
        var str = [];
        for(var p in obj)
        	str.push(encodeURIComponent(p) + "=" + encodeURIComponent(obj[p]));
        return str.join("&");
    }
    
		Polymer({

			is: 'pratilipi-user-register',

			properties: {
				params: { type:Object, value:{"source":"WEBSITE_M6<#if language??>_${ language }</#if>"} },
				nameInput: { type: String },
				emailInput: { type: String },
				passwordInput: { type: String },
				message: { type:String }
			},
			
			logIn: function() {
				document.querySelector( 'pratilipi-user' ).logIn();
			},
			
			defaultMessages: function() {
				this.nameInput = "Name";
				this.emailInput = "Email";
				this.passwordInput = "Password";
				this.message = null;
			},
			
			ready: function() {
				this.defaultMessages();
			},
			
			onSubmit: function( event ) {
				this.defaultMessages();
				
				if( event.keyCode != null && event.keyCode != 0 && event.keyCode != 13 )
					return;
				
				if( this.params.name === undefined || this.params.email === undefined || this.params.password === undefined ) {
					this.message = "Please fill in the details";
					return;
				}
				
				this.message = "Working ...";
				jQuery( 'button' ).prop( 'disabled', true );
				
				this.$.AjaxPost.body = transformRequest( this.params );
				this.$.AjaxPost.generateRequest();
			},
			
			_handleAjaxPostResponse: function( event ) {
				if( event.detail.xhr.status == 0 ) {
					this.message = "Could not connect to server !";
				} else {
					this.message = "Success !";
					this.async( function() {
 						this.message = null;
 						jQuery( "#pratilipiUserLogin" ).modal( 'hide' );
					}, 1000 );
					document.querySelector( 'pratilipi-user' ).updateUser( event.detail.response );
				}
			},

			_handleAjaxPostError: function( event ) {
				this.message = null;
				jQuery( 'button' ).prop( 'disabled', false );
				if( event.detail.request.xhr.status == 400 ) {
					if( event.detail.request.xhr.response.email !== undefined ) {
						this.emailInput = event.detail.request.xhr.response.email;
						return;
					}
					this.message = event.detail.request.xhr.response.password !== undefined ? event.detail.request.xhr.response.password : "";
				}
				else
					this.message = event.detail.request.xhr.response.message;
			},

		});
		
	</script>
	
</dom-module>
<dom-module id="pratilipi-user-register">

	<style>
		paper-input.pratilipi-blue {
			padding-left: 20px;
			padding-right: 20px;
			--paper-input-container-color: #107FE5;
			--paper-input-container-focus-color: #107FE5;
			--paper-input-container-input-color: #333;
			--paper-input-container-label: {
				font-size: 15px;
				font-family: Helvetica,'Noto Sans Tamil', sans-serif;
				text-align: left;
			};
		}
		.modal-fullscreen .modal-dialog .modal-content {max-width: 400px; padding-top: 30px;}
	</style>

	<template>
		<div class="modal modal-fullscreen fade" id="pratilipiUserRegister" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content" on-keyup="onSubmit">
					<div class="modal-fullscreen-close-button">
						<paper-icon-button noink icon="close" data-dismiss="modal"></paper-icon-button>
					</div>
					<img title="${ _strings.pratilipi }" alt="${ _strings.pratilipi }" src="http://0.ptlp.co/resource-${ lang }/logo/pratilipi_logo.png" />
					<pratilipi-facebook-login></pratilipi-facebook-login>
					<div style="height: 2px; background-color: #FFF; text-align: center; margin-top: 30px; margin-bottom: 10px;"></div>
					<h6 class="modal-fullscreen-heading">${ _strings.user_sign_up_for_pratilipi }</h6>
					<paper-input class="pratilipi-blue" label="${ _strings.user_full_name }" value="{{ params.name::input }}">
						<iron-icon icon="account-box" prefix></iron-icon>
					</paper-input>
					<paper-input class="pratilipi-blue" label="${ _strings.user_email }" value="{{ params.email::input }}">
						<iron-icon icon="mail" prefix></iron-icon>
					</paper-input>
					<paper-input class="pratilipi-blue" label="${ _strings.user_password }" type="password" value="{{ params.password::input }}">
						<iron-icon icon="lock" prefix></iron-icon>
					</paper-input>
					<div class="display-message-div">
						<p>{{ message }}</p>
					</div>
					<button id="registerButton" class="pratilipi-blue-button" on-click="onSubmit">${ _strings.user_sign_up }</button>
					<p style="display: block; margin-top: 15px; text-align: center;">
						${ _strings.register_part_1 }
						<a class="pratilipi-blue" style="white-space: nowrap; font-size: 16px;" href="/privacy-policy">privacy policy</a>
						&nbsp;${ _strings.register_part_2 }&nbsp;
						<a class="pratilipi-blue" style="white-space: nowrap; font-size: 16px;" href="/terms-of-service">terms of service</a>
						&nbsp;${ _strings.register_part_3 }
					</p>
				</div>
			</div>
			<div class="modal-footer">
				<div class="text-center" style="display: block;">
					<span class="text-muted">${ _strings.user_is_registered }&nbsp;</span>
					<a class="pratilipi-blue" on-click="logIn">${ _strings.user_to_sign_in }</a>
				</div>
			</div>
		</div>
		
		<iron-ajax
				id="AjaxPost"
				url="/api/user/register"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
		
	</template>
	
	
	<script>
	
		Polymer({

			is: 'pratilipi-user-register',

			properties: {
				params: { type: Object, value: {"source":"WEBSITE_M6<#if language??>_${ language }</#if>"} },
				message: { type: String, value: null }
			},
			
			logIn: function() {
				document.querySelector( 'pratilipi-user' ).logIn();
			},
			
			defaultMessages: function() {
				this.message = null;
			},
			
			open: function() {
				this.async( function() {
					jQuery( "#pratilipiUserRegister" ).modal( {backdrop: 'static'} );
				});
			},
			
			close: function() {
				jQuery( "#pratilipiUserRegister" ).modal( 'hide' );
			},
			
			onSubmit: function( event ) {
				this.message = null;
				
				if( event.keyCode != null && event.keyCode != 0 && event.keyCode != 13 )
					return;
				
				if( this.params.name == null || this.params.email == null || this.params.password == null || this.params.name.trim() == "" || this.params.email.trim() == "" ) {
					this.message = "Please fill in the details";
					return;
				}
				
				this.message = "Working ...";
				jQuery( '#registerButton' ).prop( 'disabled', true );
				
				this.$.AjaxPost.body = jQuery.param( this.params );
				this.$.AjaxPost.generateRequest();
			},
			
			_handleAjaxPostResponse: function( event ) {
				if( event.detail.xhr.status == 0 ) {
					this.message = "Could not connect to server !";
				} else {
					this.message = "${ _strings.user_register_success }";
					this.async( function() {
						this.message = null;
						this.params = {"source":"WEBSITE_M6<#if language??>_${ language }</#if>"};
						jQuery( '#registerButton' ).prop( 'disabled', false );
 						this.close();
					}, 1000 );
					document.querySelector( 'pratilipi-user' ).updateUser( event.detail.response );
				}
			},

			_handleAjaxPostError: function( event ) {
				this.message = null;
				jQuery( '#registerButton' ).prop( 'disabled', false );
				if( event.detail.request.xhr.status == 400 ) {
					if( event.detail.request.xhr.response.email != null ) {
						this.message = event.detail.request.xhr.response.email;
						return;
					}
					this.message = event.detail.request.xhr.response.password != null ? event.detail.request.xhr.response.password : "Invalid Data!";
				}
				else
					this.message = event.detail.request.xhr.response.message;
			},

		});
		
	</script>
	
</dom-module>
<dom-module id="pratilipi-rating-input">

	<style>

		:host {
			display: inline-block;
		}
		
		div > div {
			direction: rtl;
			cursor: pointer;
		}

		.glyphicon {
			color: #bdc3c7;
		}

		.glyphicon-selected {
			color: #e67e22;
		}

		.glyphicon:hover ~ .glyphicon, .glyphicon:hover {
			color: gold;
		}

	</style>


	<template>
		<div class="secondary-500">
			<span>{{ title }}</span>
			<br/>
			<div style="display: block; float: left;">
				<span class="glyphicon glyphicon-star" aria-hidden="true" on-mouseover="showFiveStars"  on-mouseout="init" on-click="rateFiveStars"></span>
				<span class="glyphicon glyphicon-star" aria-hidden="true" on-mouseover="showFourStars"  on-mouseout="init" on-click="rateFourStars"></span>
				<span class="glyphicon glyphicon-star" aria-hidden="true" on-mouseover="showThreeStars" on-mouseout="init" on-click="rateThreeStars"></span>
				<span class="glyphicon glyphicon-star" aria-hidden="true" on-mouseover="showTwoStars"   on-mouseout="init" on-click="rateTwoStars"></span>
				<span class="glyphicon glyphicon-star" aria-hidden="true" on-mouseover="showOneStar"    on-mouseout="init" on-click="rateOneStar"></span>
			</div>
		</div>
		<iron-ajax
				id="AjaxPut"
				url="/api/userpratilipi"
				method="PUT"
				content-type="application/json"
				handle-as="json"
				on-response="_handleAjaxPutResponse"
				on-error="_handleAjaxPutError"
				></iron-ajax>
	</template>


	<script>

		Polymer({

			is: 'pratilipi-rating-input',

			properties: {
				user: { type: Object },
				pratilipiId: { type: String },
				value: { type: Number, value: 0, notify: true, observer: 'init' },
				rating: { type: Number, value: 0 },
				isSaving: { type: Number, value: 0 }
			},

			init: function() {
				if( this.isSaving )
					this.title = '${ _strings.saving }';
				else if( this.value == undefined || this.value == 0 )
					this.title = '${ _strings.rate_this }';
				else
					this.title = '${ _strings.your_rating }';

				
				var stars = this.querySelectorAll( 'span' );

				if( this.value >= 1 )
					jQuery( stars[4] ).addClass( 'glyphicon-selected' );
				else
					jQuery( stars[4] ).removeClass( 'glyphicon-selected' );

				if( this.value >= 2 )
					jQuery( stars[3] ).addClass( 'glyphicon-selected' );
				else
					jQuery( stars[3] ).removeClass( 'glyphicon-selected' );

				if( this.value >= 3 )
					jQuery( stars[2] ).addClass( 'glyphicon-selected' );
				else
					jQuery( stars[2] ).removeClass( 'glyphicon-selected' );

				if( this.value >= 4 )
					jQuery( stars[1] ).addClass( 'glyphicon-selected' );
				else
					jQuery( stars[1] ).removeClass( 'glyphicon-selected' );

				if( this.value == 5 )
					jQuery( stars[0] ).addClass( 'glyphicon-selected' );
				else
					jQuery( stars[0] ).removeClass( 'glyphicon-selected' );
			},

			
			showOneStar: function() {
				this.title = '${ _strings.rating_1_star }';
			},

			showTwoStars: function() {
				this.title = '${ _strings.rating_2_star }';
			},
			
			showThreeStars: function() {
				this.title = '${ _strings.rating_3_star }';
			},
			
			showFourStars: function() {
				this.title = '${ _strings.rating_4_star }';
			},
			
			showFiveStars: function() {
				this.title = '${ _strings.rating_5_star }';
			},
			
			
			rateOneStar: function() {
				this.submitRating( 1 );
			},

			rateTwoStars: function() {
				this.submitRating( 2 );
			},
			
			rateThreeStars: function() {
				this.submitRating( 3 );
			},
			
			rateFourStars: function() {
				this.submitRating( 4 );
			},
			
			rateFiveStars: function() {
				this.submitRating( 5 );
			},

			
			submitRating: function( rating ) {
				if( this.user.isGuest ) {
					document.querySelector( 'pratilipi-user' ).logIn();
					return;
				}
				
				if( this.isSaving )
					return;
				
				this.isSaving = true;
				this.rating = this.value;
				this.set( 'value', rating );
				
				var ajaxPut = this.$.AjaxPut;
				ajaxPut.body = JSON.stringify( { pratilipiId:this.pratilipiId, rating:rating } );
				ajaxPut.generateRequest();
			},
			
			_handleAjaxPutResponse: function( event ) {
				this.isSaving = false;
				if( event.detail.xhr.status == 0 )
					this.set( 'value', this.rating );
				else
					this.init();
			},

			_handleAjaxPutError: function( event ) {
				this.isSaving = false;
				if( event.detail.request.xhr.status == 401 )
					document.querySelector( 'pratilipi-user' ).logIn();
				this.set( 'value', this.rating );
			},

			
			ready: function() {
				this.init();
			}

		});

	</script>

</dom-module>
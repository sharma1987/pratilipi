<dom-module id="pratilipi-content-page">
	<style>
		:host {
			display: block;
		}
		paper-card {
			display: block;
			width: 100%;
			padding: 8px 16px;
			margin-top: 6px;
			margin-bottom: 6px;
			--paper-card-header: { display: none };
		}
		textarea {
			display: block;
			width: 100%;
		}
		paper-dropdown-menu {
			width: 100%;
			--paper-dropdown-menu-focus-color: #333;
			--paper-dropdown-menu-input-color: #333;
			--paper-input-container-label: {
				color:#333;
			}
			--paper-input-container-input: {
				font-family: inherit;
			};
			--paper-input-container-underline: {
				background: #333;
			};
			--paper-input-container-label: {
				font-size: 15px;
				font-family: inherit;
				text-align: left;
				color: #333;
			};
		}
		paper-menu {
			--paper-menu-color: #333;
			width: 100%;
			--paper-menu-focused-item: {
				color: #333;
			};
		}
		paper-menu paper-item {
			font-size: 15px;
			font-family: inherit;
			color: #333;
			white-space: nowrap;
		}
	</style>
	<template>
		<pratilipi-user user='{{ user }}' user-data="[[ userData ]]"></pratilipi-user>
		<pratilipi-write pratilipi-types='[[ pratilipiTypes ]]'></pratilipi-write>
		<pratilipi-alert></pratilipi-alert>

		<div class="header-pos">
   			<pratilipi-header language-map="[[ languageMap ]]" user='[[ user ]]'></pratilipi-header>
   		</div>
		<main>
			<div class="parent-container margin-top-bottom">
				<div class="container">
					<pratilipi-navigation
							class='pull-left hidden-xs hidden-sm'
							navigation-list='[[ navigationList ]]'
							></pratilipi-navigation>
					<!-- Navigation & Search bar for extra-small & small screens. -->
					<pratilipi-navigation-drawer with-backdrop navigation-list='[[ navigationList ]]'></pratilipi-navigation-drawer>
					<div style="overflow:hidden; padding: 0 2px;">
						<div class="secondary-500 pratilipi-shadow pratilipi-card-grid-heading pratilipi-red">${ _strings.write_heading }</div>
						<paper-card>
							<p>${ _strings.write_help }</p>
							<div class="row">
								<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
									<pratilipi-input color="black" label="${ _strings.write_title }" value="{{ title::input }}" icon="icons:description"></pratilipi-input>
								</div>
								<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
									<pratilipi-input color="black" label="${ _strings.write_title_en }" value="{{ titleEn::input }}" icon="icons:description"></pratilipi-input>
								</div>
								<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
									<paper-dropdown-menu id="selectPratilipiType" noink label="${ _strings.write_type }" value="{{ type::input }}" vertical-align="bottom" horizontal-align="left">
										<paper-menu noink class="dropdown-content" selected="[[ selected ]]" style="white-space: nowrap; width: auto;">
											<paper-item value="BOOK">{{ pratilipiTypes.BOOK.name }}</paper-item>
											<paper-item value="POEM">{{ pratilipiTypes.POEM.name }}</paper-item>
											<paper-item value="STORY">{{ pratilipiTypes.STORY.name }}</paper-item>
											<paper-item value="ARTICLE">{{ pratilipiTypes.ARTICLE.name }}</paper-item>
											<paper-item value="MAGAZINE">{{ pratilipiTypes.MAGAZINE.name }}</paper-item>
										</paper-menu>
									</paper-dropdown-menu>
								</div>
								<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
									<pratilipi-input color="black" disabled always-float-label label="${ _strings.write_language }" value="{{ languageVernacular }}"></pratilipi-input>
								</div>
								<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
									<div style="margin-top: 40px; margin-bottom: 5px;"><span style="font-size: 14px;">${ _strings.write_summary }</span></div>
									<textarea name="contentSummary" id="contentSummary" rows="10" value="{{ summary::input }}"></textarea>
								</div>
							</div>
							<div class="display-message-div"><p>{{ message }}</p></div>
							<button id="pratilipiWriteButton" class="pratilipi-dark-blue-button" type="button" on-click="onSubmit">${ _strings.write_create_new_content }</button>
						</paper-card>
					</div>
				</div>
			</div>
		</main>
		<footer>
    		<pratilipi-footer></pratilipi-footer>
		</footer>
		<div class="scroll-top-button">
			<a id="scrollToTop" on-click="scrollToTop"><img src="http://0.ptlp.co/resource-all/icon/footer/arrow_up_transparent_64.png"/></a>
		</div>
		<iron-ajax
				id="AjaxPost"
				url="/api/pratilipi"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
	</template>
	<script>
		HTMLImports.whenReady(function () {
			if( CKEDITOR != null && document.getElementById( 'contentSummary' ) != null )
				CKEDITOR.replace( 'contentSummary', {
				    plugins: "dialogui,dialog,a11yhelp,basicstyles,bidi,clipboard," +
				    "button,panelbutton,panel,floatpanel,menu," +
				    "contextmenu,dialogadvtab,elementspath,enterkey,entities,popup," +
				    "horizontalrule,htmlwriter,indent," +
				    "indentblock,indentlist,justify,link,list,liststyle," +
				    "pastefromword,pastetext," +
				    "removeformat,resize,menubutton," +
				    "showborders,tab," +
				    "toolbar,undo,wysiwygarea"
				} );
		});
		function getLanguageVernacular( language ) {
			var languageVernacular = {
					"HINDI" : "${ _strings.language_hi }",
					"GUJARATI" : "${ _strings.language_gu }",
					"TAMIL" : "${ _strings.language_ta }",
					"MARATHI" : "${ _strings.language_mr }",
					"MALAYALAM" : "${ _strings.language_ml }",
					"BENGALI" : "${ _strings.language_bn }",
					"TELUGU" : "${ _strings.language_te }",
					"KANNADA" : "${ _strings.language_kn }"
			};
			return languageVernacular[ language ];
		}
		Polymer({
			is: 'pratilipi-content-page',

			properties: {
				userData: { type: Object },
				navigationList: { type: Array },
				pratilipiTypes: { types: Object },
				languageMap: { type: Object },
				lastScrollTop: { type: Number, value: 0 },

				// Specific to admins
				authorId: { type: String },

				// Specific to input fields
				pratilipiId: { type: String },
				title: { type: String },
				titleEn: { type: String },
 				summary: { type: String },
 				type: { type: String, observer: "_pratilipiTypeObserver" },
 				language: { type: String, observer: "_languageObserver" },
 				state: { type: String },

 				// Specific to modal
				pratilipiTypes: { types: Object },
				selected: { type: Number },
 				message: { type: String }
			},

			scrollToTop: function() {
				$( 'html, body' ).animate( { scrollTop : 0 },800 );
			},

			ready: function() {
				jQuery( '#scrollToTop' ).css( "display", "none" );
			},

			attached: function() {
				this.set( 'pratilipiTypes', jQuery.parseJSON( this.pratilipiTypes ) );
				this.set( 'language', "${ language?upper_case }" );
				this.set( 'state', "DRAFTED" );
			},

			_languageObserver: function() {
				this.set( 'languageVernacular', getLanguageVernacular( this.language ) );
			},

			_pratilipiTypeObserver: function() {
				switch( this.type ) {
					case "BOOK": this.set( 'selected', 0 ); break;
					case "POEM": this.set( 'selected', 1 ); break;
					case "STORY": this.set( 'selected', 2 ); break;
					case "ARTICLE": this.set( 'selected', 3 ); break;
					case "MAGAZINE": this.set( 'selected', 4 ); break;
					default: this.set( 'selected', null );
				}
			},

			scrollHandler: function( st ) {
				if( st > this.lastScrollTop || st < 100 )
					jQuery( '#scrollToTop' ).fadeOut();
				else
					jQuery( '#scrollToTop' ).fadeIn();
				this.lastScrollTop = st;
			},

			process: function( pratilipi ) {
				this.set( 'message', null );
				this.set( 'pratilipiId', pratilipi.pratilipiId );
				this.set( 'title', pratilipi.title );
				this.set( 'titleEn', pratilipi.titleEn );
				this.set( 'state', pratilipi.state == null ? "DRAFTED" : pratilipi.state );
				this.set( 'summary', pratilipi.summary );
				this.set( 'type', pratilipi.type );
				this.set( 'language', pratilipi.language );

				if( CKEDITOR != null && CKEDITOR.instances.contentSummary != null )
					CKEDITOR.instances.contentSummary.setData( this.summary );
			},

			onSubmit: function( event ) {

				if( ( this.title == null || this.title.trim() == "" ) && 
						( this.titleEn == null || this.titleEn.trim() == "" ) ) {
					this.message = "${ _strings.write_fill_title }";
					return;
				}

				if( this.$.selectPratilipiType.selectedItem == null ) {
					this.message = "${ _strings.write_select_type }";
					return;
				}

				this.type = this.$.selectPratilipiType.selectedItem.getAttribute( "value" );

				if( CKEDITOR != null && CKEDITOR.instances.contentSummary != null )
					this.summary = CKEDITOR.instances.contentSummary.getData();

				this.message = "${ _strings.working }";
				var body = {
						type: this.type,
						language: this.language,
						state: this.state
				};

				if( this.title != null )
					body.title = this.title;

				if( this.titleEn != null )
					body.titleEn = this.titleEn;

				if( this.pratilipiId != null )
					body.pratilipiId = this.pratilipiId;

				if( this.summary != null )
					body.summary = this.summary;

				if( this.authorId != null )
					body.authorId = this.authorId;

				jQuery( '#pratilipiWriteButton' ).prop( 'disabled', true );
				this.$.AjaxPost.body = jQuery.param( body );
				this.$.AjaxPost.generateRequest();
				
			},

			_handleAjaxPostResponse: function( event ) {
				
				var pratilipi = event.detail.response;
				
				if( this.createPratilipi )
					this.message = "${ _strings.content_created_success }";
				else if( this.editPratilipi ) 
					this.message = "${ _strings.updated_pratilipi_info_success }";
					
				jQuery( '#pratilipiWriteButton' ).prop( 'disabled', false );
				
				if( this.createPratilipi ) {
					// Redirect to writer with return option to pratilipi page
					this.async( function() {
						this.clearAndClose();
						window.location.href = pratilipi.writePageUrl + "&ret=" + pratilipi.pageUrl;
					}, 1000 );
				} else if( this.editPratilipi ) {
					document.querySelector( 'pratilipi-pratilipi' ).updatePratilipi( pratilipi );
					this.async( function() {
						this.clearAndClose();
					}, 1000 );
				}
			},

			_handleAjaxPostError: function( event ) {
				jQuery( '#pratilipiWriteButton' ).prop( 'disabled', false );
				
				this.message = null;
				if( event.detail.request.xhr.status === 400 || event.detail.request.xhr.status === 401 || event.detail.request.xhr.status === 500 && event.detail.request.xhr.response.message != null )
					this.message = event.detail.request.xhr.response.message;
				else
					this.message = "${ _strings.server_error_message }"
			}

		});
	</script>
</dom-module>
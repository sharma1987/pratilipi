<dom-module id="pratilipi-write">

	<style>
	
		:host {
			display: block;
		}
		
		textarea {
			display: block;
			width: 100%;
		}
		
		paper-dropdown-menu {
			width: 100%;
			--paper-dropdown-menu-focus-color: #333;
			--paper-dropdown-menu-input-color: #333;
			--primary-text-color: #333;
			--paper-input-container: {
				color: #333;
			};
			--paper-input-container-input: {
				font-family: inherit;
				color: #333;
			};
			--paper-input-container-underline: {
				background: #333;
				color: #333;
			};
			--paper-input-container-label: {
				font-size: 15px;
				font-family: inherit;
				text-align: left;
				color: #333;
			};
			--paper-input-container-focus:{
				color: #333;
			};
		}
		
		paper-menu {
			--paper-menu-color: #333;
			width: 100%;
			--paper-menu-focused-item: {
				color: #333;
			};
			--paper-item-focused-before: {
				color: #333;
				background: #fff;
			};
		}
		
		paper-menu paper-item {
			font-size: 15px;
			font-family: inherit;
			color: #333;
			white-space: nowrap;
		}
		
		#pratilipiWriteButton {
			color: #fff;
			border: 1px solid #d3d3d3;
			background: #d0021b;
			outline: none;
			padding: 6px 12px;
			font-weight: normal;
		}
		
		.row {padding-left: 10px;padding-right: 10px;}
		.modal-content {border-radius: 0;}
		.pull-center {display:block;margin-left:auto;margin-right:auto;text-align:center;}
		
		paper-checkbox.pratilipi-red {
			align-self: center;
			--paper-checkbox-checked-color: #d0021b;
			--paper-checkbox-checked-ink-color: #333;
			--paper-checkbox-unchecked-color: #333;
			--paper-checkbox-unchecked-ink-color: #333;
			--paper-checkbox-label-color: #333;
			--paper-checkbox-label-spacing: 0;
			--paper-checkbox-margin: 0 8px 8px 0;
			--paper-checkbox-vertical-align: top;
		}
	</style>
	

	<template>
		<div class="modal fade" id="pratilipiWrite" role="dialog" tabindex="-1">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button style="opacity: 1; outline: none;" type="button" class="close" data-dismiss="modal" aria-label="Close"><iron-icon style="color: #333;" icon="icons:close"></iron-icon></button>
						<h6 style="min-height: 20px; line-height: 20px;" class="modal-title">
							<template is="dom-if" if="{{ createPratilipi }}">${ _strings.writer_add_content_title }</template>
							<template is="dom-if" if="{{ editPratilipi }}">{{ title }}</template>
						</h6>
					</div>
					<div class="modal-body" style="padding-bottom: 0px;">
						<div class="row">
							<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
								<pratilipi-input color="black" disabled always-float-label label="${ _strings.writer_select_language }" value="{{ languageVernacular }}"></pratilipi-input>
							</div>
							<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
								<pratilipi-input make-transliterable color="black" label="${ _strings.writer_input_title } *" value="{{ title::input }}" icon="icons:description"></pratilipi-input>
							</div>
							<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
								<pratilipi-input color="black" label="${ _strings.writer_input_title_en }" value="{{ titleEn::input }}" icon="icons:description"></pratilipi-input>
							</div>
							<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
								<paper-dropdown-menu id="selectPratilipiType" noink label="${ _strings.writer_select_category } *" value="{{ type }}" vertical-align="bottom" horizontal-align="left">
									<paper-menu noink class="dropdown-content" selected="[[ selected ]]" style="white-space: nowrap; width: auto;">
										<paper-item value="BOOK">{{ pratilipiTypes.BOOK.name }}</paper-item>
										<paper-item value="POEM">{{ pratilipiTypes.POEM.name }}</paper-item>
										<paper-item value="STORY">{{ pratilipiTypes.STORY.name }}</paper-item>
										<paper-item value="ARTICLE">{{ pratilipiTypes.ARTICLE.name }}</paper-item>
										<paper-item value="MAGAZINE">{{ pratilipiTypes.MAGAZINE.name }}</paper-item>
									</paper-menu>
								</paper-dropdown-menu>
							</div>
						</div>
						<template is="dom-if" if="{{ createPratilipi }}">
							<div style="padding: 16px 0 16px 16px;">
								<paper-checkbox class="pratilipi-red" noink>${ _strings.writer_you_own_copyright }</paper-checkbox>
								<br/>
								<a target="_blank" style="color: #333; text-decoration: underline;" href="/terms-of-service">${ _strings.writer_read_copyright }</a>
							</div>
						</template>
						<div class="display-message-div"><p>{{ message }}</p></div>
					</div>
					<div class="modal-footer" style="border: none; padding-top: 0px;">
						<button id="pratilipiWriteButton" type="button" on-click="onSubmit">
							<template is="dom-if" if="{{ createPratilipi }}">${ _strings.writer_to_next_screen }</template>
							<template is="dom-if" if="{{ editPratilipi }}">${ _strings.save_changes }</template>
						</button>
					</div>
				</div>
			</div>
		</div>
		
		<iron-ajax
				id="AjaxPost"
				url="/api/pratilipi"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
	</template>
	
	<script>
		Polymer({

 			is: 'pratilipi-write',
 			
			properties: {
				authorId: { type: String },

				pratilipiId: { type: String },
				title: { type: String },
				titleEn: { type: String },
 				type: { type: String, observer: "_typeObserver" },
 				language: { type: String, observer: "_languageObserver" },
 				state: { type: String },

 				createPratilipi: { type: Boolean },
 				editPratilipi: { type: Boolean },
				pratilipiTypes: { types: Object },
				selected: { type: Number },
 				message: { type: String }
			},
			
			attached: function() {
				this.pratilipiTypes = jQuery.parseJSON( this.pratilipiTypes );
			},
			
			createNewPratilipi: function( authorId ) {
				this.set( 'createPratilipi', true );
				this.set( 'editPratilipi', false );
				this.set( 'authorId', authorId );
				this.process( {} );
				
			},
			
			editExistingPratilipi: function( pratilipi ) {
				this.set( 'editPratilipi', true );
				this.set( 'createPratilipi', false );
				this.set( 'authorId', null );
				this.process( pratilipi );
			},
			
			process: function( pratilipi ) {
				this.set( 'message' , null );
				this.set( 'pratilipiId', pratilipi.pratilipiId == null ? null : pratilipi.pratilipiId );
				this.set( 'title', pratilipi.title == null ? null : pratilipi.title );
				this.set( 'titleEn', pratilipi.titleEn == null ? null : pratilipi.titleEn );
				this.set( 'state', pratilipi.state == null ? "DRAFTED" : pratilipi.state );
				this.set( 'language', pratilipi.language == null ? "${ language }" : pratilipi.language );
				this.set( 'type', pratilipi.type == null ? null : pratilipi.type );
				this.async( function() { jQuery( "#pratilipiWrite" ).modal(); });
			},

			_typeObserver: function() {
				if( this.type != null ) {
					if( this.type == "BOOK" )
						this.set( 'selected', 0 );
					else if( this.type == "POEM" )
						this.set( 'selected', 1 );
					else if( this.type == "STORY" )
						this.set( 'selected', 2 );
					else if( this.type == "ARTICLE" )
						this.set( 'selected', 3 );
					else if( this.type == "MAGAZINE" )
						this.set( 'selected', 4 );
				} else {
					this.set( 'selected', null );
				}
			},

			_languageObserver: function() {
				var languageVernacular = {
						"HINDI" : "${ _strings.language_hi }",
						"GUJARATI" : "${ _strings.language_gu }",
						"TAMIL" : "${ _strings.language_ta }",
						"MARATHI" : "${ _strings.language_mr }",
						"MALAYALAM" : "${ _strings.language_ml }",
						"BENGALI" : "${ _strings.language_bn }",
						"TELUGU" : "${ _strings.language_te }",
						"KANNADA" : "${ _strings.language_kn }"
					};
				this.set( 'languageVernacular', languageVernacular[ this.language ] );
			},

			clearAndClose: function() {
				this.set( 'message', null );
				this.set( 'authorId', null );
				this.set( 'title', null );
				this.set( 'titleEn', null );
				this.set( 'type', null );
				this.set( 'state', null );
				this.set( 'createPratilipi', false );
				this.set( 'editPratilipi', false );
 				jQuery( "#pratilipiWrite" ).modal( 'hide' );
			},

			onSubmit: function( event ) {

				if( this.title == null || this.title.trim() == "" ) {
					this.message = "${ _strings.write_fill_title }";
					return;
				}

				this.type = this.$.selectPratilipiType.selectedItem != null ? this.$.selectPratilipiType.selectedItem.getAttribute( "value" ) : null;
				if( this.type == null ) {
					this.message = "${ _strings.write_select_type }";
					return;
				}

				this.message = "${ _strings.working }";

				var body = {
						title: this.title,
						language: this.language,
						type: this.type,
						state: this.state
				};

				if( this.pratilipiId != null )
					body.pratilipiId = this.pratilipiId;

				if( this.titleEn != null )
					body.titleEn = this.titleEn;

				if( this.authorId != null )
					body.authorId = this.authorId;

				jQuery( '#pratilipiWriteButton' ).prop( 'disabled', true );

				this.$.AjaxPost.body = jQuery.param( body );
				this.$.AjaxPost.generateRequest();
			
			},

			_handleAjaxPostResponse: function( event ) {

				var pratilipi = event.detail.response;

				if( this.createPratilipi )
					this.message = "${ _strings.content_created_success }";
				else if( this.editPratilipi ) 
					this.message = "${ _strings.updated_pratilipi_info_success }";

				jQuery( '#pratilipiWriteButton' ).prop( 'disabled', false );

				if( this.createPratilipi ) {
					// Redirect to writer with return option to pratilipi page
					this.async( function() {
						this.clearAndClose();
						window.location.href = pratilipi.writePageUrl;
					}, 1000 );
				} else if( this.editPratilipi ) {
					document.querySelector( 'pratilipi-pratilipi' ).updatePratilipi( pratilipi );
					this.async( function() {
						this.clearAndClose();
					}, 1000 );
				}
			},

			_handleAjaxPostError: function( event ) {
				jQuery( '#pratilipiWriteButton' ).prop( 'disabled', false );
				if( event.detail.request.xhr.status === 400 || event.detail.request.xhr.status === 401 || event.detail.request.xhr.status === 500 && event.detail.request.xhr.response.message != null )
					this.message = event.detail.request.xhr.response.message;
				else
					this.message = "${ _strings.server_error_message }"
			}
 			
		});

	</script>
	
</dom-module>

<dom-module id="pratilipi-reader-content">

	<style>
		
		:host {
			display: block;
			overflow: hidden;
		}
		
		:host #pager {
			margin-bottom: 5px;
			padding: 16px 22px;
			width: 100%;
		}
		
		:host #pager #reader-content {
			-webkit-font-smoothing: antialiased;
			line-height: 1.6em;
		}
		
		@media only screen and (max-width: 768px) {
			:host #pager #reader-content {
				text-align: left;
			}
		}
		@media only screen and (min-width: 769px) {
			:host #pager #reader-content {
				text-align: justify;
			}
		}
		
		/* Bootstrap override */
		#reader-alert-box {
			color: #333;
			background-color: inherit;
			border-color: #333;
		}

		#reader-alert-box .alert-link, #reader-alert-box .alert-link:hover, #reader-alert-box .alert-link:focus {
			font-weight: inherit;
			color: inherit;
		}

		.alert .social-icons img {
			width: 21px;
			height: 21px;
			margin-left: 12px;
			cursor: pointer;
		}

		.hvr-bounce-in {
			vertical-align: middle;
			-webkit-transform: translateZ(0);
			transform: translateZ(0);
			box-shadow: 0 0 1px rgba(0, 0, 0, 0);
			-webkit-backface-visibility: hidden;
			backface-visibility: hidden;
			-moz-osx-font-smoothing: grayscale;
			-webkit-transition-duration: 0.5s;
			transition-duration: 0.5s;
			max-width: 95%; 
			margin: 30px auto; 
		}


		.hvr-bounce-in:hover, .hvr-bounce-in:focus, .hvr-bounce-in:active {
			-webkit-transform: scale(1.05);
			transform: scale(1.05);
			-webkit-transition-timing-function: cubic-bezier(0.47, 2.02, 0.31, -0.36);
			transition-timing-function: cubic-bezier(0.47, 2.02, 0.31, -0.36);
		}

		.fa {
			margin-left: 15px;
			cursor: pointer;
		}
		
	</style>
	
	
	<template>
	
		<paper-card id="pager">
			<div id="reader-content">
				{{ content }}
			</div>
			<template is="dom-if" if="{{ lastPage }}">
				<div id="reader-alert-box" class="alert alert-success hvr-bounce-in" role="alert">
					<h3 class="text-center" style="margin-top: 24px;">${ _strings.reader_enjoyed_reading_part1 }</h3>
					<div class="text-center" style="margin: 0 auto;">
						<a class="alert-link" on-click="writeReview">
							<h6 style="margin: 15px 0px; display: inline-block;">${ _strings.reader_enjoyed_review_book }</h6>
							<iron-icon icon="icons:create" style="margin-left: 0px; display: inline-block; width: 20px;"></iron-icon>
						</a>
					</div>
					<div id="social-icons" class="social-icons text-center" style="margin: 0 auto;">
						<h6 style="margin: 15px 0px; display: inline-block;">${ _strings.reader_enjoyed_reading_part2 } : </h6>
						<div style="white-space: nowrap; display: inline-block;">
							<img src="http://0.ptlp.co/resource-all/icon/svg/facebook-333.svg" on-click="shareOnFacebook" />
							<img src="http://0.ptlp.co/resource-all/icon/svg/twitter-333.svg" on-click="shareOnTwitter" />
							<img src="http://0.ptlp.co/resource-all/icon/svg/google-plus-333.svg" on-click="shareOnGplus"/>  
						</div>
					</div>
				</div>
			</template>
		</paper-card>
		<iron-ajax
				id="AjaxGet"
				url="/api/pratilipi/content"
				method="GET"
				content-type="application/json"
				handle-as="json"
				on-response="_onResponse"
				on-error="_onError"
				></iron-ajax>
	</template>
	
	
	<script>
		Polymer({
			
			is: 'pratilipi-reader-content',
			
			properties: {
				content: { type: String, observer: "_onContentChange", value: "<paper-spinner class=\"pratilipi-spinner-center\" active></paper-spinner>" },
				contentType: { type: String },
				contentMap: { type: Object, value: {} },

				pratilipiId: { type: Number },
				fontSize: { type: Number, observer: "_onFontSizeChange" },
				imageSize: { type: Number, observer: "_onImageSizeChange" },

				pageNo: { type: Number, observer: "_onPageNoChange" },
				pageCount: { type: Number },

				lastPage: { type: Boolean }

			},
			
			
			// Attached
			attached: function() {
				jQuery( "#pager" ).css( 'min-height', window.innerHeight + "px" );
				this.contentMap[ this.pageNo ] = this.content;
				this.set( 'lastPage', this.pageNo == this.pageCount );

				if( this.contentType == "IMAGE" )
					this._setImageSize();

				this._precache();
			},


			// Font size
			_onFontSizeChange: function() {
				this.async( function() {
					jQuery( "#reader-content" ).css( 'font-size', this.fontSize, "important" );
					jQuery( "#reader-content h2" ).css( 'font-size', this.fontSize + 4, "important" );
					jQuery( "#reader-content h1" ).css( 'font-size', this.fontSize + 8, "important" );
				} );
			},

			_setFontSize: function( fontSize ) {
				this.set( "fontSize", fontSize == null ? 14 : parseInt( fontSize ) );
				setCookie( "fontSize", fontSize, 30, "/read" );
			},

			increaseFontSize: function() {
				// cutoff = 32
				if( this.fontSize + 2 <= 32 )
					this._setFontSize( this.fontSize + 2 );
			},

			decreaseFontSize: function() {
				// cutoff = 12
				if( this.fontSize - 2 >= 12 )
					this._setFontSize( this.fontSize - 2 );
			},
			
			
			// Image Size
			_onImageSizeChange: function() {
				this.async( function() {
					jQuery( "#reader-content img" ).css( 'width', this.imageSize + 'px' );
					if( jQuery( "#reader-content" ).width() < this.imageSize )
						jQuery( "#reader-content" ).css( "overflow", "scroll" );
					else
						jQuery( "#reader-content" ).css( "overflow", "hidden" );	
				} );
			},
			
			_setImageSize: function( imageSize ) {
				this.set( "imageSize", imageSize == null ? jQuery( "#reader-content" ).width() : parseInt( imageSize ) );
			},
			
			increaseImageSize: function() {
				// cutoff = 1500
				if( this.imageSize + 50 <= 1500 )
					this._setImageSize( this.imageSize + 50 );
			},
			
			decreaseImageSize: function() {
				// cutoff = 300
				if( this.imageSize - 50 >= 300 )
					this._setImageSize( this.imageSize - 50 );
			},


			// Content
			_onContentChange: function() {
				jQuery( this.querySelector( '#reader-content' ) ).html( this.content );
				this.async( function() {
					if( this.contentType == "PRATILIPI" )
						jQuery( "#reader-content img" ).css( "max-width", "100%", "important" );
					else if( this.contentType == "IMAGE" )
						this._onImageSizeChange();
				} );

				if( jQuery( window ).scrollTop() > 128 ) {
					this.async( function() {
						jQuery( 'html, body' ).animate( { scrollTop : 0 }, 500 );
					} );
				}
			},

			getImageUrl: function( pageNo ) {
				return "<img src='/api/pratilipi/content?pratilipiId=" + 
							this.pratilipiId + "&" + 
							"pageNo=" + pageNo + 
							"&" + "chapterNo=" + pageNo + "' />";
			},

			_precache: function() {
				if( this.contentType == "PRATILIPI" ) {
					// Check pageNo
					if( this.pageNo > 1 )
						this._loadContent( this.pageNo - 1 );
					if( this.pageNo < this.pageCount )
						this._loadContent( this.pageNo + 1 );
				} else if( this.contentType == "IMAGE" ) {
					// Prefetch images
					if( this.pageNo > 1 )
						jQuery( this.getImageUrl( this.pageNo - 1 ) ).load();
					if( this.pageNo < this.pageCount )
						jQuery( this.getImageUrl( this.pageNo + 1 ) ).load();
				}
			},

			_onPageNoChange: function() {
				// Called before ready function
				if( this.contentMap == null || jQuery.isEmptyObject( this.contentMap ) )
					return;
				
				if( this.contentType == "PRATILIPI" ) {
					if( this.contentMap[ this.pageNo ] != null ) { // Check in Map if exists
						this.set( 'content', this.contentMap[ this.pageNo ] );
					} else {										// Else make api call
						this.set( 'content', "<paper-spinner class=\"pratilipi-spinner-center\" active></paper-spinner>" );
						this._loadContent( this.pageNo );
					}
				} else if( this.contentType == "IMAGE" ) {
					this.set( 'content', this.getImageUrl( this.pageNo ) );
				}
				
				if( !this.lastPage && this.pageNo == this.pageCount )
					this.set( 'lastPage', true );
				else if( this.lastPage && this.pageNo != this.pageCount )
					this.set( 'lastPage', false );

				this._precache();								// Load Previous and next pages

			},

			_loadContent: function( pageNo ) {

				if( pageNo == null || this.contentMap[ pageNo ] != null )
					return;

				var ajaxGet = this.$.AjaxGet;
				ajaxGet.params.pratilipiId = this.pratilipiId;
				ajaxGet.params.chapterNo = pageNo;
				ajaxGet.params.pageNo = pageNo;
				ajaxGet.params.contentType = this.contentType;
				ajaxGet.generateRequest();
			},

			_onResponse: function( event ) {

				var response = event.detail.response;

				// Populate map
				this.contentMap[ response.pageNo ] = response.content;

				// Update content if response page no == this page no
				if( this.pageNo == response.pageNo )
					this.set( 'content', response.content );
			},

			_onError: function( event ) {
				// Show appropriate message
				/* alert( "Sorry! Some exception occurred at the server! Try again" ); */
				// Try again in 3 seconds
			},

			writeReview: function() {
				document.querySelector( 'pratilipi-reader-page' ).writeReview();
			},

			shareOnFacebook: function() {
				document.querySelector( 'pratilipi-reader-page' ).shareOnFacebook( "container" );
			},

			shareOnTwitter: function() {
				document.querySelector( 'pratilipi-reader-page' ).shareOnTwitter( "container" );
			},

			shareOnGplus: function() {
				document.querySelector( 'pratilipi-reader-page' ).shareOnGplus( "container" );
			},

		});

	</script>

</dom-module>
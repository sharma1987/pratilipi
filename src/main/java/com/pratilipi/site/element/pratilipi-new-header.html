<#include "pratilipi-search-bar.html">
<dom-module id="pratilipi-new-header">

	<style>
		:host {
			width: 100%;
			display: block;
		}
		#pratilipi-header-card {
			position: fixed;
			z-index: 10;
			width: 100%;
			display: block;
			border-bottom: 1px solid #d3d3d3;
			box-shadow: 0 3px 2px -2px rgba(200,200,200,0.2);
		}
		.vertical-align {
			display: -webkit-flex;
			display: flex;
			-webkit-flex-flow: row;
			flex-flow: row;
			height: 52px;
			position: relative;
			float: left;
		}
		.vertical-align * {
			align-self: center;
			position: relative;
		}
		.pratilipi-logo {
			-webkit-flex-basis: 46px;
			flex-basis: 46px;
		}
		.pratilipi-text {
			font-size: 18px;
			<#if lang == "ta">
				font-size: 14px;
				margin-left: 0px;
			</#if>
			<#if lang == "ml">
				font-size: 16px;
				margin-left: 0px;
			</#if>
			font-weight: 700;
			white-space: nowrap;
			cursor: pointer;
		}
		.pratilipi-text paper-menu {
			width: 108px;
			padding: 0;
		}
		.pratilipi-text paper-item.language-font {
			font-size: 14px;
			font-weight: 700;
		}
		a.pratilipi-black {
			color: #333 !important;
		}
		form.search-form {
			margin-top: -20px;
		}
		form.search-form paper-input paper-icon-button {
			width: 32px;
			height: 32px;
			padding: 4px;
		}
		.search-input paper-icon-button.menu-icon-search-bar {
			margin-left: -4px;
		}
		.button-holder {
			flex-basis: 48px;
			white-space: nowrap;
			text-align: right;
		}
		.button-holder a, .button-holder a:hover, .button-holder a:focus {
			color: #4c4c4c!important;
		}
		.button-holder a iron-icon {
			height: 28px;
			width: 28px;
		}
		.sign-in-button {
			white-space: nowrap;
		}
		.sign-in-button a span {
			color: #4c4c4c!important;
			font-size: 13px;
			font-weight: 400;
			margin-left: 2px;
		}
		.sign-in-button .btn-primary {
			color: #fff;
			background-color: #107fe5;
			border-color: #107fe5;
			border-radius: 0;
			outline: none;
			padding: 6px 8px;
		}
		.sign-in-button .btn-primary iron-icon {
			width: 20px;
			height: 20px;
		}
		.sign-in-button .btn-primary span {
			font-size: 12px;
			font-weight: 400;
		}
		.button-outside-container {
			display: none;
		}
		@media only screen and (max-width: 767px) {
			.vertical-align {
				height: 48px;
			}
			.pratilipi-logo {
				-webkit-flex: 1;
				flex: 1;
				padding-left: 8px;
			}
			#pratilipi-header-card {
				border: none;
				box-shadow: none;
			}
			.pratilipi-text {
				display: none;
			}
			.search-bar {
				display: none;
			}
			.button-holder {
				flex: 1;
				text-align: center;
			}
			.sign-in-button {
				display: none;
			}
		}
		@media only screen and (min-width: 768px) and (max-width: 1199px) {
			.search-bar {
				flex-grow: 1;
				padding-left: 4px;
				padding-right: 4px;
			}
			.sign-in-text, .menu-icon, .search-icon {
				display: none;
			}
			.sign-in-button {
				margin-left: 12px;
				margin-top: 2px;
			}
		}
		@media only screen and (min-width: 992px) {
			.pratilipi-text {
				-webkit-flex-basis: 139px;
				flex-basis: 139px;
			}
			.search-input paper-icon-button.menu-icon-search-bar {
				display: none;
			}
		}
		@media only screen and (min-width: 1200px) {
			.search-bar {
				flex-grow: 1;
			}
			.sign-in-text, .menu-icon, .search-icon {
				display: none;
			}
			.button-inside-container {
				display: none;
			}
			.button-outside-container {
				display: inline-block;
				position: relative;
				left: 12px;
				line-height: 52px;
			}
		}
		
		paper-input.search-input {
	        --paper-input-container-focus-color: #d0021b;
	        font-size: 13px;
			--paper-input-container-input: {
				font-size: 16px;
			 };
		}
		paper-input.search-input /deep/ ::-webkit-input-placeholder {
			font-size: 13px;
			font-family: inherit;
		}
		paper-input.search-input /deep/ ::-moz-placeholder {
			font-size: 13px;
			font-family: inherit;
		}
		paper-input.search-input /deep/ :-ms-input-placeholder {
			font-size: 13px;
			font-family: inherit;
		}
		paper-badge.pratilipi-red {
			--paper-badge-background: #d0021b;
		}
	</style>

	<template>
		<div class="secondary-500" id="pratilipi-header-card">
			<div class="parent-container">
				<div class="vertical-align container">
					<div class="pratilipi-logo">
						<a href="/">
							<iron-image sizing="contain" style="width: 46px; height: 46px; margin-top: 6px;" 
										title="${ _strings.pratilipi }" alt="${ _strings.pratilipi }" 
										src="http://0.ptlp.co/resource-${ lang }/logo/pratilipi_logo.png"></iron-image>
						</a>
					</div>
					<div class="pratilipi-text">
						<paper-menu-button allow-outside-scroll no-animations vertical-offset=36 class="language" horizontal-align="left" vertical-align="top">
							<div class="pratilipi-red dropdown-trigger">
								${ _strings.pratilipi }
								<iron-icon icon="icons:arrow-drop-down"></iron-icon>
							</div>
							<paper-menu class="dropdown-content" role="listbox">
								<template is="dom-repeat" items="{{ languageArray }}" as="language">
									<template is="dom-if" if="{{ !language.current }}">
										<a class="pratilipi-black" href="{{ language.link }}">
											<paper-item class="language-font">{{ language.value }}</paper-item>
										</a>
									</template>
									<template is="dom-if" if="{{ language.current }}">
										<paper-item class="language-font pratilipi-red" selected>{{ language.value }}</paper-item>
									</template>
								</template>
							</paper-menu>
						</paper-menu-button>
					</div>
					<div class="button-holder menu-icon">
						<a on-click="_openMenuNavigation">
							<iron-icon id="pratilipi-header-notification-badge" icon="icons:menu"></iron-icon>
						</a>
						<template is="dom-if" if="{{ showNotificationCount }}">
							<paper-badge for="pratilipi-header-notification-badge" label="{{ newNotificationCount }}" class="pratilipi-red"></paper-badge>
						</template>
					</div>
					<div class="search-bar">
						<form id="search-form" class="search-form" action="javascript:void(0);" on-keyup="onSubmit">
							<paper-input id="search-input" class="search-input" name="q" type="search" placeholder="${ _strings.search_bar_help }" onfocus="this.placeholder = ''" onblur="this.placeholder = '${ _strings.search_bar_help }'" value="{{ query::input }}">
								<paper-icon-button suffix icon="icons:search" noink on-click="onSubmit"></paper-icon-button>
								<paper-icon-button prefix class="menu-icon-search-bar" icon="icons:menu" noink on-click="_openMenuNavigation"></paper-icon-button>
							</paper-input>
						</form>
					</div>
					<div class="button-holder">
						<a on-click="_write">
							<iron-icon icon="icons:create"></iron-icon>
						</a>
					</div>
					<div class="button-holder">
						<a on-click="_gotoLibrary">
							<iron-icon icon="icons:book"></iron-icon>
						</a>
					</div>
					<div class="button-holder">
						<a on-click="_notifications">
							<iron-icon icon="social:notifications"></iron-icon>
						</a>
					</div>
					<div class="button-holder sign-in-text">
						<template is="dom-if" if="{{ isGuest }}">
							<a on-click="_logIn">
								<iron-icon icon="social:person"></iron-icon>
							</a>
						</template>
						<template is="dom-if" if="{{ !isGuest }}">
							<a href="{{ profilePageUrl }}">
								<img class="img-circle pratilipi-shadow" style="width: 32px; height: 32px;"
									alt="{{ displayName }}" src="{{ profileImageUrl }}" />
							</a>
						</template>
					</div>
					<div class="sign-in-button button-inside-container">
						<template is="dom-if" if="{{ isGuest }}">
							<button class="btn btn-primary" on-click="_logIn">
								<iron-icon icon="social:person"></iron-icon>
								<span>${ _strings.user_sign_in }</span>
							</button>
						</template>
						<template is="dom-if" if="{{ !isGuest }}">
							<a href="{{ profilePageUrl }}">
								<img class="img-circle pratilipi-shadow" style="width: 32px; height: 32px;"
									alt="{{ displayName }}" src="{{ profileImageUrl }}" />
								<span>{{ displayName }}</span>
							</a>
						</template>
					</div>
				</div>
				<div class="sign-in-button button-outside-container">
					<template is="dom-if" if="{{ isGuest }}">
						<button class="btn btn-primary" on-click="_logIn">
							<iron-icon icon="social:person"></iron-icon>
							<span>${ _strings.user_sign_in }</span>
						</button>
					</template>
					<template is="dom-if" if="{{ !isGuest }}">
						<a href="{{ profilePageUrl }}">
							<img class="img-circle pratilipi-shadow" style="width: 32px; height: 32px;"
								alt="{{ displayName }}" src="{{ profileImageUrl }}" />
							<span>{{ displayName }}</span>
						</a>
					</template>
				</div>
			</div>
		</div>
		<pratilipi-search-bar language-map="{{ languageMap }}" query="{{ query }}" class="visible-xs hidden-sm hidden-md hidden-lg"></pratilipi-search-bar>
		<iron-ajax
				id="NotificationListApi"
				url="/api/notification/list"
				method="GET"
				content-type="application/json"
				handle-as="json"
				on-response="_notificationListApiResponse"
				></iron-ajax>
	</template>


	<script>

		Polymer({
			
			is: 'pratilipi-new-header',
			
			properties: {
				user: { type: Object, observer: "_userChanged" },
				query: { type: String },
				isGuest: { type: Boolean },
				profilePageUrl: { type: String },
				profileImageUrl: { type: String },
				displayName: { type: String },
				
				writeButtonActive: { type: Boolean, value: false },
				languageMap: { type: Object },
				languageArray: { type: Array, value: function() { return []; } }
			},
			
			_userChanged: function() {
				if( ! this.user.isGuest && this.writeButtonActive ) {
					this.set( 'writeButtonActive', false );
					this.async( function() {
						this.write();
					}, 1000 );
				}
				this.set( 'isGuest', this.user.isGuest );
				this.set( 'profilePageUrl', this.user.profilePageUrl );
				this.set( 'displayName', this.user.displayName );
				this.set( 'profileImageUrl', this.user.profileImageUrl != null ? 
													( this.user.profileImageUrl + ( this.user.profileImageUrl.indexOf( '?' ) == -1 ? '?' : '&' ) + "width=48" )
													: "http://0.ptlp.co/author/image?width=48" );
				if( ! this.user.isGuest )
					this.getNotificationCount();
				else
					this.set( 'showNotificationCount', false );
			},
			
			_logIn: function() {
				document.querySelector( 'pratilipi-user' ).logIn();
			},
			
			_write: function() {
				if( this.user.isGuest ) {
					this.set( 'writeButtonActive', true );
					document.querySelector( 'pratilipi-user' ).logIn( true );
					return;
				}
				this.set( 'writeButtonActive', false );
				var windowsize = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
				if( windowsize < 768 )
					document.querySelector( 'pratilipi-alert' ).alert( '${ _strings.write_on_desktop_only }' );
				else 
					document.querySelector( 'pratilipi-write' ).createNewPratilipi();
			},
			
			_gotoLibrary: function() {
				if( this.user.isGuest )
					document.querySelector( 'pratilipi-user' ).logIn( true );
				else
					window.location.href = "/library";
			},

			_notifications: function() {
				if( this.user.isGuest )
					document.querySelector( 'pratilipi-user' ).logIn( true );
				else
					window.location.href = "/notification";
			},

			_openMenuNavigation: function() {
				document.querySelector( 'pratilipi-navigation-drawer' ).show();
			},
			
			onSubmit: function( event ) {
				if( event.keyCode != null && event.keyCode != 0 && event.keyCode != 13 || this.query == null || this.query.trim() == "" )
					return;
				var str = decodeURI( window.location.pathname );
				if( str == "/search" ) {
					document.querySelector( 'pratilipi-card-grid' ).setSearchQuery( jQuery( "#search-input" ).val() );
				} else {
					jQuery( "#search-form" ).prop( "action", "/search" );
					jQuery( "#search-form" ).submit();
				}
			},

			ready: function() {
				for( var language in this.languageMap ) {
					this.push( 'languageArray', { 
									"link": "http://" + language.toLowerCase() + ".pratilipi.com/", 
									"value": this.languageMap[ language ],
									"current" : language == "${ language }"
									} );
				}
			},
			
			getNotificationCount: function() {
				this.$.NotificationListApi.generateRequest();
			},

			_notificationListApiResponse: function( response ) {
				this.set( 'newNotificationCount', response.detail.response.newNotificationCount );
				this.set( 'showNotificationCount', response.detail.response != null
						&& response.detail.response.newNotificationCount != null 
						&& response.detail.response.newNotificationCount > 0 );
			}
			
		});

	</script>

</dom-module>
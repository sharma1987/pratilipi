<dom-module id="pratilipi-card-mini">

	<style>

		:host {
			display: inline-block;
			text-align:center;
			margin-bottom: 16px;
		}
		
		.pratilipi-card {
			display: flex;
			cursor: pointer;
			border-top: 1px solid #d3d3d3;
		}
		
		.pratilipi-card .button-holders {
			align-self: center;
			margin: auto;
			padding-left: 8px;
			padding-right: 8px;
		}

		.pratilipi-card .button-holders h6 {
			margin: 0;
			margin-bottom: 16px;
			font-size: 16px;
			line-height: 22px;
			font-weight: 500;
		}

		.pratilipi-card .button-holders button {
			display: block;
			cursor: pointer;
			margin: 8px auto;
		}

		.pratilipi-card .button-holders .btn {
			white-space: normal;
			border-radius: 4px;
			outline: none;
		}

		.pratilipi-card paper-fab {
			position: absolute;
			width: 24px;
			height: 24px;
			--paper-fab-background: #F5F5F5;
			--paper-fab-iron-icon: {
				color: #333;
				width: 16px;
				height: 16px;
			}
		}

		.ellipsed, a.ellipsed:hover, a.ellipsed:focus {
			line-height: 24px;
			text-align: left;
			color: #000;
			display: block;
			font-size: 14px;
		}
		
		.pratilipi-title {
			font-weight: 700;
		}
		
		.white-snippet, .white-snippet-reduced {
			text-decoration: none;
			float: left;
			width: inherit;
			background: linear-gradient(to bottom, rgba(255, 255, 255, 0.65) 0%, #fbfbfb 100%);
			text-align: center;
			color: #333;
		}
		
		.white-snippet {
			height: 60px;
			padding: 4px 8px;
		}
		
		.white-snippet-reduced {
			height: 45px;
			padding: 8px;
		}
		
		.meta-container {
			color: #7e7e7e;
			text-align: left;
			padding-bottom: 10px;
			background: #fbfbfb;
		}
		
		.read-rating-count {
			font-size: 14px;
		}
		
		.read-rating-count iron-icon {
			width: 15px; 
			height: 15px;
			margin-top: -2px;
		}
		@media only screen and (max-width: 599px) {
			:host {
				width: 120px;
			}
			.pratilipi-card {
				width: 120px;	
				height: 180px;
			}
			.pratilipi-card paper-fab {
				top: 6px;
				margin-left: 4px;
			}
			.white-snippet {
				margin-top: calc( 180px - 60px - 28px );
			}
			.white-snippet-reduced {
				margin-top: calc( 180px - 45px - 28px );
			}
			.meta-container {
				height: 28px;
				margin-top: -28px;
			}
		}
		@media only screen and (min-width: 600px) {
			:host {				
				width: 160px;		
			}
			.pratilipi-card {
				width: 160px;
				height: 240px;
			}
			.pratilipi-card paper-fab {
				top: 170px;
				margin-left: 132px;
			}
			.white-snippet {
				margin-top: calc( 240px - 60px - 32px );
				
			}
			.white-snippet-reduced {
				margin-top: calc( 240px - 45px - 32px );
			}
			.meta-container {
				height: 32px;
				margin-top: -32px;
			}
		}
	</style>


	<template>
		<div class="pratilipi-shadow">
			<template is="dom-if" if="{{ showContent }}">
				<span style="background-image: url( {{ pratilipiCoverImage }} );" class="pratilipi-card" on-click="redirectToContentPage" title="{{ fullTitle }}">
					<template is="dom-if" if="{{ showEditOption }}">
						<template is="dom-if" if="{{ hasAccessToUpdate }}">
							<paper-fab mini icon="icons:create" on-click="showEditFunction"></paper-fab>
						</template>
					</template>
					<template is="dom-if" if="{{ pratilipi.author }}">
						<div class="white-snippet">
							<div class="contain-title ellipsed pratilipi-title">{{ title }}</div>
							<a href="{{ pratilipi.author.pageUrl }}"><span class="contain-title ellipsed">{{ pratilipi.author.name }}</span></a>
						</div>
					</template>
					<template is="dom-if" if="{{ !pratilipi.author }}">
						<div class="white-snippet-reduced">
							<div class="contain-title ellipsed pratilipi-title">{{ title }}</div>
						</div>
					</template>
				</span>
			</template>
			<template is="dom-if" if="{{ showEditContent }}">
				<div style="background: #fbfbfb;" class="pratilipi-card" title="{{ fullTitle }}">
					<div class="button-holders">
						<template is="dom-if" if="{{ canMoveToDrafts }}">
							<button class="btn btn-primary" on-click="confirmMoveContentToDrafts">${ _strings.pratilipi_move_to_drafts }</button>
						</template>
						<template is="dom-if" if="{{ canPublish }}">
							<button class="btn btn-success" on-click="publishContent">${ _strings.pratilipi_publish_it }</button>
						</template>
						<template is="dom-if" if="{{ canDelete }}">
							<button class="btn btn-danger" on-click="confirmDeleteContent">${ _strings.pratilipi_delete_content }</button>
						</template>
						<button class="btn btn-default" on-click="cancelEditFunction">${ _strings.cancel }</button>
					</div>
				</div>
			</template>
			<template is="dom-if" if="{{ showDraftsContent }}">
				<div style="background: #fbfbfb;" class="pratilipi-card" title="{{ fullTitle }}">
					<div class="button-holders">
						<h6>Do you want it to move to drafts?</h6>
						<button class="btn btn-danger" on-click="moveContentToDrafts">Yes</button>
						<button class="btn btn-default" on-click="cancelEditFunction">${ _strings.cancel }</button>
					</div>
				</div>
			</template>
			<template is="dom-if" if="{{ showDeleteContent }}">
				<div style="background: #fbfbfb;" class="pratilipi-card" title="{{ fullTitle }}">
					<div class="button-holders">
						<h6>Do you want it to delete the content?</h6>
						<button class="btn btn-danger" on-click="deleteContent">Yes</button>
						<button class="btn btn-default" on-click="cancelEditFunction">${ _strings.cancel }</button>
					</div>
				</div>
			</template>

			<div class="meta-container">
				<template is="dom-if" if="{{ showRating }}">
					<span class="read-rating-count pull-left" style="margin-left: 8px;">
						{{ averageRating }}
						<iron-icon icon="icons:star"></iron-icon>
					</span>
				</template>
			 	<span class="read-rating-count pull-right" style="margin-right: 8px;">
					<iron-icon icon="icons:chrome-reader-mode"></iron-icon>
					{{ readText }}
				</span>
			</div>
		</div>
	</template>


	<script>
		function abbrNum( n, d ) {
			if( n < 1000 ) return n;
			x = ( '' + n ).length, p = Math.pow, d = p( 10,d );
			x -= x % 3;
			return Math.round( n * d / p ( 10, x ) ) / d + " kMGTPE" [ x / 3 ]; 
		}

		Polymer({

			is: 'pratilipi-card-mini',

			properties: {
				pratilipi: { type: Object, observer: "_pratilipiObserver" },
				state: { type: String, observer: "_stateObserver" },
				showEditOption: { type: Boolean, value: false },

				showContent: { type: Boolean, value: true },
				showEditContent: { type: Boolean, value: false },
				showDraftsContent: { type: Boolean, value: false },
				showDeleteContent: { type: Boolean, value: false }
			},
			
			_stateObserver: function() {
				this.canMoveToDrafts = this.state != "DRAFTED";
				this.canPublish = this.state != "PUBLISHED";
				this.canDelete = this.state != "DELETED" && this.state != "PUBLISHED";
			},

			_pratilipiObserver: function() {
				if( this.pratilipi.title != null && this.pratilipi.title.trim() != "" && this.pratilipi.titleEn != null && this.pratilipi.titleEn.trim() != null )
					this.fullTitle = this.pratilipi.title + " | " + this.pratilipi.titleEn;
				else if( this.pratilipi.title != null && this.pratilipi.title.trim() != "" )
					this.fullTitle = this.pratilipi.title;
				else
					this.fullTitle = this.pratilipi.titleEn;
				this.title = this.pratilipi.title != null && this.pratilipi.title.trim() != "" ? this.pratilipi.title : this.pratilipi.titleEn;
				var width = jQuery( window ).width() > 768 ? "160" : "120";
				this.pratilipiCoverImage = this.pratilipi.coverImageUrl + ( this.pratilipi.coverImageUrl.indexOf( '?' ) == -1 ? "?" : "&" ) + "width=" + width;
				this.averageRating = Math.round( this.pratilipi.averageRating * 10 ) / 10 ;
				this.readText = abbrNum( this.pratilipi.readCount, 1 );
				this.showRating = this.pratilipi.averageRating == 0 ? false : true;
				this.hasAccessToUpdate = this.pratilipi.hasAccessToUpdate;
			},
			
			redirectToContentPage: function() {
				if( ! this.showEditContent )
					window.location.href = this.pratilipi.pageUrl;
			},

			showEditFunction: function() {
				this.set( 'showContent', false );
				this.set( 'showEditContent', true );
			},

			cancelEditFunction: function() {
				this.set( 'showEditContent', false );
				this.set( 'showDraftsContent', false );
				this.set( 'showDeleteContent', false );
				this.set( 'showContent', true );
			},

			confirmMoveContentToDrafts: function() {
				this.set( 'showEditContent', false );
				this.set( 'showDraftsContent', true );
			},

			confirmDeleteContent: function() {
				this.set( 'showEditContent', false );
				this.set( 'showDeleteContent', true );
			},

			moveContentToDrafts: function() {
				this.domHost.moveContentToDrafts( this.pratilipi.pratilipiId );
			},

			publishContent: function() {
				this.domHost.publishContent( this.pratilipi.pratilipiId );
			},

			deleteContent: function() {
				this.domHost.deleteContent( this.pratilipi.pratilipiId );
			}
		
		});

	</script>

</dom-module>
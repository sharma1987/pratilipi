<link rel="import" href="pratilipi-facebook-login.html" />


<dom-module id="pratilipi-user-login">

	<style>

		paper-input.pratilipi-blue {
			--paper-input-container-focus-color: #107FE5;
			--paper-input-container-label: {
				font-size: 16px;
				font-family: Helvetica,'Noto Sans Tamil', sans-serif;
			};
			--paper-input-container-input: {
				font-size: 16px;
				font-family: Helvetica,'Noto Sans Tamil', sans-serif;
			};
		}
		
	</style>

	<template>
		
		<div class="modal fade" id="pratilipiUserLogin" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h6 style="margin: 0px; padding: 0px; font-weight: 700;">${ _strings.user_sign_in_to_pratilipi }</h6>
						<span style="float: right; margin-top: -25px; margin-right: -10px;"><paper-icon-button noink icon="close" data-dismiss="modal"></paper-icon-button></span>
					</div>
					<div class="modal-body" on-keyup="onSubmit">
						<pratilipi-facebook-login></pratilipi-facebook-login>
						<div style="margin: 20px 10px;">
							<div style="height: 2px; background-color: #f5f5f5; text-align: center;">
								<span style="background-color: white; position: relative; top: -1em;">
									&nbsp;&nbsp;OR&nbsp;&nbsp;
								</span>
							</div>
							<paper-input class="pratilipi-blue" label="${ _strings.user_email }" value="{{ email::input }}">
								 <iron-icon style="margin-right: 5px;" icon="mail" prefix></iron-icon>
							</paper-input>
							<paper-input class="pratilipi-blue" label="${ _strings.user_password }" type="password" value="{{ password::input }}">
								<iron-icon style="margin-right: 5px;" icon="lock" prefix></iron-icon>
							</paper-input>
							<div class="text-center">
								<span class="text-center">{{ message }}</span>
							 	<br/>
								<br style="line-height: 10px;"/>
								<button id="loginButton" class="pratilipi-dark-blue-button" on-click="onSubmit">${ _strings.user_sign_in }</button>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<div class="row">
							<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6 text-center">
								<a style="font-size: 13px; font-weight: 300; left; color: #D0021B;" href="#" on-click="resetPassword">${ _strings.user_forgot_password }</a>
							</div>
							<div class="col-xs-12 col-sm-6 col-md-6 col-lg-6 text-center">
								<span style="font-size: 13px; font-weight: 300; color: #9B9B9B;">${ _strings.user_is_new }</span>
								<a style="font-size: 13px; font-weight: 300; color: #107FE5;" href="#" on-click="register">${ _strings.user_sign_up_for_pratilipi }</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	
		<iron-ajax
				id="AjaxPost"
				url="/api/user/login"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
		
	</template>
	
	
	<script>

		Polymer({

 			is: 'pratilipi-user-login',

			properties: {
				email: { type: String, value: null },
				password: { type: String, value: null },
				message: { type: String, value: null }
			},
			
			register: function() {
				document.querySelector( 'pratilipi-user' ).register();
			},
			
			resetPassword: function() {
				document.querySelector( 'pratilipi-user' ).resetPassword();
			},
			
			open: function() {
				this.async( function() {
					jQuery( "#pratilipiUserLogin" ).modal();
				});
			},
			
			close: function() {
				jQuery( "#pratilipiUserLogin" ).modal( 'hide' );
			},
			
			onSubmit: function( event ) {
				this.message = null;
				
				if( event.keyCode != null && event.keyCode != 0 && event.keyCode != 13 )
					return;
				
				if( this.email == null || this.password == null || this.email.trim() == "" ) {
					this.message = "Please fill in the details";
					return;
				}
				
				this.message = "Working ...";
				jQuery( '#loginButton' ).prop( 'disabled', true );
				
				this.$.AjaxPost.body = ( "email=" + this.email + "&" + "password=" + this.password );
				this.$.AjaxPost.generateRequest();
			},
			
			_handleAjaxPostResponse: function( event ) {
				this.message = null;
				if( event.detail.xhr.status == 0 ) {
					this.message = "Could not connect to server !";
				} else {
					this.message = "Success !";
					this.async( function() {
						this.email = null;
						this.password = null;
						this.message = null;
						jQuery( '#loginButton' ).prop( 'disabled', false );
						this.close();
					}, 1000 );
					
					document.querySelector( 'pratilipi-user' ).updateUser( event.detail.response );
				}
			},

			_handleAjaxPostError: function( event ) {
				this.message = null;
				jQuery( '#loginButton' ).prop( 'disabled', false );
				if( event.detail.request.xhr.status == 400 ) {
					this.message = event.detail.request.xhr.response.email != null ? event.detail.request.xhr.response.email : "Invalid Email!"; 
					this.message = event.detail.request.xhr.response.message != null ? event.detail.request.xhr.response.message : "Invalid Credentials!";
				} else {
					if( event.detail.request.xhr.response !== null )
						this.message = event.detail.request.xhr.response.message;
					else
						this.message = "Some exception occured at the server, please try again!";
				}
			},
			
		});

	</script>
	
</dom-module>
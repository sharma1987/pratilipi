<link rel="import" href="pratilipi-rating-input.html?123">

<dom-module id="pratilipi-review-input">

	<style>
		
		:host {
			display: block;
		}
		
		paper-textarea.pratilipi-blue {
			display: block;
			--paper-input-container-color: #107FE5;
			--paper-input-container-focus-color: #107FE5;
			--paper-input-container-input-color: #333;
			--paper-input-container-input: {
				font-family: Helvetica,'Noto Sans Tamil', sans-serif;
			};
			--paper-input-container-label: {
				font-size: 15px;
				font-family: Helvetica,'Noto Sans Tamil', sans-serif;
				text-align: left;
			};
		}
		
		.modal-fullscreen .modal-dialog .modal-content {max-width: 900px;padding-top:5px;}
		.modal-fullscreen-heading{line-height: 2;}
		
	</style>

	
	<template>
		<div class="modal modal-fullscreen fade" id="pratilipiReviewInput" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-fullscreen-close-button">
						<paper-icon-button noink icon="close" data-dismiss="modal"></paper-icon-button>
					</div>
					<img title="${ _strings.pratilipi }" alt="${ _strings.pratilipi }" src="http://0.ptlp.co/resource-${ lang }/logo/pratilipi_logo.png" />
					<h6 class="modal-fullscreen-heading">{{ pratilipi.title }} - ${ _strings.review_write_a_review }</h6>
					<p class="text-muted text-center">${ _strings.review_content_help }</p>
					<div style="height: 2px; background-color: #FFF; text-align: center; margin-top: 30px; margin-bottom: 10px;"></div>
					<div id="pratilipi-review-row">
						<div id="pratilipi-review-col-left" style="max-width: 175px;">
							<img style="max-width: 175px;" class="pratilipi-shadow" src="{{ pratilipiCoverImageUrl }}" alt="{{ pratilipi.title }}" title="{{ pratilipi.titleEn }}"/>
							<h6 style="font-weight: 700; text-align: center;" class="text-muted">{{ pratilipi.title }}</h6>
							<h6 style="font-weight: 400; text-align: center;" class="text-muted">{{ pratilipi.author.name }}</h6>
						</div>
						<div style="padding-left: 15px; padding-right: 15px;" id="pratilipi-review-col-right">
							<pratilipi-rating-input value="{{ rating }}"></pratilipi-rating-input>
							<pratilipi-input label="${ _strings.review_title }" value="{{ reviewTitle::input }}" icon="icons:description"></pratilipi-input>
							<div style="margin-top: 25px; margin-bottom: 5px; text-align: left;"><span class="pratilipi-blue" style="font-size: 14px;">${ _strings.review_content }</span></div>
							<script language="javascript" type="text/javascript">tinymce.init({ selector:'#reviewInput', editor_selector : "reviewInput", height: "200", content_css : "https://storage.googleapis.com/devo-pratilipi.appspot.com/custom.css", language: '${ _strings.tinymce_language }', menubar: false, toolbar: 'styleselect | bold italic underline | link image', });</script>
							<paper-textarea class="review" id="reviewInput" value="{{ review::input }}"></paper-textarea>
							<div class="display-message-div">
								<p>{{ message }}</p>
							</div>
							<button id="editReviewButton" class="pratilipi-blue-button" on-click="createOrEditReview">${ _strings.review_submit_review }</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<div class="modal fade" id="deleteReview">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h6 class="modal-heading">${ _strings.review_delete_review }</h6>
						<span class="modal-close-button"><paper-icon-button noink icon="close" data-dismiss="modal"></paper-icon-button></span>
					</div>
					<div class="modal-body">
						${ _strings.review_delete_review_confirm }
					</div>
					<div class="modal-footer">
						<button id="deleteReviewButton" class="btn btn-danger pull-left" on-click="deleteReview">${ _strings.review_delete_okay }</button>
						<button class="btn btn-primary pull-right" on-click="closeDeleteReview">${ _strings.review_delete_cancel }</button>
					</div>
				</div>
			</div>
		</div>
		
		<iron-ajax
				id="AjaxPost"
				url="/api/userpratilipi"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
	</template>
	

	<script>

		Polymer({

			is: 'pratilipi-review-input',

			properties: {
				// Display Object
				pratilipi: { type: Object },
				
				// Userpratilipi
				pratilipiId: { type: String },
				rating: { type: Number },
				reviewTitle: { type: String },
				review: { type: String },
				reviewState: { type: String },
				
				// Specific to modal message.
				message: { type: String }
			},
			
			behaviors: [		
				Polymer.IronResizableBehavior		
			],
			
			listeners: {
				'iron-resize': '_onIronResize'
			},
			
			_onIronResize: function() {
				var windowsize = this.clientWidth;
				if( windowsize > 600 ) {
					jQuery( '#pratilipi-review-row' ).removeClass( 'row-mobile' );
					jQuery( '#pratilipi-review-col-left' ).removeClass( 'col-left-mobile' );
					jQuery( '#pratilipi-review-col-right' ).removeClass( 'col-right-mobile' );
					
					jQuery( '#pratilipi-review-row' ).addClass( 'row-widescreen' );
					jQuery( '#pratilipi-review-col-left' ).addClass( 'col-left-widescreen' );
					jQuery( '#pratilipi-review-col-right' ).addClass( 'col-right-widescreen' );
				}
				else {
					jQuery( '#pratilipi-review-row' ).removeClass( 'row-widescreen' );
					jQuery( '#pratilipi-review-col-left' ).removeClass( 'col-left-widescreen' );
					jQuery( '#pratilipi-review-col-right' ).removeClass( 'col-right-widescreen' );
					
					jQuery( '#pratilipi-review-row' ).addClass( 'row-mobile' );
					jQuery( '#pratilipi-review-col-left' ).addClass( 'col-left-mobile' );
					jQuery( '#pratilipi-review-col-right' ).addClass( 'col-right-mobile' );
				}
			},
			
			attached: function() {
				this.pratilipiCoverImageUrl = this.pratilipi.coverImageUrl + "&" + "width=175";
			},
			
			process: function( userpratilipi ) {
				this.pratilipiId = userpratilipi.pratilipiId == null ? null : userpratilipi.pratilipiId; 
				this.rating = userpratilipi.rating == null ? null : userpratilipi.rating;
				this.reviewTitle = userpratilipi.reviewTitle == null ? null : userpratilipi.reviewTitle;
				this.review = userpratilipi.review == null ? "" : userpratilipi.review;
				if( tinyMCE != null && tinyMCE.get( 'reviewInput' ) != null )
					tinyMCE.get( 'reviewInput' ).setContent( this.review );
				this.reviewState = userpratilipi.reviewState == null ? null : userpratilipi.reviewState;
			},
			
			openReviewInput: function( userpratilipi ) {
				this.process( userpratilipi );
				this.async( function() {
					jQuery( "#pratilipiReviewInput" ).modal();
				});
			},
			
			openDeleteReview: function( pratilipiId ) {
				this.pratilipiId = pratilipiId;
				this.async( function() {
					jQuery( "#deleteReview" ).modal();
				});
			},
			
			closeReviewInput: function() {
				jQuery( "#pratilipiReviewInput" ).modal( 'hide' );
			},
			
			closeDeleteReview: function() {
				jQuery( "#deleteReview" ).modal( 'hide' );
			},
			
			deleteReview: function() {
				// Change state and make Post call.
				jQuery( '#deleteReviewButton' ).prop( 'disabled', true );
				var body = { pratilipiId: this.pratilipiId, reviewState: "DELETED" };
				this.$.AjaxPost.body = jQuery.param( body );
				this.$.AjaxPost.generateRequest();
			},
			
			createOrEditReview: function( event ) {
				
				this.message = "${ _strings.saving }";
				jQuery( '#editReviewButton' ).prop( 'disabled', true );
				
				if( tinyMCE != null && tinyMCE.activeEditor != null )
					this.review = tinyMCE.get( 'reviewInput' ).getContent();
				
				this.review = this.review.replace( /(style=("|\Z|')(.*?)("|\Z|'))|(class=("|\Z|')(.*?)("|\Z|'))|<style>.*?<\/style>/g, "" );
				this.review = JSON.stringify( this.review );
				this.review = this.review.substring( 1, this.review.length - 1 );
				
				var body = {
					pratilipiId : this.pratilipiId,
					rating : this.rating,
					reviewTitle : this.reviewTitle,
					review : this.review
			    };
				
				this.$.AjaxPost.body = jQuery.param( body );
				this.$.AjaxPost.generateRequest();
			},
			
			_handleAjaxPostResponse: function( event ) {
				if( event.detail.xhr.status == 0 ) {
					this.message = "Could not connect to server !";
				} else {
					this.message = "${ _strings.updated_review }";
					document.querySelector( 'pratilipi-userpratilipi' ).setUserPratilipi( event.detail.response );
					this.async( function() {
						this.message = null;
						jQuery( '#editReviewButton' ).prop( 'disabled', false );
						jQuery( '#deleteReviewButton' ).prop( 'disabled', false );
						this.closeReviewInput();
						this.closeDeleteReview();
					}, 1000 );
				}
			},

			_handleAjaxPostError: function( event ) {
				jQuery( '#editReviewButton' ).prop( 'disabled', false );
				jQuery( '#deleteReviewButton' ).prop( 'disabled', false );
				if( event.detail.request.xhr.status == 400 ) {
					this.message = event.detail.request.xhr.response;
				} else if( event.detail.request.xhr.status == 401 ) {
					this.message = null;
					this.closeReviewInput();
					this.closeDeleteReview();
					document.querySelector( 'pratilipi-user' ).logIn();
				} else {
					this.message = event.detail.request.xhr.response.message;
				}
			}

		});
		
	</script>

</dom-module>
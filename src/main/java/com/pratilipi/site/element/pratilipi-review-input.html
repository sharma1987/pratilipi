<link rel="import" href="pratilipi-rating-input.html">
<link rel="import" href="pratilipi-review.html">

<dom-module id="pratilipi-review-input">

	<style>
		
		:host {
			display: block;
		}

		.secondary-500 {
			padding:10px;
		}
		
		.secondary-500 .media .media-left img {
			width: 100px;
			height: 150px;
		}
		
		.form-group input, .form-group textarea {
			font-size: 12px;
		}
		
	</style>

	
	<template>
		<iron-collapse id="ReviewInputCollapse" class="secondary-500">
			<div class="media">
				<div class="media-left">
					<img class="media-object" src="{{ pratilipi.coverImageUrl }}" alt="{{ pratilipi.title }}" title="{{ pratilipi.titleEn }}"/>
				</div>
				<div class="media-body">
					<h4 class="media-heading">{{ pratilipi.title }}</h4>
					<h5>{{ pratilipi.author.name }}</h5>
					<br/>
					<pratilipi-rating-input
							user="{{ user }}"
							pratilipi-id="{{ pratilipi.pratilipiId }}"
							value="{{ userpratilipi.rating }}"
							></pratilipi-rating-input>
				</div>
			</div>
			<br/>
			<div class="form-group">
				<label for="FormInput-Title">${ _strings.review_title }</label>
				<input type="email" class="form-control" id="FormInput-Title" placeholder="${ _strings.review_title_help }" value="{{ params.reviewTitle::input }}">
				<span class="text-danger">{{ paramsErr.reviewTitle }}</span>
			</div>
			<div class="form-group">
				<label for="FormInput-Content">${ _strings.review_content }</label>
				<textarea class="form-control" id="FormInput-Content" rows="6" placeholder="${ _strings.review_content_help }"></textarea>
				<span class="text-danger">{{ paramsErr.review }}</span>
			</div>
			<div>
				<button type="button" class="pratilipi-light-blue-button" on-click="onSubmit">${ _strings.submit_review }</button>
				<button type="button" class="pratilipi-grey-button" on-click="close">Cancel</button>
				<span class="text-center text-success">{{ message }}</span>
				<span class="text-center text-danger">{{ errMessage }}</span>
			</div>

		</iron-collapse>
		
		<br class="pratilipi-break"/>

		<iron-collapse id="ReviewCollapse">
			<pratilipi-review review="{{ userpratilipi }}"></pratilipi-review>
		</iron-collapse>

		<iron-ajax
				id="AjaxPut"
				url="/api/userpratilipi"
				method="PUT"
				content-type="application/json"
				handle-as="json"
				on-response="_handleAjaxPutResponse"
				on-error="_handleAjaxPutError"
				></iron-ajax>

	</template>
	

	<script>

		Polymer({

			is: 'pratilipi-review-input',

			properties: {
				user: { type: Object },
				pratilipi: { type:Object, observer:"_pratilipiChangeObserver" },
				userpratilipi: { type:Object, notify:true, observer:"_userpratilipiChangeObserver" },
				isactive: { type: Boolean, notify: true },
				
				params: { type:Object, value:{} },
				paramsErr: { type:Object },
			},
			
			_pratilipiChangeObserver: function() {
				this.params.pratilipiId = this.pratilipi.pratilipiId;
			},
			
			_userpratilipiChangeObserver: function() {
				if( ! this.userpratilipi.pratilipiId )
					this.close();
				this.set( 'params.reviewTitle', this.userpratilipi.reviewTitle );
				if( this.userpratilipi.review ) {
					this.querySelector( 'textarea' ).value = this.userpratilipi.review;
					if( ! this.$.ReviewInputCollapse.opened && ! this.$.ReviewCollapse.opened )
						this.$.ReviewCollapse.toggle();
				} else {
					this.querySelector( 'textarea' ).value = "";
				}
			},
			
			open: function() {
				if( ! this.$.ReviewInputCollapse.opened )
					this.$.ReviewInputCollapse.toggle();
				if( this.$.ReviewCollapse.opened )
					this.$.ReviewCollapse.toggle();
			},
			
			close: function() {
				this.isactive = false;
				if( this.$.ReviewInputCollapse.opened )
					this.$.ReviewInputCollapse.toggle();
				if( ! this.$.ReviewCollapse.opened && this.userpratilipi.review )
					this.$.ReviewCollapse.toggle();
			},
			
			onSubmit: function() {
				this.paramsErr = {};
				this.errMessage = null;
				this.message = "${ _strings.saving }";
				
				this.params.review = this.querySelector( 'textarea' ).value;
				
				this.$.AjaxPut.body = JSON.stringify( this.params );
				this.$.AjaxPut.generateRequest();
			},
			
			_handleAjaxPutResponse: function( request ) {
				if( event.detail.xhr.status == 0 ) {
					this.message = null;
					this.errMessage = "Could not connect to server !";
				} else {
					this.message = null;
					this.set( 'userpratilipi.reviewTitle', this.params.reviewTitle );
					this.set( 'userpratilipi.review', this.params.review );
					this.close();
				}
			},

			_handleAjaxPutError: function( event ) {
				this.message = null;
				if( event.detail.request.xhr.status == 400 )
					this.paramsErr = event.detail.request.xhr.response;
				else if( event.detail.request.xhr.status == 401 )
					document.querySelector( 'pratilipi-user' ).logIn();
				else
					this.errMessage = event.detail.request.xhr.response.message;
			}
			
		});
		
	</script>

</dom-module>
<link rel="import" href="pratilipi-rating-input.html">

<dom-module id="pratilipi-review-input">

	<style>
		
		:host {
			display: block;
		}

		.secondary-500 {
			padding:10px;
		}
		
		.secondary-500 .media .media-left img {
			width: 100px;
			height: 150px;
		}
		
		paper-input, paper-textarea {
			--paper-input-container-focus-color: #107FE5;
			display: block;
			--paper-input-container-label: {
				font-size: 15px;
				font-family: Helvetica,'Noto Sans Tamil', sans-serif;
			};
		}
		
	</style>

	
	<template>
		<iron-collapse id="ReviewInputCollapse" class="secondary-500">
			<div class="media">
				<div class="media-left">
					<img class="media-object" src="{{ pratilipi.coverImageUrl }}" alt="{{ pratilipi.title }}" title="{{ pratilipi.titleEn }}"/>
				</div>
				<div class="media-body">
					<h4 class="pratilipi-red">{{ pratilipi.title }}</h4>
					<h6>{{ pratilipi.author.name }}</h6>
					
					<div style="margin-top: 15px;">
						<pratilipi-rating-input
							value="{{ ratingValue }}"
							></pratilipi-rating-input>
					</div>
				</div>
			</div>
			
			<div class="pratilipi-center-div" on-keyup="onSubmit">
				<paper-input label="${ _strings.review_title }" value="{{ params.reviewTitle::input }}"></paper-input>
				<div style="margin-top: 20px; margin-bottom: 5px;">
					<span style="font-size: 14px;">${ _strings.review_content }</span>
				</div>
				<script language="javascript" type="text/javascript">tinymce.init({ selector:'#reviewInput', editor_selector : "reviewInput", content_css : "https://storage.googleapis.com/devo-pratilipi.appspot.com/custom.css", language: 'ta', menubar: false, toolbar: 'styleselect | bold italic underline | link image', });</script>
				<paper-textarea class="write" id="reviewInput" value="{{ params.review::input }}"></paper-textarea>
			</div>
			
			<div style="margin-bottom: 20px;">
				<span style="display: block;" class="text-center">{{ message }}</span>
				<button type="button" class="pratilipi-light-blue-button" on-click="onSubmit">${ _strings.review_submit_review }</button>
				<button type="button" class="pratilipi-grey-button" on-click="close">${ _strings.cancel }</button>
			</div>

		</iron-collapse>
		
		<div class="modal fade" id="deleteReview">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h6 class="modal-heading">${ _strings.review_delete_review }</h6>
						<span class="modal-close-button"><paper-icon-button noink icon="close" data-dismiss="modal"></paper-icon-button></span>
					</div>
					<div class="modal-body">
						${ _strings.review_delete_review_confirm }
					</div>
					<div class="modal-footer">
						<button id="deleteReviewButton" class="btn btn-danger pull-left" on-click="deleteReview">${ _strings.review_delete_okay }</button>
						<button class="btn btn-primary pull-right" on-click="closeDeleteReview">${ _strings.review_delete_cancel }</button>
					</div>
				</div>
			</div>
		</div>
		
		<iron-ajax
				id="AjaxPost"
				url="/api/userpratilipi"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
				
		<iron-ajax
				id="AjaxPostDeleteReview"
				url="/api/userpratilipi"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostDeleteReviewResponse"
				on-error="_handleAjaxPostDeleteReviewError"
				></iron-ajax>

	</template>
	

	<script>

		Polymer({

			is: 'pratilipi-review-input',

			properties: {
				pratilipi: { type: Object, observer: "_pratilipiChangeObserver" },
				userpratilipi: { type: Object, observer:"_userpratilipiChangeObserver" },
				ratingValue: { type: Number, value: 0 },
				isactive: { type: Boolean, notify: true },
				
				params: { type: Object, value:{} },
				message: { type: String }
			},
			
			_pratilipiChangeObserver: function() {
				this.params.pratilipiId = this.pratilipi.pratilipiId;
			},
			
			_userpratilipiChangeObserver: function() {
				
				this.set( 'params', this.userpratilipi );

				if( this.userpratilipi != null && this.userpratilipi.rating != null )
					this.querySelector( 'pratilipi-rating-input' ).setRating( this.userpratilipi.rating );
				else
					this.querySelector( 'pratilipi-rating-input' ).setRating( 0 );
				
				if( this.params == null || this.params.review == null )
					this.params.review = "";
			},
			
			open: function() {
				if( ! this.$.ReviewInputCollapse.opened )
					this.$.ReviewInputCollapse.toggle();
			},
			
			close: function() {
				this.isactive = false;
				if( this.$.ReviewInputCollapse.opened )
					this.$.ReviewInputCollapse.toggle();
			},
			
			openDeleteReview: function() {
				this.async( function() {
					jQuery( "#deleteReview" ).modal();
				});
			},
			
			closeDeleteReview: function() {
				jQuery( "#deleteReview" ).modal( 'hide' );
			},
			
			deleteReview: function() {
				// Change state and make Post call.
				jQuery( '#deleteReviewButton' ).prop( 'disabled', true );
				var body = { pratilipiId: this.pratilipi.pratilipiId, reviewState: "DELETED" };
				this.$.AjaxPostDeleteReview.body = jQuery.param( body );
				this.$.AjaxPostDeleteReview.generateRequest();
			},
			
			_handleAjaxPostDeleteReviewResponse: function( event ) {
				if( event.detail.xhr.status != 0 ) {
					jQuery( '#deleteReviewButton' ).prop( 'disabled', false );
					document.querySelector( 'pratilipi-userpratilipi' ).setUserPratilipi( event.detail.response );
					this.closeDeleteReview();
				}
			},
			
			_handleAjaxPostDeleteReviewError: function( event ) {
				jQuery( '#deleteReviewButton' ).prop( 'disabled', false );
			},
			
			onSubmit: function( event ) {
				
				this.message = null;
				
				if( event.keyCode != null && event.keyCode != 0 && event.keyCode != 13 )
					return;
				
				this.message = "${ _strings.saving }";
				
				if( this.ratingValue === 0 ) {
					this.message = "Please rate the book.";
					return;
				}
					
				this.params.rating = this.ratingValue;
				
				if( tinyMCE.activeEditor != null )
					this.params.review = tinyMCE.get( 'reviewInput' ).getContent();
				
				var requestObject = {
					pratilipiId : this.pratilipi.pratilipiId,
					rating : this.params.rating,
					reviewTitle : this.params.reviewTitle,
					review : this.params.review
			    };
				
				
				this.$.AjaxPost.body = jQuery.param( requestObject );
				this.$.AjaxPost.generateRequest();
			},
			
			_handleAjaxPostResponse: function( event ) {
				if( event.detail.xhr.status == 0 ) {
					this.message = null;
					this.errMessage = "Could not connect to server !";
				} else {
					this.message = null;
					document.querySelector( 'pratilipi-userpratilipi' ).setUserPratilipi( event.detail.response );
					this.close();
				}
			},

			_handleAjaxPostError: function( event ) {
				this.message = null;
				if( event.detail.request.xhr.status == 400 )
					this.paramsErr = event.detail.request.xhr.response;
				else if( event.detail.request.xhr.status == 401 )
					document.querySelector( 'pratilipi-user' ).logIn();
				else
					this.errMessage = event.detail.request.xhr.response.message;
			}
			
		});
		
	</script>

</dom-module>
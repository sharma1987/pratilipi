<link rel="import" href="pratilipi-rating-input.html">
<link rel="import" href="pratilipi-review.html">

<dom-module id="pratilipi-review-input">

	<style>
		
		:host {
			display: block;
		}

		.secondary-500 {
			padding:10px;
		}
		
		.secondary-500 .media .media-left img {
			width: 100px;
			height: 150px;
		}
		
		paper-input, paper-textarea {
			--paper-input-container-focus-color: #107FE5;
			display: block;
		}
		
	</style>

	
	<template>
		<iron-collapse id="ReviewInputCollapse" class="secondary-500">
			<div class="media">
				<div class="media-left">
					<img class="media-object" src="{{ pratilipi.coverImageUrl }}" alt="{{ pratilipi.title }}" title="{{ pratilipi.titleEn }}"/>
				</div>
				<div class="media-body">
					<h4 class="media-heading">{{ pratilipi.title }}</h4>
					<h5>{{ pratilipi.author.name }}</h5>
					
					<div style="margin-top: 50px;">
						<pratilipi-rating-input
							value="{{ ratingValue }}"
							></pratilipi-rating-input>
					</div>
				</div>
			</div>
			
			<div style="margin: 25px auto;" on-keyup="onSubmit">
				<paper-input label="${ _strings.review_title }" value="{{ params.reviewTitle::input }}"></paper-input>
				<paper-textarea label="${ _strings.review_content }" value="{{ params.review::input }}"></paper-textarea>
			</div>
			
			<div style="margin-bottom: 20px;">
				<button type="button" class="pratilipi-light-blue-button" on-click="onSubmit">${ _strings.submit_review }</button>
				<button type="button" class="pratilipi-grey-button" on-click="close">Cancel</button>
				<span class="text-center">{{ message }}</span>
			</div>

		</iron-collapse>
		
		<br class="pratilipi-break"/>

		<iron-collapse id="ReviewCollapse">
			<pratilipi-review review="{{ userpratilipi }}"></pratilipi-review>
		</iron-collapse>

		<iron-ajax
				id="AjaxPut"
				url="/api/userpratilipi"
				method="PUT"
				content-type="application/json"
				handle-as="json"
				on-response="_handleAjaxPutResponse"
				on-error="_handleAjaxPutError"
				></iron-ajax>

	</template>
	

	<script>

		Polymer({

			is: 'pratilipi-review-input',

			properties: {
				user: { type: Object },
				pratilipi: { type:Object, observer:"_pratilipiChangeObserver" },
				userpratilipi: { type:Object, notify:true, observer:"_userpratilipiChangeObserver" },
				ratingValue: { type: Number, value: 0 },
				isactive: { type: Boolean, notify: true },
				
				params: { type: Object, value:{} },
				message: { type: String }
			},
			
			_pratilipiChangeObserver: function() {
				this.params.pratilipiId = this.pratilipi.pratilipiId;
			},
			
			_userpratilipiChangeObserver: function() {
				
				if( ! this.userpratilipi.pratilipiId )
					this.close();
				
				this.set( 'params.reviewTitle', this.userpratilipi.reviewTitle );
				
				if( this.userpratilipi.review )
					this.set( 'params.review', this.userpratilipi.review );
				else
					this.set( 'params.review', "" );
				
				if( this.userpratilipi.rating ) {
					this.set( 'params.rating', this.userpratilipi.rating );
					this.set( 'ratingValue', this.userpratilipi.rating );
					this.querySelector( 'pratilipi-rating-input' ).setRating( this.userpratilipi.rating );
				}
				else
					this.set( 'params.rating', 0 );
			},
			
			open: function() {
				if( ! this.$.ReviewInputCollapse.opened )
					this.$.ReviewInputCollapse.toggle();
				if( this.$.ReviewCollapse.opened )
					this.$.ReviewCollapse.toggle();
			},
			
			close: function() {
				this.isactive = false;
				if( this.$.ReviewInputCollapse.opened )
					this.$.ReviewInputCollapse.toggle();
				if( ! this.$.ReviewCollapse.opened && this.userpratilipi.review )
					this.$.ReviewCollapse.toggle();
			},
			
			onSubmit: function() {
				
				this.message = "";
				
				if( event.keyCode != null && event.keyCode != 0 && event.keyCode != 13 )
					return;
				
				this.message = "${ _strings.saving }";
				
				if( this.ratingValue === 0 ) {
					this.message = "Please rate the book.";
					return;
				}
					
				this.params.rating = this.ratingValue;
				
				if( this.params.reviewTitle !== undefined && this.params.review === undefined ) {
					this.message = "Please enter the review.";
					return;
				}
				
				this.$.AjaxPut.body = JSON.stringify( this.params );
				this.$.AjaxPut.generateRequest();
			},
			
			_handleAjaxPutResponse: function( request ) {
				if( event.detail.xhr.status == 0 ) {
					this.message = null;
					this.errMessage = "Could not connect to server !";
				} else {
					this.message = null;
					this.set( 'userpratilipi.reviewTitle', this.params.reviewTitle );
					this.set( 'userpratilipi.review', this.params.review );
					this.set( 'userpratilipi.rating', this.params.rating );
					this.close();
				}
			},

			_handleAjaxPutError: function( event ) {
				this.message = null;
				if( event.detail.request.xhr.status == 400 )
					this.paramsErr = event.detail.request.xhr.response;
				else if( event.detail.request.xhr.status == 401 )
					document.querySelector( 'pratilipi-user' ).logIn();
				else
					this.errMessage = event.detail.request.xhr.response.message;
			}
			
		});
		
	</script>

</dom-module>
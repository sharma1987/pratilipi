<dom-module id="pratilipi-comment">

	<style>
		.comment {
			padding: 12px 8px;
			border-top: 1px solid #d3d3d3;
			border-bottom: 1px solid #f8f8f8;
		}
		
		.user-dp {
			width: 48px; 
			height: 48px; 
			float: left; 
		}
		
		.user-name {
			color: inherit; 
			text-transform: capitalize; 
			display: inline-block; 
			margin: 0px;
			font-size: 15px;
		}
		
		.comment-text {
			font-size: 14px;
			text-align: justify; 
			white-space:pre-wrap;
			padding: 14px 0px 4px 4px;
			letter-spacing: 0.1px;
		}
		
		paper-menu-button {
			padding: 0px;
		}
		
		paper-menu {
			cursor: pointer;
			--paper-menu-color: #333;
			--paper-menu-focused-item: {
				color: #107FE5;
			};
		}
		
		paper-item {
			font-family: inherit;
			font-size: inherit;
			margin-left: 4px;
			margin-right: 4px;
		}
		
		button.pratilipi-grey-button {
			padding: 6px 8px;
			margin: 0px;
			margin-top: 4px;
		}
	
	</style>
	
	<template>
		<div class="comment">
			<template is="dom-if" if="{{ hasAccessToUpdate }}">
				<paper-menu-button horizontal-align="right" class="pull-right">
					<paper-icon-button class="dropdown-trigger" icon="icons:more-horiz" noink></paper-icon-button>
						<paper-menu class="dropdown-content">
							<paper-item on-click="openCommentEdit">
								<iron-icon style="margin-right: 8px; width: 20px; height: 20px;" icon="icons:create"></iron-icon>
								${ _strings.comment_edit_comment }
							</paper-item>
							<paper-item on-click="_deleteComment">
								<iron-icon style="margin-right: 8px; width: 20px; height: 20px;" icon="icons:delete"></iron-icon>
								${ _strings.comment_delete_comment }
							</paper-item>
						</paper-menu>
				</paper-menu-button>
			</template>
			
			<template is="dom-if" if="{{ showRestoreComment }}">
				<button class="pratilipi-grey-button pull-right" on-click="_restoreComment" class="pull-right">
					<iron-icon style="width: 16px; height: 16px; margin-top: -4px;" icon="icons:restore"></iron-icon>
					${ _strings.comment_restore_comment }
				</button>
			</template>
			
			<div class="user-details">
				<a href="{{ comment.user.profilePageUrl }}">
					<img class="img-circle user-dp pratilipi-shadow" src="{{ userProfileImageUrl }}" alt="username" title="username"/>
				</a>
				<div style="display: inline-block; margin-left: 16px;">
					<a class="user-name" href="{{ comment.user.profilePageUrl }}">{{ comment.user.displayName }}</a>
					<span style="display: block;">{{ lastUpdatedDate }}</span>
				</div>
			</div>
			
			<div class="comment-text">{{ content }}</div>
			
			<iron-ajax
				id="AjaxPost"
				url="/api/comment"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
		</div>
		
		<template is="dom-if" if="{{ hasAccessToUpdate }}">
			<pratilipi-comment-input 	
					style="display: none;"
					edit-comment
					user="{{ comment.user }}" 
					comment-id="{{ comment.commentId }}" 
					content="{{ content }}"></pratilipi-comment-input>
		</template>
		
	</template>
	

	<script>
	
		Polymer({

			is: 'pratilipi-comment',
			
			properties: {
				comment: { type: Object, observer: "_commentObserver" },

				editComment: { type: Boolean, value: false },
				deleteComment: { type: Boolean, value: false },
				restoreComment: { type: Boolean, value: false },

				showRestoreComment: { type: Boolean, value: false }
			},
			
			_commentObserver: function() {
				this.lastUpdatedDate = convertDate( this.comment.lastUpdatedMillis != null ? 
											this.comment.lastUpdatedMillis : this.comment.creationDateMillis );
				this.userProfileImageUrl = 	this.comment.user.profileImageUrl.indexOf( "?" ) == -1 ?
											this.comment.user.profileImageUrl + "?" + "width=48" :
											this.comment.user.profileImageUrl + "&" + "width=48" ;
				
				this.hasAccessToUpdate = this.comment.hasAccessToUpdate == null ? false : this.comment.hasAccessToUpdate;
				this.content = this.comment.content;
			},
			
			openCommentEdit: function() {
				jQuery( this.querySelector( '.comment' ) ).css( 'display', 'none' );
				jQuery( this.querySelector( 'pratilipi-comment-input' ) ).css( 'display', 'block' );
			},
			
			closeCommentEdit: function() {
				jQuery( this.querySelector( 'pratilipi-comment-input' ) ).css( 'display', 'none' );
				jQuery( this.querySelector( '.comment' ) ).css( 'display', 'block' );
			},
			
			editExistingComment: function( content ) {
				if( this.editComment )
					return;
				this.editComment = true;
				var body = {
					commentId: this.comment.commentId,
					content: content
				};
				this.$.AjaxPost.body = jQuery.param( body );
				this.$.AjaxPost.generateRequest();
			},
			
			_deleteComment: function() {
				if( this.deleteComment )
					return;
				this.deleteComment = true;
				var body = {
					commentId: this.comment.commentId,
					state: "DELETED"
				};
				this.$.AjaxPost.body = jQuery.param( body );
				this.$.AjaxPost.generateRequest();
			},
			
			_restoreComment: function() {
				if( this.restoreComment )
					return;
				this.restoreComment = true;
				var body = {
					commentId: this.comment.commentId,
					state: "ACTIVE"
				};
				this.$.AjaxPost.body = jQuery.param( body );
				this.$.AjaxPost.generateRequest();
			},
			
			_handleAjaxPostResponse: function( event ) {
				var comment = event.detail.response;

				if( this.editComment ) {
					this.editComment = false;
					this.set( 'comment', comment );
					this.closeCommentEdit();
				} else if( this.deleteComment ) {
					this.deleteComment = false;
					// Disable edit and deleting
					comment.hasAccessToUpdate = false;
					// Inactive comment
					jQuery( this.querySelector( '.comment' ) ).css( 'color', '#767676', 'important' );
					jQuery( this.querySelector( '.comment' ) ).css( 'background-color', '#f9f9f9', 'important' );
					// Enable restoring the comment
					this.showRestoreComment = true;
					
					this.set( 'comment', comment );
					
					<#-- 
						document.querySelector( 'pratilipi-comment-list#comment-'+ this.comment.parentId ).deleteCommentFromList( comment );
						this.domHost.deleteCommentFromList( comment ); 
						jQuery( this.querySelector( '.comment' ) ).css( 'display', 'none' ); 
					-->
				} else if( this.restoreComment ) {
					this.restoreComment = false;
					// Active comment
					jQuery( this.querySelector( '.comment' ) ).css( 'color', 'inherit', 'important' );
					jQuery( this.querySelector( '.comment' ) ).css( 'background-color', 'inherit', 'important' );
					// Disable restoring the comment
					this.showRestoreComment = false;
					this.set( 'comment', comment );
				}
			},
			
			_handleAjaxPostError: function( event ) {
				if( event.detail.request.xhr.response.message != null )
					document.querySelector( 'pratilipi-alert' ).alert( event.detail.request.xhr.response.message, false );
				else
					document.querySelector( 'pratilipi-alert' ).alert( "Some error occured! Please try again!", false );
			}

		});
		
	</script>

</dom-module>

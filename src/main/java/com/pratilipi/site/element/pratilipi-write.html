<dom-module id="pratilipi-write">

	<style>
	
		:host {
			display: block;
		}
		
		textarea {
			display: block;
			width: 100%;
		}
		
		paper-dropdown-menu {
			width: 100%;
			--paper-dropdown-menu-focus-color: #107FE5;
			--paper-dropdown-menu-input-color: #333;
			--paper-input-container-input: {
				font-family: Helvetica,'Noto Sans Tamil', sans-serif;
			};
			--paper-input-container-underline: {
				background: #107FE5;
			};
			--paper-input-container-label: {
				font-size: 15px;
				font-family: Helvetica,'Noto Sans Tamil', sans-serif;
				text-align: left;
				color: #107FE5;
			};
		}
		
		paper-menu {
			--paper-menu-color: #333;
			width: 100%;
			--paper-menu-focused-item: {
				color: #107FE5;
			};
		}
		
		paper-menu paper-item {
			font-size: 15px;
			font-family: Helvetica,'Noto Sans Tamil', sans-serif;
			color: #333;
			white-space: nowrap;
		}
		
		.row {padding-left: 10px;padding-right: 10px;}
		.modal-fullscreen .modal-dialog .modal-content {max-width: 768px;padding-top:5px;}
		.pull-center {display:block;margin-left:auto;margin-right:auto;text-align:center;}
		
		
	</style>
	

	<template>
		<div class="modal modal-fullscreen fade" id="pratilipiWrite" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-fullscreen-close-button">
						<paper-icon-button noink icon="close" data-dismiss="modal"></paper-icon-button>
					</div>
					<img title="${ _strings.pratilipi }" alt="${ _strings.pratilipi }" src="http://0.ptlp.co/resource-${ lang }/logo/pratilipi_logo.png" />
					<template is="dom-if" if="{{ createPratilipi }}">
						<p class="text-muted text-center">${ _strings.write_help }</p>
						<div style="height: 2px; background-color: #FFF; text-align: center; margin-top: 30px; margin-bottom: 10px;"></div>
					</template>					
					<div class="row">
						<h6 class="modal-fullscreen-heading">{{ modalTitle }}</h6>
						<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
							<pratilipi-input label="${ _strings.write_title }" value="{{ title::input }}" icon="icons:description"></pratilipi-input>
						</div>
						<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
							<pratilipi-input label="${ _strings.write_title_en }" value="{{ titleEn::input }}" icon="icons:description"></pratilipi-input>
						</div>
						<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
							<paper-dropdown-menu id="selectPratilipiType" noink label="${ _strings.write_type }" value="{{ type }}" vertical-align="bottom" horizontal-align="left">
								<paper-menu noink class="dropdown-content" selected="[[ selected ]]" style="white-space: nowrap; width: auto;">
									<paper-item value="BOOK">{{ pratilipiTypes.BOOK.name }}</paper-item>
									<paper-item value="POEM">{{ pratilipiTypes.POEM.name }}</paper-item>
									<paper-item value="STORY">{{ pratilipiTypes.STORY.name }}</paper-item>
									<paper-item value="ARTICLE">{{ pratilipiTypes.ARTICLE.name }}</paper-item>
									<paper-item value="MAGAZINE">{{ pratilipiTypes.MAGAZINE.name }}</paper-item>
								</paper-menu>
							</paper-dropdown-menu>
						</div>
						<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
							<pratilipi-input disabled always-float-label label="${ _strings.write_language }" value="{{ languageVernacular }}"></pratilipi-input>
						</div>
						<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
							<div style="margin-top: 25px; margin-bottom: 5px;"><span class="pratilipi-blue" style="font-size: 14px;">${ _strings.write_summary }</span></div>
							<textarea name="writeSummary" id="writeSummary" rows="10" value="{{ summary::input }}"></textarea>
						</div>
					</div>
					
				</div>
			</div>
			<div class="modal-footer">
				<div class="display-message-div"><p>{{ message }}</p></div>
				<button id="pratilipiWriteButton" style="position: fixed; bottom: 15px; right: 15px;" class="pratilipi-dark-blue-button" type="button" on-click="onSubmit">{{ modalButtonText }}</button>
			</div>
		</div>
		
		<iron-ajax
				id="AjaxPost"
				url="/api/pratilipi"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
	</template>
	
	<script>
	HTMLImports.whenReady(function () {
		if( CKEDITOR != null && document.getElementById( 'writeSummary' ) != null )
			CKEDITOR.replace( 'writeSummary' );
	});
		Polymer({

 			is: 'pratilipi-write',
 			
			properties: {
				// Specific to admins
				authorId: { type: String },
				
				// Specific to input fields
				pratilipiId: { type: String },
				title: { type: String },
				titleEn: { type: String },
 				summary: { type: String },
 				type: { type: String },
 				language: { type: String },
 				state: { type: String },
 				
 				// Specific to modal
 				createPratilipi: { type: Boolean },
 				editPratilipi: { type: Boolean },
				modalTitle: { type: String },
				modalButtonText: { type: String },
				pratilipiTypes: { types: Object },
				selected: { type: Number },
 				message: { type: String }
			},
			
			attached: function() {
				this.pratilipiTypes = jQuery.parseJSON( this.pratilipiTypes );
			},
			
			createNewPratilipi: function( authorId ) {
				// Setting the boolean flags
				this.createPratilipi = true;
				this.editPratilipi = false;
				
				// Specific to Modal
				this.modalTitle = "${ _strings.write_heading }";
				this.modalButtonText = "${ _strings.write_create_new_content }";

				// Setting data
				this.authorId = authorId == null ? null : authorId;
				this.process( {} );
				this.open();
			},
			
			editExistingPratilipi: function( pratilipi ) {
				// Setting the boolean flags
				this.editPratilipi = true;
				this.createPratilipi = false;
				
				// Specific to Modal
				this.modalTitle = pratilipi.title + " - " + "${ _strings.edit_pratilipi_heading }";
				this.modalButtonText = "${ _strings.edit_pratilipi_save_changes }";

				// Setting data
				this.authorId = null;
				this.process( pratilipi );
				this.open();
			},
			
			process: function( pratilipi ) {
				this.message = null;
				this.pratilipiId = pratilipi.pratilipiId == null ? null : pratilipi.pratilipiId;
				this.title = pratilipi.title == null ? null : pratilipi.title;
				this.titleEn = pratilipi.titleEn == null ? null : pratilipi.titleEn;
				this.state = pratilipi.state == null ? "DRAFTED" : pratilipi.state;
				this.summary = pratilipi.summary == null ? "" : pratilipi.summary;

				
				if( CKEDITOR != null && CKEDITOR.instances.writeSummary != null )
					CKEDITOR.instances.writeSummary.setData( this.summary );
				
				var languageVernacular = {
					"HINDI" : "${ _strings.language_hi }",
					"GUJARATI" : "${ _strings.language_gu }",
					"TAMIL" : "${ _strings.language_ta }",
					"MARATHI" : "${ _strings.language_mr }",
					"MALAYALAM" : "${ _strings.language_ml }",
					"BENGALI" : "${ _strings.language_bn }",
					"TELUGU" : "${ _strings.language_te }",
					"KANNADA" : "${ _strings.language_kn }"
				};
				this.language = pratilipi.language == null ? "${ language?upper_case }" : pratilipi.language.toUpperCase();
				this.languageVernacular = languageVernacular[ this.language ];
				
				this.type = pratilipi.type == null ? null : pratilipi.type;
				if( this.type != null ) {
					if( this.type.toUpperCase() === "BOOK" )
						this.selected = 0;
					else if( this.type.toUpperCase() === "POEM" )
						this.selected = 1;
					else if( this.type.toUpperCase() === "STORY" )
						this.selected = 2;
					else if( this.type.toUpperCase() === "ARTICLE" )
						this.selected = 3;
					else if( this.type.toUpperCase() === "MAGAZINE" )
						this.selected = 4;
				} else {
					this.selected = null;
				}
			},
			
			clearAndClose: function() {
				this.authorId = null;
				this.title = null;
				this.titleEn = null;
				this.summary = null;
				this.type = null;
				this.language = null;
				this.state = null;
 				this.createPratilipi = false;
 				this.editPratilipi = false;
 				this.modalTitle = null;
 				this.modalButtonText = null;
 				this.message = null;
 				this.close();
			},
			
			open: function() {
				this.async( function() {
					jQuery( "#pratilipiWrite" ).modal();
				});
			},
			
			close: function() {
				jQuery( "#pratilipiWrite" ).modal( 'hide' );	
			},
			
			onSubmit: function( event ) {
				
				if( this.title == null || this.title.trim() == "" ) {
					this.message = "Please fill in the Title.";
					return;
				}
				
				if( this.type == null ) {
					this.message = "Please select the type.";
					return;
				}

				this.type = this.$.selectPratilipiType.selectedItem.getAttribute( "value" );

				if( CKEDITOR != null && CKEDITOR.instances.writeSummary != null )
					this.summary = CKEDITOR.instances.writeSummary.getData();
				
				this.message = "${ _strings.working }";
				
				var body = {
						title: this.title,
						type: this.type.toUpperCase(),
						language: this.language.toUpperCase(),
						state: this.state
				};
				
				if( this.pratilipiId != null )
					body.pratilipiId = this.pratilipiId;
				
				if( this.titleEn != null )
					body.titleEn = this.titleEn;
				
				if( this.summary != null )
					body.summary = this.summary;
				
				if( this.authorId != null )
					body.authorId = this.authorId;
				
				jQuery( '#pratilipiWriteButton' ).prop( 'disabled', true );
				
				this.$.AjaxPost.body = jQuery.param( body );
				this.$.AjaxPost.generateRequest();
				
			},
			
			_handleAjaxPostResponse: function( event ) {
				
				var pratilipi = event.detail.response;
				
				if( this.createPratilipi )
					this.message = "${ _strings.content_created_success }";
				else if( this.editPratilipi ) 
					this.message = "${ _strings.updated_pratilipi_info_success }";
					
				jQuery( '#pratilipiWriteButton' ).prop( 'disabled', false );
				
				if( this.createPratilipi ) {
					// Redirect to writer with return option to pratilipi page
					this.async( function() {
						this.clearAndClose();
						window.location.href = pratilipi.writePageUrl + "&ret=" + pratilipi.pageUrl;
					}, 1000 );
				} else if( this.editPratilipi ) {
					document.querySelector( 'pratilipi-pratilipi' ).updatePratilipi( pratilipi );
					this.async( function() {
						this.clearAndClose();
					}, 1000 );
				}
			},
			
			_handleAjaxPostError: function( event ) {
				jQuery( '#pratilipiWriteButton' ).prop( 'disabled', false );
				
				this.message = null;
				if( event.detail.request.xhr.status === 400 || event.detail.request.xhr.status === 401 || event.detail.request.xhr.status === 500 && event.detail.request.xhr.response.message != null )
					this.message = event.detail.request.xhr.response.message;
				else
					this.message = "Some Error occurred! Please try Again."
			}
 			
		});

	</script>
	
</dom-module>

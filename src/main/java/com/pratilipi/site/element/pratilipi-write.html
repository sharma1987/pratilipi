<dom-module id="pratilipi-write">

	<style>
	
		:host {
			display: block;
		}
		
		.popup-heading span {
			font-size: 14px;
			color: #333;
			display: inline-block;
		}
		
		paper-input.write, paper-textarea.write {
			--paper-input-container-focus-color: #107FE5;
			display: block;
			--paper-input-container-label: {
				font-size: 15px;
				font-family: Helvetica,'Noto Sans Tamil', sans-serif;
			};
		}
		
		paper-dropdown-menu {
			--paper-dropdown-menu-focus-color: #107FE5;
			width: 100%;
			--paper-dropdown-menu-ripple: {
				left: auto;
				right: auto;
			};
		}
		
		paper-dropdown-menu paper-menu-button {
			width: 100%;
			padding: 0;
		}
		
		paper-menu {
			--paper-menu-color: #333;
			width: 100%;
			--paper-menu-focused-item: {
				color: #107FE5;
			};
		}
		
		
	</style>
	

	<template>
		<div class="modal fade" id="pratilipiWrite" role="dialog">
			<div class="modal-dialog modal-lg" role="document">
				<div class="modal-content">
					
					<div class="modal-header">
						<h6 class="modal-heading">${ _strings.write_heading }</h6>
						<span class="modal-close-button"><paper-icon-button noink icon="close" data-dismiss="modal"></paper-icon-button></span>
					</div>
					
					<div class="modal-body" on-keyup="onSubmit">
						<p class="text-muted">
							${ _strings.write_help }
						</p>
						<paper-input class="write" label="${ _strings.write_title }" value="{{ title::input }}"></paper-input>
						<paper-input class="write" label="${ _strings.write_title_en }" value="{{ titleEn::input }}"></paper-input>
						<div class="row">
							<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
								<paper-dropdown-menu id="selectPratilipiType" noink label="${ _strings.write_type }" value="{{ pratilipiType }}">
									<paper-menu noink class="dropdown-content" style="white-space: nowrap; width: auto;">
										<paper-item value="BOOK">{{ pratilipiTypes.BOOK.name }}</paper-item>
										<paper-item value="POEM">{{ pratilipiTypes.POEM.name }}</paper-item>
										<paper-item value="STORY">{{ pratilipiTypes.STORY.name }}</paper-item>
										<paper-item value="ARTICLE">{{ pratilipiTypes.ARTICLE.name }}</paper-item>
										<paper-item value="MAGAZINE">{{ pratilipiTypes.MAGAZINE.name }}</paper-item>
									</paper-menu>
								</paper-dropdown-menu>
							</div>
							<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6">
								<paper-dropdown-menu id="language" always-float-label noink disabled label="${ _strings.write_language }">
									<paper-menu noink="true" selected="0" class="dropdown-content" style="white-space: nowrap; width: auto;">
										<paper-item>${ _strings.website_language }</paper-item>
									</paper-menu>
								</paper-dropdown-menu>
							</div>
						</div>
						<div style="margin-top: 15px; margin-bottom: 5px;">
							<span style="font-size: 14px;">${ _strings.write_summary }</span>
						</div>
						<script language="javascript" type="text/javascript">tinymce.init({ selector:'#writeSummary', editor_selector : "writeSummary", content_css : "https://storage.googleapis.com/devo-pratilipi.appspot.com/custom.css", language: 'ta', menubar: false, toolbar: 'styleselect | bold italic underline | link image', });</script>
						<paper-textarea class="write" id="writeSummary" value="{{ summary::input }}"></paper-textarea>
						<div class="text-center" style="min-height: 20px;">
							<span>{{ message }}</span>
						</div>
					</div>
					
					<div class="modal-footer">
						<button id="pratilipiWriteButton" class="pratilipi-dark-blue-button" type="button" on-click="onSubmit">${ _strings.write_create_new_content }</button>
					</div>
					
				</div>
			</div>
		</div>
		
		<iron-ajax
				id="AjaxPost"
				url="/api/pratilipi"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_handleAjaxPostResponse"
				on-error="_handleAjaxPostError"
				></iron-ajax>
	</template>
	
	<script>
	
		function getCookie( cname ) {
			var name = cname + "=";
			var ca = document.cookie.split( ';' );
			for( var i = 0; i < ca.length; i++ ) {
				var c = ca[i];
				while ( c.charAt(0)==' ' ) c = c.substring( 1 );
				if( c.indexOf( name ) == 0 ) return c.substring( name.length,c.length );
			}
			return "";
		}

		Polymer({

 			is: 'pratilipi-write',
 			
			properties: {
				authorId: { type: String },
					
				title: { type: String },
				titleEn: { type: String },
 				summary: { type: String, value: "" },
 				
 				pratilipiType: { type: String },
 				pratilipiTypes: { types: Object },
 				language: { type: String },
 				
 				message: { type: String }
			},
			
			attached: function() {
				this.pratilipiTypes = jQuery.parseJSON( this.pratilipiTypes );
			},
			
			setAuthorId: function( authorId ) {
				this.authorId = authorId;
			},
			
			open: function() {
				this.async( function() {
					jQuery( "#pratilipiWrite" ).modal();
				});
			},
			
			close: function() {
				jQuery( "#pratilipiWrite" ).modal( 'hide' );	
			},
			
			clear: function() {
				this.authorId = null;
				this.title = null;
				this.titleEn = null;
				this.summary = "";
				this.pratilipiType = null;
				this.language = null;
				this.message = null;
			},
			
			onSubmit: function( event ) {
				
				this.message = "";

				if( event.keyCode != null && event.keyCode != 0 && event.keyCode != 13 )
					return;
				
				if( this.title == null || this.title.trim() == "" ) {
					this.message = "Please fill in the Title.";
					return;
				}
				
				if( this.pratilipiType == null ) {
					this.message = "Please select the type.";
					return;
				}

				if( tinyMCE.activeEditor != null )
					this.summary = tinyMCE.get( 'writeSummary' ).getContent();
				
				this.pratilipiType = this.$.selectPratilipiType.selectedItem.getAttribute( "value" );
				this.language = this.$.language.selectedItemLabel.toUpperCase();
				
				this.message = "Please Wait...";
				
				
				var body = "title=" + this.title + "&" + 
				 "type=" + this.pratilipiType.toUpperCase() + "&" +
				 "language=" + this.language.toUpperCase() + "&" + 
				 "state=" + "DRAFTED" ;
				
				if( this.titleEn != null && this.titleEn.trim() != "" )
					body = body + "&" + "titleEn=" + this.titleEn;
				
				if( this.summary.trim() != "" )
					body = body + "&" + "summary=" + this.summary;
				
				if( this.authorId != null )
					body = body + "&" + "authorId=" + this.authorId;
				
				jQuery( '#pratilipiWriteButton' ).prop( 'disabled', true );
				this.$.AjaxPost.body = ( body );
				
				this.$.AjaxPost.generateRequest();
				
			},
			
			_handleAjaxPostResponse: function( event ) {
				
				var pratilipi = event.detail.response;
				this.message = "${ _strings.content_created_success }";
				
				this.async( function() {
					jQuery( '#pratilipiWriteButton' ).prop( 'disabled', false );
					// Redirect to writer with return option to pratilipi page and access token
					window.location = "http://www.pratilipi.com/write?id=" + pratilipi.pratilipiId + "&ret=" + "http://" + window.location.host + pratilipi.pageUrl + "&accessToken=" + getCookie( "access_token" );
					this.clear();
				}, 1000 );
			},
			
			_handleAjaxPostError: function( event ) {
				
				jQuery( '#pratilipiWriteButton' ).prop( 'disabled', false );
				
				if( event.detail.request.xhr.status === 400 || event.detail.request.xhr.status === 401 || event.detail.request.xhr.status === 500 )
					this.message = event.detail.request.xhr.response.message;
				else
					this.message = "Some Error occured! Please try Again."
			}
 			
		});

	</script>
	
</dom-module>

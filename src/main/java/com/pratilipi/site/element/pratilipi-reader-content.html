<dom-module id="pratilipi-reader-content">

	<style>
		
		:host {
			display: block;
			overflow: hidden;
		}
		
		:host #pager {
			margin-bottom: 5px;
			padding: 16px 22px;
			width: 100%;
		}
		
		:host #pager #reader-content {
			text-align: justify;
			-webkit-font-smoothing: antialiased;
			line-height: 1.6em;
		}

		/* Bootstrap override */
		.alert-success {
			color: #333;
			background-color: #ffffff;
			border-color: #333;
		}

		.alert-success .alert-link,.alert-success .alert-link:hover, .alert-success .alert-link:focus {
			color: #107FE5;
			font-weight: inherit;
		}

		.hvr-bounce-in {
			vertical-align: middle;
			-webkit-transform: translateZ(0);
			transform: translateZ(0);
			box-shadow: 0 0 1px rgba(0, 0, 0, 0);
			-webkit-backface-visibility: hidden;
			backface-visibility: hidden;
			-moz-osx-font-smoothing: grayscale;
			-webkit-transition-duration: 0.5s;
			transition-duration: 0.5s;
			max-width: 95%; 
			margin: 30px auto; 
		}


		.hvr-bounce-in:hover, .hvr-bounce-in:focus, .hvr-bounce-in:active {
			-webkit-transform: scale(1.05);
			transform: scale(1.05);
			-webkit-transition-timing-function: cubic-bezier(0.47, 2.02, 0.31, -0.36);
			transition-timing-function: cubic-bezier(0.47, 2.02, 0.31, -0.36);
		}

		.fa {
			margin-left: 15px;
			cursor: pointer;
		}
		
	</style>
	
	
	<template>
	
		<paper-card id="pager">
			<div id="reader-content">
				{{ content }}
			</div>
			<template is="dom-if" if="{{ lastPage }}">
				<div id="reader-alert-box" class="alert alert-success hvr-bounce-in" role="alert">
					<h3 class="text-center" style="margin-top: 24px;">${ _strings.reader_enjoyed_reading_part1 }</h3>
					<div class="text-center" style="margin: 0 auto;">
						<a class="pratilipi-blue" on-click="writeReview">
							<h6 style="margin: 15px 0px; display: inline-block;">${ _strings.reader_enjoyed_review_book }</h6>
							<iron-icon icon="icons:create" style="margin-left: 0px; display: inline-block; width: 20px; color: #333;"></iron-icon>
						</a>
					</div>
					<div class="text-center" style="margin: 0 auto;">
						<h6 style="margin: 15px 0px; display: inline-block;">${ _strings.reader_enjoyed_reading_part2 } : </h6>
						<div style="white-space: nowrap; display: inline-block;">  
							<i class="fa fa-facebook fa-lg fb" on-click="shareOnFacebook"></i>
							<i class="fa fa-twitter fa-lg tw" on-click="shareOnTwitter"></i>
							<i class="fa fa-google-plus fa-lg google" on-click="shareOnGplus"></i>
						</div>
					</div>
				</div>
			</template>
		</paper-card>
		<iron-ajax
				id="AjaxGet"
				url="/api/pratilipi/content"
				method="GET"
				content-type="application/json"
				handle-as="json"
				on-response="_onResponse"
				on-error="_onError"
				></iron-ajax>
	</template>
	
	
	<script>
		function getCookie( name ) {
			var nameEQ = name + "=";
			var ca = document.cookie.split( ';' );
			for( var i = 0; i < ca.length; i++ ) {
				var c = ca[i];
				while( c.charAt(0) == ' ' ) c = c.substring( 1, c.length );
				if( c.indexOf( nameEQ ) == 0 ) return c.substring( nameEQ.length, c.length );
			}
			return null;
		}
		function setCookie( name, value, days ) {
			var date = new Date();
			date.setTime( date.getTime() + ( days * 24 * 60 * 60 * 1000 ) );
			var expires = "; expires=" + date.toGMTString();
			document.cookie = name + "=" + value + expires + "; path=/";
		}
		function eraseCookie( name ) {
			createCookie( name, "" ,-1 );
		}

		Polymer({
			
			is: 'pratilipi-reader-content',
			
			properties: {
				content: { type: String, observer: "_onContentChange" },
				contentType: { type: String },
				contentMap: { type: Object, value: {} },

				pratilipiId: { type: Number },
				fontSize: { type: Number, observer: "_onFontSizeChange" },

				pageNo: { type: Number, observer: "_onPageNoChange" },
				pageCount: { type: Number },

				lastPage: { type: Boolean }

			},
			
			
			// Attached
			attached: function() {
				jQuery( "#pager" ).css( 'min-height', window.innerHeight + "px" );
				this.contentMap[ this.pageNo ] = this.content;
				this.set( 'lastPage', this.pageNo == this.pageCount ? true : false );
				this._precache();
			},


			// Font size
			_onFontSizeChange: function() {
				jQuery( "#reader-content" ).css( 'font-size', this.fontSize, "important" );
				jQuery( "#reader-content h2" ).css( 'font-size', this.fontSize + 4, "important" );
				jQuery( "#reader-content h1" ).css( 'font-size', this.fontSize + 8, "important" );
			},

			_setFontSize: function( fontSize ) {
				this.set( "fontSize", fontSize == null ? 14 : parseInt( fontSize ) );
				setCookie( "fontSize", fontSize, 15 );
			},

			increaseFontSize: function() {
				// cutoff = 32
				if( this.fontSize + 2 <= 32 )
					this._setFontSize( this.fontSize + 2 );
			},

			decreaseFontSize: function() {
				// cutoff = 12
				if( this.fontSize - 2 >= 12 )
					this._setFontSize( this.fontSize - 2 );
			},


			// Content
			_onContentChange: function() {
				jQuery( this.querySelector( '#reader-content' ) ).html( this.content );
				jQuery( "#reader-content img" ).css( "max-width", "100%", "important" );
				$( 'html, body' ).animate( { scrollTop : 0 }, 500 );
			},

			getImageUrl: function( pageNo ) {
				return "<img src='/api/pratilipi/content?pratilipiId=" + 
							this.pratilipiId + "&" + 
							"pageNo=" + pageNo + 
							"&" + "chapterNo=" + pageNo + "' />";
			},

			_precache: function() {
				if( this.contentType == "PRATILIPI" ) {
					// Check pageNo
					if( this.pageNo > 1 )
						this._loadContent( this.pageNo - 1 );
					if( this.pageNo < this.pageCount )
						this._loadContent( this.pageNo + 1 );
				} else if( this.contentType == "IMAGE" ) {
					// Prefetch images
					if( this.pageNo > 1 )
						jQuery( this.getImageUrl( this.pageNo - 1 ) ).load();
					if( this.pageNo < this.pageCount )
						jQuery( this.getImageUrl( this.pageNo + 1 ) ).load();
				}
			},

			_onPageNoChange: function() {
				// Called before ready function
				if( this.contentMap == null || jQuery.isEmptyObject( this.contentMap ) )
					return;
				
				if( !this.lastPage && this.pageNo == this.pageCount )
					this.set( 'lastPage', true );
				else if( this.lastPage && this.pageNo != this.pageCount )
					this.set( 'lastPage', false );
				
				if( this.contentType == "PRATILIPI" ) {
					if( this.contentMap[ this.pageNo ] != null )	// Check in Map if exists
						this.set( 'content', this.contentMap[ this.pageNo ] );
					else {											// Else make api call
						this.set( 'content', "<paper-spinner class=\"pratilipi-spinner-center\" active></paper-spinner>" );
						this._loadContent( this.pageNo );
					}
				} else if( this.contentType == "IMAGE" ) {
					this.set( 'content', this.getImageUrl( this.pageNo ) );
				}

				this._precache();								// Load Previous and next pages

			},

			_loadContent: function( pageNo ) {

				if( pageNo == null || this.contentMap[ pageNo ] != null )
					return;

				var ajaxGet = this.$.AjaxGet;
				ajaxGet.params.pratilipiId = this.pratilipiId;
				ajaxGet.params.chapterNo = pageNo;
				ajaxGet.params.pageNo = pageNo;
				ajaxGet.params.contentType = this.contentType;
				ajaxGet.generateRequest();
			},

			_onResponse: function( event ) {

				var response = event.detail.response;

				// Populate map
				this.contentMap[ response.pageNo ] = response.pageContent;

				// Update content if response page no == this page no
				if( this.pageNo == response.pageNo )
					this.set( 'content', response.pageContent );
			},

			_onError: function( event ) {
				// Show appropriate message
				/* alert( "Sorry! Some exception occured at the server! Try again" ); */
				// Try again in 3 seconds
			},

			writeReview: function() {
				document.querySelector( 'pratilipi-reader-page' ).writeReview();
			},

			shareOnFacebook: function() {
				document.querySelector( 'pratilipi-reader-page' ).shareOnFacebook();
			},

			shareOnTwitter: function() {
				document.querySelector( 'pratilipi-reader-page' ).shareOnTwitter();
			},

			shareOnGplus: function() {
				document.querySelector( 'pratilipi-reader-page' ).shareOnGplus();
			},

		});

	</script>

</dom-module>